#! /bin/bash
# call this as ./ds-upgrade /path/to/d6-database.sql
# before running, turn off memcache settings from settings.php
# and run git submodule update --init
# this script expects drush 7.x-4.x

ROOT=`drush site-alias --component=root @ds7`
echo "syncing ds6 db over ds7 db `date`"
drush @ds7 -y sql-drop
drush @ds7 -y sqlc < $1
echo "running core updates `date`"
mv ${ROOT}/sites/all/modules ${ROOT}/sites/all/movedmodules
echo "update system set status = 0 where name = 'og'"| drush @ds7 sqlc
drush @ds7 -y -v updb
drush @ds7 -y updb
echo "running contrib updates `date`"
mv ${ROOT}/sites/all/movedmodules ${ROOT}/sites/all/modules
drush @ds7 -y updb
drush @ds7 vset -y theme_default bartik
drush @ds7 vset -y admin_theme seven
drush @ds7 vset -y devel_query_display 0
drush @ds7 vset -y error_level 2
drush @ds7 vset -y empty_timezone_message 0
drush @ds7 vset -y pathauto_webform_pathauto_pattern "[webform:node-path]/[webform:sid]"
drush @ds7 vset -y fb_social_appid 160632053975149
drush @ds7 vset -y fb_social_base_url "http://dosomething.zivtech.com"
drush @ds7 vset -y nodequeue_view_per_queue 0
# Change auto increment for webform_submissions table
SID=`drush @ds7 php-eval "print db_query('select max(nid) from node')->fetchField();"`
SID=$(($SID+1000))
echo "ALTER TABLE webform_submissions AUTO_INCREMENT=${SID}" | drush @ds7 sqlc
drush @ds7 -y en media_youtube media_webform emfield redirect devel advanced_help admin_menu_toolbar contextual overlay rdf date date_popup date_views link location nodequeue og auto_nodetitle diff globalredirect logintoboggan pathauto token transliteration panels panels_ipe views views_ui views_data_export image node_reference user_reference field_group content_migrate page_manager location_node location_user features stylizer views_content og_ui og_migrate metatags_quick sms_mobile_commons webform email entity_token webform_entity dosomething_intentions dosomething_login webform_pathauto dosomething_roles dosomething_blocks dosomething_projects webform_devel dosomething_fb_social_plugins geofield
drush @ds7 -y updb
drush @ds7 -y cc all
echo "updating admin password `date`"
drush @ds7 -y upwd admin --password="Waffle050Iron@"
drush @ds7 php-eval "db_query(\"delete from node where vid = 0 OR nid = 0\");"
echo "migrating fields `date`"
drush  @ds7 -y content-migrate-fields field_picture field_description field_news_category field_photo_credit field_intro_text field_intro_text_photo field_act_now_photo field_act_now_items field_learn_photo field_learn_items field_further_description_title field_further_description field_further_description_capti field_further_description_photo field_action_guides field_top_issues field_project_age field_is_content_general field_redirected_action_guide field_query_count field_phone_number_1 field_essay_see_it field_essay_believe_it field_essay_build_it field_contact_information field_dsaward_description field_alumni_project field_dsaward_people_impacted field_dsaward_twitter field_year_awarded field_dsaward_type field_recipient_age field_recipient_birthdate field_city_2 field_alumni_action field_first_name field_select_bootcamp_2009 field_are_you_yac_club_grant field_bc_bio field_bc_photo_upload field_email_1 field_cause_video_description field_cause_video_embed_code  field_cause_video_author field_emotive_list field_recommended_content field_recommended_videos field_club_expected_members field_club_member_1_email  field_club_picture field_club_member_2_email field_club_leader_birthdate field_club_member_3_email field_clubs_meeting_location field_club_member_4_email field_club_address field_club_project_idea_1 field_club_city field_club_project_idea_2 field_club_url field_club_project_idea_other field_club_state field_club_intended_role field_club_zip field_field_club_country field_club_student_leader_first field_club_is_school field_club_leader_last_name field_yacapp_school_type field_club_leader_email field_club_agreement field_school_level field_select_celebrity field_writein_vote field_number_people_in_organiza field_email_0 field_dsaward_nid field_dsaward_recommendation field_dsaward_rec_which field_dsaward_rec_pdf field_dsu_guide_type field_dsu_guideteaser field_dsu_picture field_application_judged field_category_1 field_category_2_0 field_category_10 field_category_4 field_category_3 field_category_5 field_category_7 field_category_8 field_category_6 field_category_9 field_select_easyidea_pic field_easy_idea_120char field_easy_idea_internal_link field_teaser_project field_teaser_project_photo field_project_reference field_editorial_project_view field_grant_type field_project_evolution field_project_highlights field_things_to_do_differently field_number_people_impacted field_grant_impact field_press_clippings field_project_links field_evaluation_of_budget_pred field_budget field_num_people_inspired field_phone_number field_num_people_impacted field_organization_website field_grantsdb_contact_name field_posters_email field_application_deadline_2 field_rolling field_grantsdb_award_name field_award_focus field_type_of_award field_what_you_win field_grantsdb_eligible field_grantsdb_link field_application_deadline field_winners_announced field_problem_type field_problem_urgency field_phone_number_optional field_problem_description field_hours_volunteered_0 field_number_of_people_your_act field_completed_didthis field_did_nid field_featured_items field_project_items field_pageheader field_article field_publication_date field_impressions field_related_campaign field_press_type field_type_of_project field_inspired_by_dosomething field_dosomething_award_winner field_related_action_guide field_fb_like_count field_hours_volunteered field_others_involved field_update_people_involved field_update_people_impacted field_link field_staff_blog_type field_editorial_feature_type field_500_budget field_total_project_budget_0 field_embedded_video field_botb_video field_campaign_pictures field_campaign_video field_fooddrive_photo field_cause_video_url field_celebrity_psa field_celebrity_picture field_club_video field_project_photo field_budget_0 field_recommendation_upload field_press_clippings_andor_add field_recommendation_2 field_recommendation_upload_0 field_dsu_video field_500_budget_0 field_dsu_material field_total_project_budget_if_m field_hp_art_design field_pitch_grant_video field_total_project_budget field_reporter_photo field_scholarship_att_pic field_scholarship_att_video field_staff_blog_video field_staples_design_image field_bumper_sticker_design field_varsity_photo field_varsity_text field_varsity_video field_whitehouse_video
echo "starting og migration `date`"
drush @ds7 -y og-migrate
drush @ds7 -y dis og_migrate
echo "Heyo all done `date`"
echo "Starting on post-upgrade scripts. The site is now usable."
${ROOT}/ds-upgrade-post
