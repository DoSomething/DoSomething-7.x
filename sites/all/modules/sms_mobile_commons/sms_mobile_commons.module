<?php

/**
 * @file
 * Provide mobile commons integration for SMS framework.
 */

/**
 * Implements hook_gateway_info().
 */
function sms_mobile_commons_gateway_info() {
  return array(
    'sms_mobile_commons' => array(
      'name' => 'SMS Mobile Commons',
      'send' => 'sms_mobile_commons_send',
      'receive' => TRUE,
      'configure form' => 'sms_mobile_commons_admin_form',
      'send form' => 'sms_mobile_commons_send_form',
    )
  );
}


/**
 * Implementation of hook_menu().
 */
/*function sms_mobile_commons_menu() {
  $items = array();
   
  $items['admin/structure/sms-mobile-commons'] = array(
    'title' => 'SMS Mobile Commons Configuration',
    'page callback' => 'sms_mobile_commons_admin_page',
    'access arguments' => array('administer sms mobile commons'),
    'type' => MENU_CALLBACK,
  );
  
  return $items;
}
*/
/**
 * Implementation of hook_permission().
 */
/*function sms_mobile_commons_permission() {
  return array(
    'administer sms mobile commons' => array(
      'title' => t('Administer SMS Mobile Commons Configuration'), 
      'description' => t('Allows the user to change the basic authorization 
        configuration for SMS Mobile Commons.'),
    ),
    'send sms mobile commons' => array(
      'title' => t('Send SMS Mobile Commons messages'), 
      'description' => t('Allows the user send mobile commons messages.'),
    ),
  );
}
*/

/**
 * Implementation of hook_admin_form().
 */
function sms_mobile_commons_admin_form($configuration) {
  /*$form = array(
    'email' => array(
      '#weight' => 0,
      '#type' => 'textfield',
      '#title' => t('Mobile Commons Email Account'),
      '#description' => t('Mobile Commons uses an email address as a user name 
        for authentication. Enter this email address here.'),
      '#default_value' => '',
      '#required' => TRUE,
      '#size' => 60,
      '#maxlength' => 255,
    ),
    'password' => array(
      '#weight' => 0,
      '#type' => 'password',
      '#title' => t('Mobile Commons password'),
      '#description' => t('The password associated with the Mobile Commons 
        account.'),
      //No need to pull the password back. We shouldn't show it.
      '#default_value' => '',
      '#required' => TRUE,
      '#size' => 60, 
      '#maxlength' => 255,
    ),
    'url' => array(
      '#weight' => 0,
      '#type' => 'textfield',
      '#title' => t('Mobile Commons custom URL'),
      '#description' => t('Each mobile commons account has a custom URL for 
        accessing information and sending data requests. This usually looks 
        like "http://MYSITE/mcommons.com".'),
      '#default_value' => '',
      '#required' => TRUE,
      '#size' => 60, 
      '#maxlength' => 255,
    ),
    'campaign_id' => array(
      '#weight' => 0,
      '#type' => 'textfield',
      '#title' => t('Campaign ID'),
      '#description' => t('People you plan to send SMS messages to need to be 
        part of a Mobile Commons campaign. Campains have a campaign ID number.'),
      '#default_value' => '',
      '#required' => TRUE,
      '#size' => 10, 
      '#maxlength' => 20,
    ),
    'submit' => array(
      '#weight' => 10,
      '#type' => 'submit',
      '#value' => t('Submit'),
      '#validate' => 'sms_mobile_commons_admin_page_validate',
      '#submit' => 'sms_mobile_commons_admin_page_submit',
    ),
  );
  
  return $form;
  */
  $form = array();
 dpm($configuration); 
  $form['sms_mobile_commons_custom_url'] = array(
    '#type' => 'textfield',
    '#title' => t('Mobile Commons custom URL'),
    '#default_value' => $configuration['sms_mobile_commons_custom_url'],
  );
  $form['sms_mobile_commons_email'] = array(
    '#type' => 'textfield',
    '#title' => t('Email Address'),
    '#default_value' => $configuration['sms_mobile_commons_email'],
  );
  $form['sms_mobile_commons_campaign'] = array(
    '#type' => 'textfield',
    '#title' => t('Campaign ID'),
    '#default_value' => $configuration['sms_mobile_commons_campaign'],
  );
  $form['sms_mobile_commons_password'] = array(
    '#type' => 'password',
    '#title' => t('Password'),
    '#default_value' => $configuration['sms_mobile_commons_password'],
  );
  
  return $form;

}

function sms_mobile_commons_admin_page() {
  return drupal_get_form('sms_mobile_commons_admin_form');
}

function sms_mobile_commons_admin_page_validate($form, &$form_state) {
  dpm($form_state);
}

function  sms_mobile_commons_admin_page_submit($form, &$form_state) {

  dpm($form_state);
}

/**
 * Custom callback for incoming HTTP request.
 */
function sms_mobile_commons_incoming_callback() {  
  $message = $_REQUEST['args'];  
  $keyword = $_REQUEST['keyword'];
  $carrier = $_REQUEST['carrier'];
  $keyword = $_REQUEST['keyword'];
  $sender = $_REQUEST['phone'];

  watchdog('sms_mobile_commons', 'Received message from %sender: %message', array('%sender' => $sender, '%message' => $message));
  sms_incoming($sender, $message, array("carrier" => $carrier, 'keyword' => $keyword));
  $output =
  '<?xml version="1.0" encoding="UTF-8"?>
  <response>
   <reply>
    <text>
     <![CDATA[This is jody\'s response message]]>
    </text>
   </reply>
  </response>';
  print $output;
  exit;
}

/**
 * Implements hook_menu().
 */
function sms_mobile_commons_menu() {
  $items = array();

  $items['sms/mobile-commons/receiver'] = array(
    'title' => 'Mobile Commons SMS receiver',
    'page callback' => 'sms_mobile_commons_incoming_callback',
    'access callback' => 'sms_mobile_commons_incoming_check',
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Add a filter to ensure incoming texts are coming from Mobile Commons' IP.
 */
function sms_mobile_commons_incoming_check() {
  if ($_SERVER['REMOTE_ADDR'] == "64.22.127.76") {
    return TRUE;
  }
  return FALSE;
}
