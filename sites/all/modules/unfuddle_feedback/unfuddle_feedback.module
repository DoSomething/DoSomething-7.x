<?php

/**
 * @file
 * Send new feedback entries as tickets to Unfuddle.
 */

define('UNFUDDLE_FEEDBACK_NORMAL_PRIORITY', 3);

/**
 * Implements hook_feedback_insert().
 */
function unfuddle_feedback_feedback_insert($entry) {
  if (unfuddle_feedback_post_ticket($entry)) {
    drupal_set_message(t('A ticket was created in Unfuddle.'));
  }
  else {
    drupal_set_message(t('Error posting ticket to Unfuddle.'));
  }
}

/**
 * Post a ticket to Unfuddle.
 */
function unfuddle_feedback_post_ticket($entry) {
  global $user;
  include_once(drupal_get_path('module', 'feedback') . '/feedback.admin.inc');
  $description = drupal_html_to_text(drupal_render(feedback_view($entry)), array('a'));

  $subject = t('!name: !message', array('!name' => $user->name, '!message' => truncate_utf8($description, 20, TRUE)));

  $unfuddle = new Unfuddle();
  $fields = array('priority' => UNFUDDLE_FEEDBACK_NORMAL_PRIORITY);
  drupal_alter('unfuddle_feedback_ticket', $subject, $description, $fields);
  return $unfuddle->createTicket($subject, $description, $fields);
}

