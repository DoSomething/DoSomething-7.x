<?php

/**
 * @file
 * Handles subscription API calls based on webform submissions (or other form submissions)
 **/

include_once 'dosomething_subscribe.update_field_values.inc';

/**
 * Implements hook_menu().
 */
function dosomething_subscribe_menu() {
  $items = array();
  $items['admin/reports/dosomething_subscribe'] = array(
    'title' => 'Webform Subscription Report',
    'description' => 'A listing of webform status relative to external services.',
    //@todo: create specific permission for this report?
    'access arguments' => array('access administration pages'),
    'page callback' => 'dosomething_subscribe_page_status_report',
    'file' => 'dosomething_subscribe.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );  
  return $items;
}

/**
 * Implements hook_theme().
 */
function dosomething_subscribe_theme($existing, $type, $theme, $path) {
  return array(
    'dosomething_subscribe_forms_report' => array(
      'variables' => array('forms_listing' => NULL,),
      'template' => 'templates/dosomething-subscribe-forms-report',
    ),
  ); 
}

/**
 * Actions to take when a Webform submission is made.
 *
 * @param array $node
 *   Standard node array created in the webform submission.
 * @param array $submission
 *   Array with submitted webform component values.
 */

function dosomething_subscribe_webform_submission_insert($node, $submission) {

  //dsm($submission);
  $mailchimp = $mobilecommons = FALSE;
  $email = $cell = '';

  // Check if webform node should be subscribing to a Mailchimp Group ID.
  if (isset($node->field_mailchimp_group_id[LANGUAGE_NONE][0]['value'])) {
    
    $mailchimp = $node->field_mailchimp_group_id[LANGUAGE_NONE][0]['value'];
    $mailchimp_merge_vars = array();

    // Check for various places within $submitted that email can be stored:

    // field_webform_email:
    // Used in Program Short Form.
    if (isset($submission->field_webform_email[LANGUAGE_NONE][0]['email'])) {
      $email = $submission->field_webform_email[LANGUAGE_NONE][0]['email'];
    }
    //@todo: collect merge_vars
  }

  // Find cell value in $submisson:

  // field_webform_mobile:
  // Used in Program Short Form.
  if (isset($submission->field_webform_mobile[LANGUAGE_NONE][0]['value'])) {
    $cell = $submission->field_webform_mobile[LANGUAGE_NONE][0]['value'];
  }

  // Store merge_vars.
  if ($mailchimp) {
    if (!empty($cell)) {
      $mailchimp_merge_vars['MMERGE7'] = $cell;
    }
    if ($node->type == 'petition') {
      //@todo: dosomething_general uses $form[action] here. investigate what to store.
      $mailchimp_merge_vars['MMERGE27'] = $node->title;
      if ($submission->uid > 0) {
        $mailchimp_merge_vars['UID'] = $form['#submission']->details['uid'];
      }
    }
  }

  // Check if webform node should be subscribing to a Mobilecommons Opt-in Path.
  if (isset($node->field_mc_optin[LANGUAGE_NONE][0]['value'])) {
    $mobilecommons = $node->field_mc_optin[LANGUAGE_NONE][0]['value'];
  }

  // Call subscribe functions.
  if ($mailchimp && !empty($email)) {
	  //dosomething_subscribe_mailchimp_signup($email, $mailchimp);
    dosomething_general_mailchimp_subscribe($email, $mailchimp, $mailchimp_merge_vars);
  }
  if ($mobilecommons && !empty($cell)) {
	  //dosomething_subscribe_mobilecommons_signup($cell, $mobilecommons);
    dosomething_general_mobile_commons_subscribe($cell, $mobilecommons);
  }
}
