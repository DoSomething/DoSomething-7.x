<?php

/**
 * @file
 * Handles Mobile Commons API calls.
 **/

/**
 * Send a subscribe request to a MobileCommons Opt-in for a given email address.
 *
 * @param string $cell
 *   Cell number to signup.
 * @param string $mobilecommons_optin
 *   Mobile Commons Opt-in to subscribe to.
 */
function dosomething_subscribe_mobilecommons_signup($cell, $mobilecommons_optin) {
  //@todo: Move dosomething_general_mobile_commons_subscribe code here and replace globally.
  return;
}

/**
 * Form callback for mobile signup / referral form.
 */
function dosomething_subscribe_mobilecommons_referral_form($form, &$form_state, $node, $num_betas = 6) {
  $form['alpha_name'] = array(
    '#type' => 'textfield',
    '#required' => TRUE,
    '#attributes' =>array('placeholder' => t('Your name:')),
  );
  $form['alpha_mobile'] = array(
    '#type' => 'textfield',
    '#required' => TRUE,
    '#attributes' =>array('placeholder' => t('Your cell #:')),
  );
  if (isset($node->field_sms_referral_has_email[LANGUAGE_NONE][0]['value']) && $node->field_sms_referral_has_email[LANGUAGE_NONE][0]['value'] == 1) {
    $form['alpha_email'] = array(
      '#type' => 'textfield',
      '#required' => TRUE,
      '#attributes' =>array('placeholder' => t('Your email:')),
    );
  }
  $form['beta_mobiles'] = array(
    '#type' => 'fieldset',
    '#collapsible' => FALSE,
  );
  for ($i = 0; $i < $num_betas; $i++) {
    $form['beta_mobiles']['beta_mobile_' . $i] = array(
      '#type' => 'textfield',
      '#attributes' =>array('placeholder' => t("Friend's cell #:")),
    );   
  }
  $form['nid'] = array(
    '#type' => 'hidden',
    '#value' => $node->nid,
  );
  // @todo: SMS Referral Button Label field
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Invite friends'),
  );
  return $form;
}

/**
 * Form validation callback for mobile signup / referral form.
 */
function dosomething_subscribe_mobilecommons_referral_form_validate($form, &$form_state) {
  // Check for valid email address if email field exists:
  if (isset($form_state['values']['alpha_email']) && !valid_email_address($form_state['values']['alpha_email'])) {
     form_set_error('alpha_email', t('Please provide a valid email address.'));
  }
  // Check for valid alpha cell:
  $alpha_mobile = $form_state['values']['alpha_mobile'];
  $alpha_mobile = preg_replace('#[^0-9]#', '', $alpha_mobile);
  if (!dosomething_general_valid_cell($alpha_mobile)) {
    form_set_error('alpha_mobile', t('Please provide a valid cell number.'));  
  }
  // Check for valid beta cell numbers:
  for ($i = 0; $i < 6; $i++) {
    if (!empty($form_state['values']['beta_mobile_' . $i])) {
      $beta_mobile = $form_state['values']['beta_mobile_' . $i];
      $beta_mobile = preg_replace('#[^0-9]#', '', $beta_mobile);
      if (!dosomething_general_valid_cell($beta_mobile)) {
        form_set_error('beta_mobile_' . $i, t('Please provide a valid cell number.'));  
      }
    }
  }
}

/**
 * Form submit callback for mobile signup / referral form.
 */
function dosomething_subscribe_mobilecommons_referral_form_submit($form, &$form_state) {
  $args = array();
  $alpha_name = $form_state['values']['alpha_name'];
  $args['first_name'] = $alpha_name;
  $alpha_mobile = $form_state['values']['alpha_mobile'];
  $alpha_mobile = preg_replace('#[^0-9]#', '', $alpha_mobile);
  $alpha_email = $form_state['values']['alpha_email'];
  $beta_mobiles = array();
  for ($i = 0; $i < 6; $i++) {
    if (!empty($form_state['values']['beta_mobile_' . $i])) {
      $beta_mobile = $form_state['values']['beta_mobile_' . $i];
      $beta_mobile = preg_replace('#[^0-9]#', '', $beta_mobile);
      $beta_mobiles[] = $beta_mobile;
    }
  }
  // Load node to find relevant subscribe values.
  $node = node_load($form_state['values']['nid']);

  // Mobilecommons Referral signup:
  $alpha_optin = $node->field_mobilecommons_opt_in_alpha[LANGUAGE_NONE][0]['value'];
  $beta_optin =$node->field_mobilecommons_opt_in_beta[LANGUAGE_NONE][0]['value'];
  // @todo: Move this subscribe_with_friends function into this module.
  $response = dosomething_general_mobile_commons_subscribe_with_friends($alpha_mobile, $alpha_optin, $beta_mobiles, $beta_optin, $args);
  watchdog('dosomething_subscribe_mobilecommons', 'Referral signup response = ' . print_r($response, TRUE));

  // If email field is present, check for subscribe values:
  if (isset($node->field_sms_referral_has_email[LANGUAGE_NONE][0]['value']) && $node->field_sms_referral_has_email[LANGUAGE_NONE][0]['value'] == 1) {
    // Mailchimp signup:
    if (isset($node->field_mailchimp_group[LANGUAGE_NONE][0]['value']) && module_exists('dosomething_subscribe_mailchimp')) {
      dosomething_subscribe_mailchimp_signup($alpha_email, $node->field_mailchimp_group[LANGUAGE_NONE][0]['value']);
    }
    // Mandrill dispatch:
    if (isset($node->field_mandrill_key[LANGUAGE_NONE][0]['value']) && module_exists('dosomething_mandrill')) {
      $message['body'] = $alpha_name;
      dosomething_mandrill_dispatch($alpha_email, $node->field_mandrill_key[LANGUAGE_NONE][0]['value'], $message);
    }  
  }
  drupal_set_message('Great job!');
}

/**
 * Updates a node's Mobilecommons Group Id field.
 *
 *  @param int $nid
 *    Node nid to update.
 *
 *  @param string $mobilecommons
 *    Mobilecommons Opt-in value to use.
 */
function _dosomething_subscribe_mobilecommons_update_node_mobilecommons($nid, $mobilecommons) {
  $node = node_load($nid);
  if ($node->nid) {
    $node->field_mc_optin[LANGUAGE_NONE][0]['value'] = $mobilecommons;
    node_save($node);
  }
}

/**
 * Bulk updates the Mobilecommons Opt-in field for a given node type.
 *
 *  @param string $node_type
 *    Node type to bulk update.
 *
 *  @param string $mobilecommons
 *    Mobilecommons Opt-in value to use.
 */
function _dosomething_subscribe_mobilecommons_update_node_type_mobilecommons($node_type, $mobilecommons) {
  $nids = dosomething_general_get_nids_by_type($node_type); 
  foreach ($nids as $nid) {
    _dosomething_subscribe_mobilecommons_update_node_mobilecommons($nid, $mobilecommons);
  }
}
