<?php

/**
 * @file
 * Handles custom services for DoSomething.org
 */

include_once('dosomething_services.features.inc');

/**
 * Implements hook_services_resources_alter().
 *
 * Replace the default user creation callback with ours.
 */
function dosomething_services_services_resources_alter(&$resources, $endpoint) {
  // TODO: we should only do this on a specific endpoint.

  // If email verification is enabled, bypass it with our custom callback.
  if (variable_get('user_email_verification', TRUE)) {
    $resources['user']['actions']['register']['callback'] = '_dosomething_services_user_resource_create';
  }
}

/**
 * Disable the email verification then delegate back to _user_resource_create().
 */
function _dosomething_services_user_resource_create($account) {
  // Avoid variable_set() because it does some cache clearing.
  $GLOBALS['conf']['user_email_verification'] = FALSE;
  _user_resource_create($account);
  $GLOBALS['conf']['user_email_verification'] = TRUE;
}
