<?php
/**
 * @file
 * Code for the DoSomething Mobile Referral Form feature.
 */

include_once 'dosomething_mobile_referral_form.features.inc';

define('MCOMMONS_ALPHAS_CAMPAIGN', 121441);
define('MCOMMONS_BETAS_CAMPAIGN', 121491);

function dosomething_mobile_referral_form_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'form_alter' && isset($implementations['dosomething_mobile_referral_form'])) {
    $group = $implementations['dosomething_mobile_referral_form'];
    unset($implementations['dosomething_mobile_referral_form']);
    $implementations['dosomething_mobile_referral_form'] = $group;
  }
}



function dosomething_mobile_referral_form_form_alter(&$form, &$form_state, $form_id) {
  $node = menu_get_object();

  if (isset($node->type) && $node->type == 'mobile_referral_form') {
    if (!isset($form_state['goto']) && !isset($_SESSION['goto'])) {
      $_SESSION['goto'] = $_SERVER['REQUEST_URI'];
      $form_state['goto'] = $_SERVER['REQUEST_URI'];
    }
    $u = &$form['submitted'];

    $form['actions']['submit']['#attributes'] = array('class' => array('go-button'));
    if (!user_is_logged_in()) {
      $form['actions']['submit']['#ajax'] = array(
        'callback' => 'dosomething_mobile_referral_form_ajax',
      );
    }

    if ($node->type == 'tips_and_tools') {
      $tac = ($u['referall_your_info']['terms_and_conditions']);
      unset($u['referall_your_info']['terms_and_conditions']);
      $form['tac'] = $tac;
    }

    if (!isset($form_state['referenced'])) {
      $u['scholarship_reference']['#webform_component']['value'] = $node->title . ' (' . $node->nid . ')';
      $u['scholarship_reference']['#default_value'] = $node->title . ' (' . $node->nid . ')';
      $form_state['referenced'] = TRUE;
    }

    if (isset($u['referall_your_info']['referral_rules']) && !empty($form_state['build_info']['args'][0]->field_ref_rules_document[LANGUAGE_NONE][0]['uri'])) {
      $file = file_create_url($form_state['build_info']['args'][0]->field_ref_rules_document[LANGUAGE_NONE][0]['uri']);
      $text = t('By clicking submit, you are opting into !rules and our weekly updates.', array(
        '!rules' => l(t('these official rules'), $file, array('attributes' => array('target' => '_blank')))
      ));
      $u['referall_your_info']['referral_rules']['#markup'] = $text;
    }


    $form['#validate'][] = 'dosomething_mobile_referral_form_validate';
  }
}

function redirect_to_shary_stats($form, &$form_state) {
  $nid = $form_state['nid'];
  $form_state['redirect'] = 'share-these-images/' . $nid;
  $_GET['redirect'] = 'redirect-with-message?destination=share-these-images/' . $nid . '&message=' . $_SESSION['social_scholars_messages'];
}

function dosomething_mobile_referral_form_ajax($form, &$form_state) {
  $commands = array();
  $errors = form_get_errors();
  if ($errors) {
    $error_list = '';
    foreach ($errors AS $key => $error) {
      $error_list .= '<li>' . $error . '</li>';
    }

    $fake_error_template = '<div class="messages error">
      <h2 class="element-invisible">Error message</h2>
      <ul>' . $error_list . '</ul></div>
    ';
    $commands[] = ajax_command_before('#page-title', $fake_error_template);
  }
  else {
    // Strip any leading slashes...
    $goto = ($_SESSION['goto'] ? $_SESSION['goto'] : $form_state['goto']);
    if ($goto{0} == '/') {
      $goto = substr($goto, 1);
    }

    if ("/$goto" == request_uri()) {
      $goto = str_replace($_SERVER['HTTP_ORIGIN'], '', $_SERVER['HTTP_REFERER']);
    }

    $commands[] = ajax_command_invoke('#dosomething-login-register-popup-form', 'dsReferSubmit', array($goto, $form_state['input']['submitted']['referall_your_info']['referral_first_name'], $form_state['input']['submitted']['referall_your_info']['referral_phone_number']));
  }

  return array(
    '#type' => 'ajax',
    '#commands' => $commands
  );
}

function dosomething_mobile_referral_form_validate($form, &$form_state) {
  $editing = preg_match('#^\/node\/[0-9]+\/(webform|edit)#i', request_uri());
  if ($editing) {
    return;
  }

  $error = 0;
  $s = $form_state['input']['submitted'];

  $you = $s['referall_your_info'];
  $them = $s['referral_friend_info'];


  if (trim($you['referral_first_name']) == '' && trim($you['field_referral_your_name'][LANGUAGE_NONE][0]['value']) == '') {
    form_set_error('submitted[referall_your_info][referral_first_name]', "You must provide a valid name.");
    $error++;
  }

  if (!dosomething_general_valid_cell($you['referral_phone_number']) && !dosomething_general_valid_cell($you['field_referral_your_cell'][LANGUAGE_NONE][0]['value'])) {
    form_set_error('submitted[referall_your_info][referral_phone_number', "Your phone number must be a valid phone number.");
    $error++;
  }

  if (!dosomething_general_valid_cell($them['referral_friend_cell_1']) && !dosomething_general_valid_cell($them['field_cell_friend1'][LANGUAGE_NONE][0]['value'])) {
    form_set_error('submitted[referral_friend_info][referral_friend_cell_1', "You must provide at least one valid cell phone number.");
    $error++;
  }

  if ($error > 0 && user_is_logged_in()) {
    drupal_goto($_SERVER['HTTP_REFERER']);
  }
}

function dosomething_mobile_referral_form_wild_submit($form, &$form_state) {
  $s = $form_state['input']['submitted'];
  $you = array(
    'name' => $s['field_referral_your_name'][LANGUAGE_NONE][0]['value'],
    'cell' => $s['field_referral_your_cell'][LANGUAGE_NONE][0]['value'],
  );
  $them = array(
    1 => $s['field_cell_friend1'][LANGUAGE_NONE][0]['value'],
    2 => $s['field_cell_friend2'][LANGUAGE_NONE][0]['value'],
    3 => $s['field_cell_friend3'][LANGUAGE_NONE][0]['value'],
    4 => $s['field_cell_friend4'][LANGUAGE_NONE][0]['value'],
    5 => $s['field_cell_friend5'][LANGUAGE_NONE][0]['value'],
    6 => $s['field_cell_friend6'][LANGUAGE_NONE][0]['value'],
  );


  if (user_is_logged_in()) {
    dosomething_api_user_update(array(
      'profile' => array(
        'field_user_mobile' => $you['cell']
      ),
    ));
  }

  $alphas_campaign = MCOMMONS_ALPHAS_CAMPAIGN;
  if ($form_state['alphas']) {
    $alphas_campaign = $form_state['alphas'];
  }

  $betas_campaign = MCOMMONS_BETAS_CAMPAIGN;
  if ($form_state['betas']) {
    $betas_campaign = $form_state['betas'];
  }


  dosomething_general_mobile_commons_subscribe_with_friends($you['cell'], $alphas_campaign, $them, $betas_campaign);

  /*foreach ($them AS $key => $number) {
    if (dosomething_general_valid_cell($number)) {
      dosomething_general_mobile_commons_subscribe($number, $betas_campaign);
    }
  }*/

  // Strip any leading slashes...
  $goto = $form_state['goto'];
  if ($goto{0} == '/') {
    $goto = substr($form_state['goto'], 1);
  }

  $form_state['redirect'] = $goto;
  $_GET['redirect'] = $goto;
}

function dosomething_mobile_referral_form_submit($form, &$form_state) {
  $editing = preg_match('#^\/node\/[0-9]+\/(webform|edit)#i', request_uri());
  if ($editing) {
    return;
  }

  $s = $form_state['input']['submitted'];
  $you = $s['referall_your_info'];
  $them = $s['referral_friend_info'];

  if (intval($you['referral_phone_number'])) {
    $yn = $you['referral_phone_number'];
  }
  else if (intval($you['field_referral_your_cell'][LANGUAGE_NONE][0]['value'])) {
    $yn = $you['field_referral_your_cell'][LANGUAGE_NONE][0]['value'];
  }

  $them = dosomething_general_array_vals_multi($them);

  if (user_is_logged_in()) {
    dosomething_api_user_update(array(
      'profile' => array(
        'field_user_mobile' => $yn
      ),
    ));
  }

  $alphas_campaign = MCOMMONS_ALPHAS_CAMPAIGN;
  if ($form_state['alphas']) {
    $alphas_campaign = $form_state['alphas'];
  }

  $betas_campaign = MCOMMONS_BETAS_CAMPAIGN;
  if ($form_state['betas']) {
    $betas_campaign = $form_state['betas'];
  }


  dosomething_general_mobile_commons_subscribe_with_friends($yn, $alphas_campaign, $them, $betas_campaign);
  #dosomething_general_mobile_commons_subscribe($yn, $alphas_campaign);

  /*foreach ($them AS $key => $number) {
    if (dosomething_general_valid_cell($number)) {
      dosomething_general_mobile_commons_subscribe($number, $betas_campaign);
    }
  }*/

  // Strip any leading slashes...
  $goto = ($_SESSION['goto'] ? $_SESSION['goto'] : $form_state['goto']);
  if ($goto{0} == '/') {
    $goto = substr($goto, 1);
  }

  if ("/$goto" == request_uri()) {
    $goto = str_replace($_SERVER['HTTP_ORIGIN'], '', $_SERVER['HTTP_REFERER']);
  }

  if (isset($_SESSION['goto'])) {
    unset($_SESSION['goto']);
  }

  $ssmsg = '';
  if (empty($_SESSION['social_scholars_messages'])) {
    $ssmsg = t("Thanks for sharing stats with your friends. You've officially entered to win the scholarship. We'll be announcing the winners on Jan. 9th, so hold tight and keep your crossed 'til then! Questions? Email !e.", array('!e' => l('scholarships@dosomething.org', 'mailto:scholarships@dosomething.org')));
  }
  else {
    $ssmsg = $_SESSION['social_scholars_messages'];
    unset($_SESSION['social_scholars_messages']);
  }

  drupal_set_message($ssmsg);
  $form_state['redirect'] = $goto;
  $_GET['redirect'] = $goto;

  if (user_is_logged_in()) {
    drupal_goto($goto);
  }
  #drupal_set_message("Thanks for submitting.  Have a nice day!");
}
