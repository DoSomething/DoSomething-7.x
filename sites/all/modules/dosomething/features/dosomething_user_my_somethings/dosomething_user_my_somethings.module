<?php
/**
 * @file
 * Code for the dosomething_user_my_somethings feature.
 */

include_once('dosomething_user_my_somethings.features.inc');

/**
 * Implements hook_menu_alter().
 */
function dosomething_user_my_somethings_menu_alter(&$items) {
  // User's fullname should be title of page.
  $items['user/%user']['title callback'] = 'dosomething_user_my_somethings_get_full_name';
}

/**
* Implementation of hook_ctools_plugin_directory().
*/
function dosomething_user_my_somethings_ctools_plugin_directory($module, $plugin) {
  if ($module == 'ctools') {
    return 'plugins/' . $plugin;
  }
}

/**
 * Implements hook_webform_submission_insert().
 */
function dosomething_user_my_somethings_webform_submission_insert($node, $submission) {
  cache_clear_all('dosomething_user_my_somethings_' . $submission->uid, 'cache');
}

/**
 * Implements hook_webform_submission_update().
 */
function dosomething_user_my_somethings_webform_submission_update($node, $submission) {
  cache_clear_all('dosomething_user_my_somethings_' . $submission->uid, 'cache');
}

/**
 * Member dashboard block for logged in users.
 */
function dosomething_user_my_somethings_member_block() {
  global $user;
  return array(
    '#attached' => array(
      'js' => array(
        drupal_get_path('module', 'dosomething_user_my_somethings') . '/js/show-member-items.js',
      ),
    ),
    'name' => array(
      '#type' => 'container',
      '#prefix' => '<a href="/user" class="ds-member-name-bar">',
      '#suffix' => '</a>',
      '#attributes' => array(
        'class' => array(
          'dosomething-login-user-name',
        ),
      ),
      'name' => array(
        '#prefix' => '<h2>',
        '#suffix' => '</h2>',
        '#markup' => dosomething_user_my_somethings_get_full_name($user),
      ),
      'role' => array(
        '#prefix' => '<span class="user-role">( ',
        '#suffix' => ' )</span>',
        '#markup' => dosomething_user_my_somethings_user_role(),
      ),
    ),
    'collapsible' => array(
      '#type' => 'container',
      '#attributes' => array(
        'class' => array(
          'dosomething-user-block-collapsible',
        ),
      ),
      'profile' => array(
        '#type' => 'container',
        '#attributes' => array(
          'class' => array(
            'dosomething-login-profile',
          ),
        ),
        'completion' => dosomething_user_my_somethings_profile_completion(),
      ),
      'somethings' => dosomething_user_my_somethings_my_somethings(),
      'clubs' => dosomething_user_my_somethings_clubs(),
    ),
  );
}

/**
 * Markup for how much of the profile is finished.
 */
function dosomething_user_my_somethings_profile_completion() {
  global $user;
  $ratio = 0;
  if (module_exists('dosomething_roles')) {
    $ratio = dosomething_roles_get_user_percentage($user->uid);
  }

  return array(
    'header' => array(
      '#type' => 'container',
      '#attributes' => array(
        'class' => array(
          'profile-header',
        ),
      ),
      '#children' => t('My profile: %percent', array('%percent' => number_format($ratio, 0) . '%')) . l('Complete >>', 'user/' . $user->uid . '/edit/main'),
    ),
    'percentage' => array(
      '#type' => 'container',
      '#attributes' => array(
        'class' => array(
          'dosomething-login-percentage',
        ),
      ),
      'ratio' => array(
        '#type' => 'container',
        '#attributes' => array(
          'class' => array(
            'ratio',
          ),
          'data-ratio' => $ratio,
        ),
        'inner' => array(
          '#type' => 'container',
          '#attributes' => array(
            'class' => array(
              'inner',
            ),
            'style' => 'width: ' . $ratio . '%',
          ),
          '#children' => $ratio,
        ),
      ),
    ),
  );
}

/**
 * Get markup for My Current Somethings.
 */
function dosomething_user_my_somethings_my_somethings() {
  global $user;
  $items = array();

  $items = dosomething_user_my_somethings_my_current_something_links($user->uid);

  return array(
    'title' => array(
      '#prefix' => '<h2 class="my-somethings">',
      '#suffix' => '</h2>',
      'inner' => array(
        '#type' => 'container',
        '#attributes' => array(
          'class' => 'inner',
        ),
        '#children' => t('My Current Somethings'),
      ),
    ),
    'list' => array(
      '#theme' => 'item_list',
      '#items' => $items,
      '#attributes' => array(
        'class' => array(
          'my-somethings',
        ),
      ),
    ),
  );
}

/**
 * Get a list of links for the different types of my somethings.
 *
 * @param $uid
 *  (int) a user id.
 * @return array
 */
function dosomething_user_my_somethings_my_current_something_links($uid) {
  $items = array();
  $somethings_info = array(
    'grant_application' => array(
      'title' => t('Grant Applications'),
      'title_field' => 'field_webform_name',
    ),
    'project_report' => array(
      'title' => t('Project Reports'),
      'title_field' => 'field_project_title',
    ),
  );
  // These my somethings are cached.
  $somethings = dosomething_user_my_somethings_get_my_somethings($uid);
  if (count($somethings)) {
    foreach ($somethings as $type => $something) {
      if (count($something)) {
        $items[$type] = array('data' => $somethings_info[$type]['title'], 'children' => array());
        foreach ($something as $submission) {
          $title = filter_xss($submission->{$somethings_info[$type]['title_field'] . '_value'});
          $items[$type]['children'][] = l($title, 'node/' . $submission->nid . '/submission/' . $submission->sid .'/edit');
        }
      }
    }
  }
  $report_backs = dosomething_user_my_somethings_campaign_report_backs($uid);
  if (count($report_backs)) {
    $items['campaign_report_back'] = array('data' => 'Campaign Sign Ups', 'children' => array());
    foreach($report_backs as $report_back) {
      $items['campaign_report_back']['children'][] = l($report_back->campaign_title, 'node/' . $report_back->report_back_entity_id);
    }
  }
  return $items;
}

/**
 * Get the markup for a list of user's clubs.
 */
function dosomething_user_my_somethings_clubs() {
  global $user;
  $items = array();

  // TODO: It would be nice to cache these memberships.
  $groups = dosomething_user_my_somethings_get_user_group_memberships($user->uid, 'club');
  if (count($groups)) {
    foreach ($groups as $group) {
     $items[] = l(filter_xss($group->title), 'node/' . $group->nid);
    }
  }
  else {
    $items[] = l(t('Start a club'), 'node/add/club');
  }

  return array(
    'title' => array(
      '#prefix' => '<h2 class="notifications">',
      '#suffix' => '</h2>',
      'inner' => array(
        '#type' => 'container',
        '#attributes' => array(
          'class' => 'inner',
        ),
        '#children' => t('My Clubs'),
      ),
    ),
    'list' => array(
      '#theme' => 'item_list',
      '#items' => $items,
      '#attributes' => array(
        'class' => array(
          'notifications',
        ),
      ),
    ),
  );
}

/**
 * Show the user's role.
 */
function dosomething_user_my_somethings_user_role($account = NULL) {
  if (!isset($account)) {
    global $user;
    $account = $user;
  }
  if (dosomething_roles_user_is_staff_member($account)) {
    return t('staff');
  }
  $current_role = dosomething_roles_get_current_role($account->uid);
  $exploded_role = explode(' ', trim($current_role));
  return filter_xss($exploded_role[0]);
}

/**
 * Get a user's full name as a string.
 *
 * @param $account
 *  (object) A standard user object.
 * @return string
 */
function dosomething_user_my_somethings_get_full_name($account) {
  $profile = profile2_load_by_user($account, 'main');
  $names = array();
  $name_fields = array('field_user_first_name', 'field_user_last_name');
  if (is_object($profile)) {
    foreach ($name_fields as $field_name) {
      $field = field_get_items('profile2', $profile, $field_name);
      if (isset($field[0]['safe_value']) && $field[0]['safe_value']) {
        $names[] = $field[0]['safe_value'];
      }
    }
  }
  return empty($names) ? filter_xss($account->name) : implode(' ', $names);
}

/**
 * Get a list of a user's webform submissions.
 *
 * @param $uid
 *  (int) a user id.
 * @param $type
 *  (string) The type of weform submission.
 * @param $title_field
 *  (string) The name of the title field for the webform type.
 * @param $is_draft
 *  (boolean_ Whether or not the submission is a draft.
 * @param $statuses
 *  (array) A list of statuses for filtering on project reports.
 * @return array
 */
function dosomething_user_my_somethings_get_submissions($uid, $type, $title_field, $is_draft = FALSE, $statuses = NULL) {
  $submissions = array();
  if (is_array($statuses)) {
    $available_statuses = array(
      2 => 'project idea',
      3 => 'ongoing project',
      4 => 'completed project',
    );
    $statuses = array_keys(array_intersect($available_statuses, $statuses));
  }
  try {
    $query = db_select('webform_submissions', 'ws');
    $query->innerJoin('node', 'n', 'ws.nid = n.nid');
    $query->innerJoin('field_data_' . $title_field, 't', 'ws.sid = t.entity_id');
    if (is_array($statuses)) {
     $query->innerJoin('field_data_field_project_type', 'pt', 'ws.sid = pt.entity_id');
    }
    $query->fields('ws', array('sid', 'submitted'));
    $query->fields('n', array('nid', 'type'));
    $query->fields('t', array($title_field . '_value'));
    $query->condition('ws.uid', $uid, '=');
    $query->condition('n.type', $type, '=');
    $query->condition('ws.is_draft', (int) $is_draft, '=');
    $query->condition('t.entity_type', 'webform_submission_entity', '=');
    if (is_array($statuses)) {
      $query->condition('pt.entity_type', 'webform_submission_entity', '=');
      $query->condition('pt.field_project_type_value', $statuses, 'IN');
    }
    $results = $query->execute();
    while ($result = $results->fetchObject()) {
      $submissions[$result->sid] = $result;
    }
  }
  catch (Exception $e) {
    return NULL;
  }
  return $submissions;
}

/**
 * Get a list of group memberships for a user based on node type.
 *  of group.  This assumes that the group is a node and the membership
 *  is for a user.
 */
function dosomething_user_my_somethings_get_user_group_memberships($uid, $node_type) {
  if (!module_exists('og')) {
    continue;
  }
  // There doesn't seem to be an og function to do exactly what we want
  // so we have our own.
  $groups = array();
  $query = db_select('og_membership', 'm');
  $query->innerJoin('og', 'o', 'o.gid = m.gid');
  $query->innerJoin('node', 'n', 'o.etid = n.nid');
  $query->fields('o', array('gid', 'etid'));
  $query->fields('n', array('nid', 'title'));
  $query->condition('o.entity_type', 'node', '=');
  $query->condition('m.etid', $uid, '=');
  $query->condition('n.type', $node_type, '=');
  $query->condition('o.state', OG_STATE_ACTIVE);
  $results = $query->execute();
  while ($result = $results->fetchObject()) {
    $groups[$result->etid] = $result;
  }
  return $groups;
}

/**
 * Build list of current somethings. These include:
 *   Campaign sign-ups for which the user has not submitted a report-back (links to campaign report-back page)
 *   Incomplete grant applications (link to grant application form)
 *   Projects where status = Idea or Ongoing. (links to project update form)
 *
 * @param $uid
 *  (int) a user id.
 * @return array
 */
function dosomething_user_my_somethings_get_my_somethings($uid) {
  // TODO: We don't have campaigns modelled here yet, because
  // the model is changing.
  $somethings_info = array(
    'grant_application' => array(
      'title_field' => 'field_webform_name',
      'draft' => TRUE,
      'statuses' => NULL,
    ),
    'project_report' => array(
      'title_field' => 'field_project_title',
      'draft' => FALSE,
      'statuses' => array('ongoing project', 'project idea'),
    ),
  );

  $cid = 'dosomething_user_my_somethings_' . $uid;
  //$cache = cache_get($cid);
  if (!is_object($cache)) {
    foreach ($somethings_info as $type => $info) {
      $somethings[$type] = dosomething_user_my_somethings_get_submissions($uid, $type, $info['title_field'], $info['draft'], $info['statuses']);
    }
    cache_set($cid, $somethings);
  }
  else {
    $somethings = $cache->data;
  }
  return $somethings;
}

/**
 * Implements hook_theme().
 */
function dosomething_user_my_somethings_theme() {
  return array(
    'dosomething_profile_info' => array(
      'template' => 'ds-profile-info',
      'variables' => array(
        'profile' => new stdClass,
        'account' => new stdClass,
        'dosomething_friends' => '',
      ),
    )
  );
}

/**
 * Get a list of campain report backs that a user has not submitted
 * for that user's campaign groups.
 */
function dosomething_user_my_somethings_campaign_report_backs($uid) {
  $gids = array();
  $report_backs = array();
  $report_backs_entity_ids = array();
  $user_submissions = array();
  $incomplete_report_backs = array();

  if ($groups = dosomething_user_my_somethings_get_user_group_memberships($uid, 'campaign')) {
    foreach ($groups as $group) {
      $gids[] = $group->gid;
    }

    // Check that a campaign report back exists for each user's campaign.
    // Get campaign title and entity_id of that campaign's report back.
    $query = db_select('field_data_field_report_back_reference', 'f');
    $query->innerJoin('og', 'o', 'f.field_report_back_reference_nid = o.etid');
    $query->innerJoin('node', 'n', 'f.entity_id = n.nid');
    $query->addField('f', 'entity_id', 'report_back_entity_id');
    $query->addField('o', 'etid', 'campaign_entity_id');
    $query->addField('o', 'label', 'campaign_title');
    $query->condition('n.type', 'campaign_report_back', '=');
    $query->condition('o.gid', $gids, 'IN');
    $results = $query->execute();
    while ($result = $results->fetchObject()) {
      $report_backs[] = $result;
      $report_backs_entity_ids[] = $result->report_back_entity_id;
    }

    // From these existing campaign report backs, get the user's submissions.
    $db_query = db_select('webform_submissions', 'w');
    $db_query->fields('w', array('nid'));
    $db_query->condition('w.uid', $uid, '=');
    $db_query->condition('nid', $report_backs_entity_ids, 'IN');
    $results = $db_query->execute();
    while ($result = $results->fetchObject()) {
      $user_submissions[] = $result->nid;
    }

    // Check if user has a submission for each report back,
    // if not return that info.
    foreach($report_backs as $report_back) {
      if (!in_array($report_back->report_back_entity_id, $user_submissions)) {
        $incomplete_report_backs[$report_back->report_back_entity_id] = $report_back;
      }
    }
  }
  return $incomplete_report_backs;
}

/**
 * Implements hook_preprocess_dosomething_profile_info().
 */
function dosomething_user_my_somethings_preprocess_dosomething_profile_info(&$variables) {
  // Extract the user and profile objects.
  $account = $variables['account'];
  $profile = entity_metadata_wrapper('profile2', $variables['profile']);

  $variables['member_status'] = dosomething_user_my_somethings_user_role($account);
  $variables['member_since'] = date('m/Y', $account->created);

  // Build the hometown value out of city and state.
  $address = $profile->field_user_address->value();
  $hometown = array(
    $address['locality'],
    $address['administrative_area'],
  );
  $variables['hometown'] = implode(', ', array_filter($hometown));
  if (empty($variables['hometown'])) {
    $variables['hometown'] = '-';
  }
}

/**
 * get camapaign images
 */
function dosomething_user_my_somethings_campaign_images($uid) {
  //$campaign = dosomething_user_my_somethings_my_current_something_links($uid);
  $campaigns = dosomething_user_my_somethings_campaign_report_backs($uid);
  foreach ($campaigns as $campaign) {
    $campaign_entities[] = $campaign->campaign_entity_id;
  }
  $query = db_select('field_data_field_campaign_main_image', 'i');
  $query->innerJoin('file_managed', 'f', 'f.fid = i.field_campaign_main_image_fid');
  $query->addField('f', 'uri');
  $query->addField('i', 'field_campaign_main_image_fid');
  $query->addField('i', 'entity_id');
  $query->condition('i.entity_id', $campaign_entities, 'IN');
  $results = $query->execute();
  while ($result = $results->fetchObject()) {
    $campaign_images[$result->uri]= $result->entity_id;
  }
  foreach ($campaigns as $campaign) {
    if ($image = array_search($campaign->campaign_entity_id, $campaign_images)) {
      $campaigns[$campaign->report_back_entity_id]->image = $image;
    }
    else {
      // TODO: needs default images.
      $campaigns[$campaign->report_back_entity_id]->image = 'campaign-default'; //Need to work this out.
    }
  }

  return $campaigns;

}


// TODO finish this. it blows up if you have no drafts.
// also needs a default image.
function dosomething_user_my_somethings_get_images($uid) {
  $grant_nids = array();
  $somethings = dosomething_user_my_somethings_get_my_somethings($uid); // gives project reports and grant apps
  dpm($somethings);
  foreach ($somethings as $type => $data) {
    if ($type == 'grant_application') {
      foreach($data as $grant_app) {
        $sids[] = $grant_app->sid;
      }
      $query = db_select('field_data_field_webform_grant_ref', 'r');
      $query->innerJoin('field_data_field_picture', 'p', 'p.entity_id = r.field_webform_grant_ref_nid');
      $query->innerJoin('file_managed', 'f', 'f.fid = p.field_picture_fid');
      $query->addField('f', 'uri');
      $query->addField('r', 'entity_id');
      $query->condition('r.entity_id', $sids, 'IN');
      $results = $query->execute();
      while ($result = $results->fetchObject()) {
        $grant_images[$result->uri] = $result->entity_id;
      }
      foreach ($data as $grant_app) {
        if ($image = array_search($grant_app->sid, $grant_images)) {
          $somethings[$type][$grant_app->sid]->image = $image;
        }
        else {
          $somethings[$type][$grant_app->sid]->image = 'grant_default'; //Need to work this out.
        }
      }
    }

    elseif ($type == 'project_report') {
      // TODO
      // needs image from project
      // also needs a default image
    }
  }
}

function dosomething_user_my_somethings_current_somethings_links($uid) {
  $campaigns = dosomething_user_my_somethings_campaign_images($uid);
  //dpm($campaigns);
  $somethings = dosomething_user_my_somethings_get_images($uid);
  // TODO: combine

}
