<?php

/**
 * Callback function to supply a list of content types.
 */
function dosomething_user_my_somethings_ds_current_somethings_ctools_content_types() {
  return array(
    'single' => TRUE,
    'title' => t('DS User Current Somethings'),
    'icon' => 'icon_user.png',
    'description' => t('Current Somethings on user profiled'),
    'required context' => new ctools_context_required(t('User'), 'user'),
    'category' => t('User'),
    'defaults' => '',
  );
}

/**
 * Output function for the 'DS User info' content type.
 */
function dosomething_user_my_somethings_ds_current_somethings_content_type_render($subtype, $conf, $panel_args, $context) {
  $uid = $context->data->uid;

  $report_backs = dosomething_user_my_somethings_campaign_report_backs($uid);
  $action_guides = dosomething_user_my_somethings_action_guides($uid);
  $projects = dosomething_user_my_somethings_projects($uid);
  
  
  
  dpm($report_backs);
  dpm($action_guides);
  dpm($projects);

  $block = new stdClass();
  
  $block->content = 'test';
  
  return $block;
}

/**
 * Return an array of campaign report backs 
 * that a user has not completed for campaigns they are part of.
 */
function dosomething_user_my_somethings_campaign_report_backs($uid) {
  $user = node_load($uid);
  $groups = og_get_entity_groups('user', $user);
  foreach ($groups as $gid) {
    // Get campaign title and entity_id of its campaign report back.
    $report_back = db_query("SELECT f.entity_id, o.label, n.type from {field_data_field_report_back_reference} f 
                             INNER JOIN {og} o ON f.field_report_back_reference_nid = o.etid 
                             INNER JOIN {node} n ON f.entity_id = n.nid
                             WHERE o.gid = :gid AND n.type = 'campaign_report_back'", array(':gid' => $gid))->fetchObject(); 
    // If campaign report back webform exist, check for user submission.
    if (isset($report_back->entity_id)) {
      $submission = db_query("SELECT sid FROM {webform_submissions} 
                              WHERE nid = :nid AND uid = :uid", 
                              array(':nid' => $report_back->entity_id, ':uid' => $uid))->fetchField();
      // User has not submitted a report back.
      if (!$submission) {
        $report_backs[] = array(
          'title' => $report_back->label,
          'link' => l('Complete this', 'node/' . $report_back->entity_id),
        );
      }
    }
  }
  return $report_backs;
}

function dosomething_user_my_somethings_action_guides($uid) {
  $data = db_query("SELECT w.nid, n.title FROM {webform_submissions} w 
                      INNER JOIN {node} n ON w.nid = n.nid
                      WHERE w.uid = :uid AND bundle = 'action_guide' AND is_draft = 1", array(':uid' => $uid))->fetchAll(); 
  foreach($data as $guide) {
    $guides[] = array(
       'title' => $guide->title,
       'link' => l('Complete this', 'node/' . $guide->nid),
    );
  }  
  return $guides;
}

/**
 * Return a user's projects where status is idea or ongoing
 */
function dosomething_user_my_somethings_projects($uid) {
  $data = db_query("SELECT w.sid, t.field_project_title_value FROM {webform_submissions} w 
                      INNER JOIN {field_data_field_project_status} s ON w.sid = s.entity_id
                      INNER JOIN {field_data_field_project_title} t ON w.sid = t.entity_id
                      WHERE w.uid = :uid AND w.bundle = 'project_report' AND w.nid = '704011' AND (s.field_project_status_value = 0 OR s.field_project_status_value = 1)", array(':uid' => $uid))->fetchAll(); 
  
   $projects = array();
   foreach ($data as $project) {
     $projects[] = array(
       'title' => $project->field_project_title_value,
       'link' => l('Complete this', 'node/704011/submission/' . $project->sid),
    );
   }  
   return $projects;
}  
