<?php

define('SHARE_A_STAT_NUM_CELLS', 5);
define('SHARE_A_STAT_USER_TXT', 117381);
define('SHARE_A_STAT_FRIEND_TXT', 117391);

/**
* Implementation of hook_ctools_plugin_directory().
*/
function dosomething_social_scholars_ctools_plugin_directory($module, $plugin) {
  if ($module == 'ctools') {
    return 'plugins/' . $plugin;
  }
}

function dosomething_social_scholars_form_alter(&$form, &$form_state, $form_id)
{
  if ($form_id == 'webform_client_form_723646')
  { 
    $node = menu_get_object();
    if ($node->nid == 29308)
    {
      unset($form['submitted']['disclaimer']);
      $form['submitted']['disclaimer'] = $form['submitted']['your_information']['tac'];
      unset($form['submitted']['your_information']['tac']);
    }

    $form['actions']['submit']['#value'] = 'SEND';
    $form['actions']['submit']['#attributes'] = array('class' => array('go-button'));

    $form['#validate'][] = 'dosomething_share_a_stat_share_with_friends_validate';
    $form['#submit'][] = 'dosomething_share_a_stat_share_with_friends_submit';
  }
}

function dosomething_social_scholars_page_alter($page){
    $node = menu_get_object();
    #echo '<pre>', print_r($node), '</pre>';
}

function dosomething_social_scholars_panels_pre_render($display)
{
  if ($display->layout == 'flexible:social_scholars')
  {
      if (!user_is_logged_in())
      {
        drupal_add_js(drupal_get_path('module', 'dosomething_social_scholars') . '/dosomething_share_a_stat.js');
      }

      drupal_add_js(drupal_get_path('module', 'dosomething_social_scholars') . '/dosomething_social_stat.js');
      drupal_add_css(drupal_get_path('module', 'dosomething_social_scholars') . '/dosomething_share_a_stat.css', array(
        'group' => CSS_THEME,
        'weight' => 10
      ));
  }
}

function dosomething_share_a_stat_share_with_friends_validate($form, &$form_state)
{
  $node = menu_get_object();

  $form_state['validated'] = false;
  $error = 0;
  if ($form_state['input']['submitted']['your_information']['field_social_scholars_first_name'][LANGUAGE_NONE][0]['value'] == '')
  {
    form_set_error('submitted[your_information][field_social_scholars_first_name][und][0][value]', 'You must provide a name.');
    $error++;
  }
  if (!dosomething_general_valid_cell($form_state['input']['submitted']['your_information']['field_social_scholars_cell'][LANGUAGE_NONE][0]['value']))
  {
    form_set_error('submitted[your_information][field_social_scholars_cell][und][0][value]', 'You must provide a valid cell phone number.');
    $error++;
  }

  if (!dosomething_general_valid_cell($form_state['input']['submitted']['friends_information']['field_social_scholars_friend_1'][LANGUAGE_NONE][0]['value']))
  {
    form_set_error('submitted[friends_information][field_social_scholars_friend_1][und][0][value]', 'You must provide at least one valid cell phone number.');
    $error++;
  }

  if (!$error)
    $form_state['validated'] = true;

  $form_state['goto'] = $_SERVER['HTTP_REFERER'];
}

function dosomething_share_a_stat_share_with_friends_submit(&$form, &$form_state)
{
  $message ='Thanks for sharing important stats with your friends.  Together, we can spread awareness and put an end to animal cruelty.';
  $message .= '<script type="text/javascript">
    jQuery(document).ready(function() {
        jQuery.fn.dsShareStatSubmit("/", "' . $form_state['input']['submitted']['your_information']['field_social_scholars_first_name'][LANGUAGE_NONE][0]['value'] . '", "' . $form_state['input']['submitted']['your_information']['field_social_scholars_cell'][LANGUAGE_NONE][0]['value'] . '");
    });
  </script>';
  drupal_set_message($message);

/*  if (isset($form_state['input']['submitted']['your_information']['field_social_scholars_cell'][LANGUAGE_NONE][0]['value']) && $form_state['input']['submitted']['your_information']['field_social_scholars_cell'][LANGUAGE_NONE][0]['value'] != '') {
    global $user;
    $profile = profile2_load_by_user($user, 'main');
    $profile->field_user_mobile[LANGUAGE_NONE][0]['value'] = $form_state['input']['submitted']['your_information']['field_social_scholars_cell'][LANGUAGE_NONE][0]['value'];
    $profile->save();
  }*/

  $q = new EntityFieldQuery;
  $result = $q
    ->entityCondition('entity_type', 'webform_submission_entity')
    ->propertyCondition('nid', $node->nid)
    ->propertyOrderBy('submitted', 'DESC')
    ->fieldCondition('field_social_scholars_cell', 'value', $form_state['input']['submitted']['your_information']['field_social_scholars_cell'][LANGUAGE_NONE][0]['value'], '=')
    ->execute();
  if (!empty($result))
  {
    return;
  }

  if (dosomething_general_valid_cell($form_state['input']['submitted']['your_information']['field_social_scholars_cell'][LANGUAGE_NONE][0]['value']))
  {
    dosomething_general_mobile_commons_subscribe($form_state['input']['submitted']['your_information']['field_social_scholars_cell'][LANGUAGE_NONE][0]['value'], SHARE_A_STAT_USER_TXT);
  }

  foreach ($form_state['input']['submitted']['friends_information'] AS $key => $number)
  {
    if (dosomething_general_valid_cell($number[LANGUAGE_NONE][0]['value']))
    {

       dosomething_general_mobile_commons_subscribe($number[LANGUAGE_NONE][0]['value'], SHARE_A_STAT_FRIEND_TXT);
    }
  }
}