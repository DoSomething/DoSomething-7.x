<?php
/**
 * @file
 * Code for the Dosomething - Campaign Report Back feature.
 */

include_once('dosomething_campaign_report_back.features.inc');

/**
 * Implements hook_form_alter().
 */
function dosomething_campaign_report_back_form_alter(&$form, &$form_state, $form_id) {
  // Make sure we're dealing with the right form.
  if (strpos($form_id, 'webform_client_form_') === 0 && isset($form['#node']) && $form['#node']->type == 'campaign_report_back') {
    $magic_fields_field = 'field_report_back_magic_fields';
    $node = $form['#node'];
    // Make sure no one did something stupid like deleting our field.
    module_load_include('inc', 'field', 'field.attach');
    $enabled_fields = array();
    if (isset($node->{$magic_fields_field})) {
      // Get the allowed values.
      if ($items = field_get_items('node', $node, $magic_fields_field)) {
        foreach ($items as $item) {
          foreach ($item as $field) {
            $enabled_fields[] = $field;
          }
        }
      }
    }
    // Get the field info so that we can get the list of values to work with.
    $field_info = field_info_field($magic_fields_field);
    foreach ($field_info['settings']['allowed_values'] as $field_name => $label) {
      if (isset($form['submitted']['webform_entity_form'][$field_name]) && !in_array($field_name, $enabled_fields)) {
        $form['submitted']['webform_entity_form'][$field_name]['#access'] = FALSE;
      }
    }

    global $user;
    $profile = profile2_load_by_user($user, 'main');
    $mobile = field_get_items('profile2', $profile, 'field_user_mobile');
    if (isset($mobile[0]['value']) && $form['submitted']['webform_entity_form']['field_webform_mobile'][LANGUAGE_NONE][0]['value']['#default_value'] == '') {
      $form['submitted']['webform_entity_form']['field_webform_mobile'][LANGUAGE_NONE][0]['value']['#default_value'] = $mobile[0]['value'];
    }
    if ($user->uid != 0 && $form['submitted']['webform_entity_form']['field_webform_email'][LANGUAGE_NONE][0]['email']['#default_value'] == '') {
      $form['submitted']['webform_entity_form']['field_webform_email'][LANGUAGE_NONE][0]['email']['#default_value'] = $user->mail;
    }
    $ref = field_get_items('node', $node, 'field_report_back_reference');
    if (isset($ref[0]['nid'])) {
      if (is_object($group = og_get_group('node', $ref[0]['nid']))) {
        $form['submitted']['webform_entity_form']['group_audience'][LANGUAGE_NONE]['#default_value'] = array($group->gid);
        $form['submitted']['webform_entity_form']['group_audience'][LANGUAGE_NONE]['#access'] = FALSE;
      }
    }
    $form['#submit'][] = 'dosomething_campaign_report_back_campaign_signup_form_submit';
  }
}

/**
 * Campaign Sign Up form submission callback.
 */
function dosomething_campaign_report_back_campaign_signup_form_submit(&$form, &$form_state) {
  global $user;
  if (isset($form_state['values']['field_webform_mobile'][LANGUAGE_NONE][0]['value']) && $form_state['values']['field_webform_mobile'][LANGUAGE_NONE][0]['value'] != '') {
    $profile = profile2_load_by_user($user, 'main');
    $profile->field_user_mobile[LANGUAGE_NONE][0]['value'] = $form_state['values']['field_webform_mobile'][LANGUAGE_NONE][0]['value'];
    $profile->save();
  }
  if (isset($form_state['values']['field_webform_email'][LANGUAGE_NONE][0]['email']) && $form_state['values']['field_webform_email'][LANGUAGE_NONE][0]['email'] != '') {
    $user->mail = $form_state['values']['field_webform_email'][LANGUAGE_NONE][0]['email'];
    user_save($user);
  }
}


/**
 * Implementation of hook_module_implements_alter().
 *
 * We can only disable our elements if we come after webform_entity, make
 * sure we do.
 */
function dosomething_campaign_report_back_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'form_alter' && isset($implementations['dosomething_campaign_report_back'])) {
    $group = $implementations['dosomething_campaign_report_back'];
    unset($implementations['dosomething_campaign_report_back']);
    $implementations['dosomething_campaign_report_back'] = $group;

  }
}
