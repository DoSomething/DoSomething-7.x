<?php
/**
 * @file
 * Code for the dosomething_awesome_things_action_update feature.
 */

include_once('dosomething_awesome_things_action_update.features.inc');
define('DS_ISSUES_VOCAB', '5');

/**
 * Implements hook_form_alter().
 */
function dosomething_awesome_things_action_update_form_views_exposed_form_alter(&$form, &$form_state, $form_id) {
  if ($form['#id'] == 'views-exposed-form-action-updates-panel-pane-1') {
    // Get top level list of Issues.
    $vocab = taxonomy_get_tree(DS_ISSUES_VOCAB, 0, 1);
    foreach ($vocab as $tax) {
      $options[$tax->tid] = $tax->name;
    }
    $form['taxonomy_vocabulary_5_tid']['#options'] = array('All' => t('- Any -')) + $options;
    $form['taxonomy_vocabulary_5_tid']['#multiple'] = FALSE;
    $form['taxonomy_vocabulary_5_tid']['#size'] = NULL;
    // Get list of recent years.
    foreach (range("2008", date("Y")) as $year) {
      $years[$year] = $year;
    }
    unset($form['submitted']);
    $form['submitted'] = array(
      '#type' => 'select',
      '#size' => NUll,
      '#options'=> array('' => t('- Any -')) + $years,
    );
  }
  if ($form['#id'] == 'views-exposed-form-action-updates-default') {
    $form['#action'] = '/awesome-things/action-updates';
  }
}

/**
 * Callback for master display of member_wall view.
 * Takes query string created by panel_pane_1 display and assigns them to args.
 * This is done to change the output of the member wall view exposed form.
 */
function dosomething_awesome_things_action_update_action_update_view_content() {
  $view = views_get_view('action_updates');
  $filters = $view->display['default']->display_options['arguments'];
  $args = array();
  foreach ($filters as $filter) {
    // Default to all.
    $arg = 'all';
    // If query string exists, override.
    if (isset($_GET[$filter['id']]) && $_GET[$filter['id']] != 'All') {
      // Return all children of term instead of just term.
      if ($filter['id'] == 'taxonomy_vocabulary_5_tid') {
        $kids = taxonomy_get_children($_GET[$filter['id']], DS_ISSUES_VOCAB);
        foreach ($kids as $kid) {
          $terms[] = $kid->tid;
        }
        $terms[] = $_GET[$filter['id']];
        // Deliver in term argument fashion.
        $arg = implode('+', $terms);
      }
      else {
        $arg = $_GET[$filter['id']];
      }
    }
    $args[] = $arg;
  }

  return $view->execute_display('default', $args);
}
