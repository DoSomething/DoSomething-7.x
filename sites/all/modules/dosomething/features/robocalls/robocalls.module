<?php
/**
 * @file
 * Code for the DoSomething Robocalls feature.
 */

include_once 'robocalls.features.inc';
define('MCOMMONS_ROBOCALL_CAMPAIGN', 18301);
define('ROBOCALLS_WEBFORM_NID', 723327);
define('MAX_CALLS_PER_DAY', 1);

function robocalls_panels_pre_render($display) {
  if ($display->layout == 'flexible:cause_calls' || $display->layout == 'flexible:cause_calls_landing') {
    drupal_add_css(drupal_get_path('module', 'robocalls') . '/css/dosomething_robocall.css', array(
        'group' => CSS_THEME,
        'weight' => 10
    ));

    drupal_add_js(drupal_get_path('module', 'robocalls') . '/js/robocalls.js', array(
        'weight' => -100,
        'cache' => FALSE
    ));
  }
}

// To-do: Add to dosomething_sms module mobile_commons_sms (submit it to drupal.org)
function robocalls_mcommons_call($mobile, $name = '', $opt_in_path) {
  $api_opt_in_path_url = 'https://dosomething.mcommons.com/profiles/join';

  // Send the post data.
  $options = array(
    'headers' => array(
      'Content-type' => 'application/x-www-form-urlencoded',
      'Accept' => 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
    ),
    'method' => 'POST',
    'data' => "person[phone]=$mobile&person[user_s_name]=" . urlencode($name) . "&mconnect=$opt_in_path",
  );

  drupal_http_request($api_opt_in_path_url, $options);
}

function robocalls_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'form_alter' && isset($implementations['robocalls'])) {
    $group = $implementations['robocalls'];
    unset($implementations['robocalls']);
    $implementations['robocalls'] = $group;
  }
}

function robocalls_fb_social_event_subscribe() {
  $f = 'if (typeof Drupal.behaviors.fb !== "undefined") {
    Drupal.behaviors.fb.fb_init = true;
  }';
  return $f;
}

function robocalls_form_alter(&$form, $form_state, $form_id) {
  global $term_info, $flags;
  if (strpos($form_id, 'webform_client_form_') === 0 && isset($form_state['webform_entity']) && $form_state['webform_entity']['bundle'] == 'robo_calls') {
    $termid = arg(2);
    $term = taxonomy_term_load($termid);
    $u = &$form['submitted']/*['celeb_call_information']*/;

    if (!empty($term)) {
       $term_info = array();
       $term_info['parent'] = key(taxonomy_get_parents($term->tid));
       $term_info['tid'] = $term->tid;
       $term_info['name'] = $term->name;
       $term_info['desc'] = $term->description;
       $term_info['image'] = $term->field_celeb_photo[LANGUAGE_NONE][0]['uri'];
       $term_info['flag'] = $term->field_short_name[LANGUAGE_NONE][0]['value'];

      $form['call_limit'] = array(
        '#type' => 'hidden',
        '#value' => $term->field_call_limit[LANGUAGE_NONE][0]['value']
      );

      $form['mobile_commons_id'] = array(
        '#type' => 'hidden', 
        '#value' => $term->field_call_mobile_commons_id[LANGUAGE_NONE][0]['value']
      );
	}

    $form['extras'] = array(
       '#type' => 'container',
       '#attributes' => array(
          'class' => array('robocalls-extras-container')
       ));

    $form['extras']['fb_container'] = array(
       '#type' => 'container',
       '#attributes' => array(
          'class' => array('robocalls-fb-container')
       ),
       '#weight' => 6,
  	);

    $form['extras']['fb_container']['fb_button'] = array(
      '#type' => 'container',
      '#attributes' => array(
        'class' => array('robocalls-fb-button-container')
      ),
      '#weight' => 2,
    );

    $form['extras']['fb_container']['fb_button']['connect_with_facebook'] = array(
      '#markup' => '<p class="robocalls-fb-find-friends-birthdays"><img src="/' . drupal_get_path('module', 'robocalls') . '/images/facebook-share-button.gif" alt="Share on Facebook" /></p>',
      '#weight' => 2
    );

    $form['actions']['submit']['#attributes']['class'] = array('go-button robocalls-submit');
    $form['extras']['fb_container']['submit_button'] = $form['actions']['submit'];
    $form['actions']['submit']['#access'] = FALSE;

    /*$form['extras']['well_send_to'] = array(
        '#type' => 'markup',
        '#markup' => '<div id="well-send-to">We\'ll send a birthday message to:<ul></ul></div>',
        '#weight' => 6
	);

    $form['or_send_now'] = array(
        '#type' => 'checkbox',
        '#title' => t("Or send NOW!"),
        '#weight' => 5,
        '#attributes' => array(
           'class' => array('robocalls-send-message-now')
        )
    );*/

    if (isset($term->tid) && !empty($term->tid)) {
        $form['preview'] = array(
           '#type' => 'container',
           '#attributes' => array(
              'class' => array('robocalls-preview-button-container')
		));

        $form['preview']['preview_now'] = array(
           '#markup' => '<p><h3>Preview Your Call!</h3></p>'
        );

        $form['preview']['audio'] = array(
           '#markup' => '<audio id="robocalls-preview-audio" src="/files' . str_replace(array(DRUPAL_ROOT . '/files', 'var/www/nfs'), '', drupal_realpath($term->field_celeb_call[LANGUAGE_NONE][0]['uri'])) . '"></audio>'
        );

        $form['preview']['button'] = array(
           '#markup' => l('<img src="/' . drupal_get_path('module', 'robocalls') . '/images/robocall-preview.png" alt="" />', str_replace(array(DRUPAL_ROOT . '/', 'var/www/nfs'), array('', 'files'), drupal_realpath($term->field_celeb_call[LANGUAGE_NONE][0]['uri'])), array('html' => TRUE, 'attributes' => array('id' => 'robocalls_preview_link')))
        );
    }

/*
    $form['ah'] = array(
      '#markup' => '    <div id="TDFriendSelector">
      <div class="TDFriendSelector_dialog">
        <a href="#" id="TDFriendSelector_buttonClose">x</a>
        <div class="TDFriendSelector_form">
          <div class="TDFriendSelector_header">
            <p>Select a Friend to Post on their Wall</p>
          </div>
          <div class="TDFriendSelector_content">
            <p>Click "OK" when you\'ve chosen someone.  We\'ll pop up a message box for them.</p>
            <div class="TDFriendSelector_searchContainer TDFriendSelector_clearfix">
              <div class="TDFriendSelector_selectedCountContainer"><span class="TDFriendSelector_selectedCount">0</span> / <span class="TDFriendSelector_selectedCountMax">0</span> friends selected</div>
              <input type="text" placeholder="Search friends" id="TDFriendSelector_searchField" />
            </div>
            <div class="TDFriendSelector_friendsContainer"></div>
          </div>
          <div class="TDFriendSelector_footer TDFriendSelector_clearfix">
            <a href="#" id="TDFriendSelector_pagePrev" class="TDFriendSelector_disabled">Previous</a>
            <a href="#" id="TDFriendSelector_pageNext">Next</a>
            <div class="TDFriendSelector_pageNumberContainer">
              Page <span id="TDFriendSelector_pageNumber">1</span> / <span id="TDFriendSelector_pageNumberTotal">1</span>
            </div>
            <a href="#" id="TDFriendSelector_buttonOK">OK</a>
          </div>
        </div>
      </div>
    </div>');*/

#    $form['actions']['submit']['#value'] = 'SEND IT!';
 #   $form['actions']['submit']['#attributes'] = array('class' => array('go-button'));
    if (!user_is_logged_in()) {
       $form['extras']['fb_container']['submit_button']['#ajax'] = array(
         'callback' => 'robocalls_ajax_call',
       );
    }

    /**
      * If a user is logged in, pre-populate:
      * - Cell #
      * - First name
      */

    if (isset($term->field_timed_call) && !empty($term->field_timed_call)) {
      $date = (strtotime($term->field_timed_call[LANGUAGE_NONE][0]['value']) + 18000);
      $label = $term->field_timed_call_label[LANGUAGE_NONE][0]['value'];
      $predate = date('Y-m-d H:i:00', $date);
      $u['field_celeb_date'][LANGUAGE_NONE][0]['#default_value']['value'] = $predate;
      $form['pointless'] = array(
        '#type' => 'hidden',
        '#value' => ($label ? "{$label} - " : '') . date('F j, Y', $date),
        '#attributes' => array('id' => array('pointless-hidden-box'))
      );
      $u['field_celeb_date']['#attributes']['class'] = array('robocalls-timed-form-times');
    }
    else
    {
      $form['extras']['fb_container']['field_celeb_send_now'] = $u['field_celeb_send_now'];
      $form['extras']['fb_container']['field_celeb_send_now']['#weight'] = 1;
      $form['extras']['fb_container']['field_celeb_send_now']['#attributes']['id'] = 'or-send-now-button';
    }
    $u['field_celeb_send_now']['#access'] = FALSE;
    #echo '<pre>', print_r($u), '</pre>'; exit;

    if (user_is_logged_in()) {
       global $user;
       $profile = profile2_load_by_user($user, 'main');

       // Cell number
       if (!empty($profile->field_user_mobile[LANGUAGE_NONE][0]['value'])) {
          $u['field_celeb_your_phone'][LANGUAGE_NONE][0]['value']['#default_value'] = $profile->field_user_mobile[LANGUAGE_NONE][0]['value'];
       }

       // First name
       if (!empty($profile->field_user_first_name[LANGUAGE_NONE][0]['value'])) {
          $u['field_celeb_your_name'][LANGUAGE_NONE][0]['value']['#default_value'] = $profile->field_user_first_name[LANGUAGE_NONE][0]['value'];
       }
    }

    drupal_add_js(drupal_get_path('module', 'robocalls') . '/js/robocalls.js', array(
       'weight' => -100,
       'cache' => FALSE
    ));

    /*drupal_add_js(drupal_get_path('module', 'robocalls') . '/js/facebook/tdfriendselector.js', array(
      'weight' => -102,
      'cache' => FALSE
    ));
    drupal_add_js(drupal_get_path('module', 'robocalls') . '/js/facebook/example.js', array(
      'weight' => -101,
      'cache' => FALSE
    ));*/

    if (isset($_GET['done'])) {
       // Pop up the "Done!" pop up
       drupal_add_js(drupal_get_path('module', 'robocalls') . '/js/robocalls_done.js', array(
         'weight' => -99,
         'cache' => FALSE
       ));
    }

    $u['field_celebrity_chooser'][LANGUAGE_NONE]['#default_value'][] = $term->tid;

    if ($term->field_birthday_call[LANGUAGE_NONE][0]['value'] != 1 && !$predate) {
      #$u['field_celeb_date']['#attributes']['style'] = 'display: none;';
    }
    else {
      $form['extras']['is_bday_call'] = array(
         '#type' => 'hidden',
         '#value' => 1,
         '#weight' => 6,
      );
    }

    $form_state['side_bar'] = false;
    if (isset($term->tid) && !empty($term->tid)) {
       unset($u['top_disclaimer']);
       unset($u['step_2']);
    }
    else {
       $form_state['side_bar'] = true;
       drupal_add_css(drupal_get_path('module', 'robocalls') . '/css/robocalls_remote_webform.css', array(
         'group' => CSS_THEME,
         'weight' => 10
       ));
    }

    if (!isset($form_state['return_to'])) {
       $form_state['return_to'] = $_SERVER['REQUEST_URI'];
    }

    $form['#validate'][] = 'robocalls_call_validate';
    $form['#submit'][] = 'robocalls_call_submit';
    $form['#redirect'] = $form_state['return_to'];
  }
}

function robocalls_ajax_call($form, &$form_state) {
  $commands = array();
  $errors = form_get_errors();
  if ($errors) {
    $error_list = '';
    foreach ($errors AS $key => $error) {
       $error_list .= '<li>' . $error . '</li>';
    }

    $fake_error_template = '<div class="messages error">
	    <h2 class="element-invisible">Error message</h2>
	    <ul>' . $error_list . '</ul></div>
    ';
    $commands[] = ajax_command_before('#page-title', $fake_error_template);
  }
  else {
    $commands[] = ajax_command_invoke('#dosomething-login-register-popup-form', 'dsRobocallsSubmit', array($form_state['goto'], $form_state['input']['submitted']['celeb_call_information']['field_celeb_your_phone'][LANGUAGE_NONE][0]['value']));
  }

  return array(
    '#type' => 'ajax',
    '#commands' => $commands
  );
}

function robocalls_menu() {
  $items['call-post-associate/%'] = array(
    'page callback' => 'robocalls_call_post_associate',
    'page arguments' => array(1),
    'access callback' => 'user_is_logged_in',
  );

  return $items;
}

/**
  * So here's the problem:
  * If a user is NOT logged in, they shouldn't be able to send a call.
  * That being said, we can't throw an error at them or they'll ignore it!
  * So they receive the log-in / register box.  IF they log in/register,
  * their submission is associated with them.  After the association, we bring them
  * here, which, now that they're logged in, calls them.  HOWEVER! This should only
  * be called for calls that should have "called now"...otherwise there's no point.
  */
function robocalls_call_post_associate($data) {
  $code = base64_decode($data);
  $info = json_decode($code);

  if (!$info->passed_limit && ($info->sn == 1) && dosomething_general_valid_cell($info->phone)) {
     robocalls_mcommons_call($info->phone, $info->myname, $info->mconnect_id);
  }

  $goto = $info->redirect;
  unset($info->sn, $info->phone, $info->myname, $info->redirect);
  $newcode = base64_encode(json_encode($info));

  drupal_goto($goto . '?done=' . $newcode);
}

function robocalls_call_validate(&$form, &$form_state) {
  $s = $form_state['input']['submitted']/*['celeb_call_information']*/;
  $stime = $s['field_celeb_date'][LANGUAGE_NONE][0]['value'];
 
  $sn = 0;
  $sn = intval($form_state['input']['field_celeb_send_now'][LANGUAGE_NONE]);
  $form['#submission']->submitted['field_celeb_send_now'][LANGUAGE_NONE][0]['value'] = $sn;
  $form['#submission']->field_celeb_send_now[LANGUAGE_NONE][0]['value'] = $sn;
  $form_state['values']['submitted']['field_celeb_send_now'][LANGUAGE_NONE][0]['value'] = $sn;

  #echo $form->submitted['webform_entity_form']['#entity']['input']['mobile_commons_id'];
  $mconnect = $form['submitted']['webform_entity_form']['#entity']->input['mobile_commons_id'];
  //$u['field_mobile_commons_id'][LANGUAGE_NONE][0]['value']['#value'] = $term->field_call_mobile_commons_id[LANGUAGE_NONE][0]['value'];

  $form['#submission']->field_mobile_commons_id[LANGUAGE_NONE][0]['value'] = $mconnect;
  $form['#submission']->submitted['field_mobile_commons_id'][LANGUAGE_NONE][0]['value'] = $mconnect;
  $form_state['values']['submitted']['field_mobile_commons_id'][LANGUAGE_NONE][0]['value'] = $mconnect;

  // Turn it into 24 hours for mktime...
  if ($stime['ampm'] == 'pm' && $stime['hour'] <> 12) {
    $stime['hour'] += 12;
  }
  elseif ($stime['ampm'] == 'am' && $stime['hour'] == 12){
    $stime['hour'] = 0;
  }

  $nst = mktime($stime['hour'], $stime['minute'], 0, $stime['month'], $stime['day'], $stime['year']);

  $form_state['my_number'] = $s['field_celeb_your_phone'][LANGUAGE_NONE][0]['value'];
  $form_state['friend_number'] = $s['field_celeb_friend_phone'][LANGUAGE_NONE][0]['value'];
  $form_state['chosen_celeb'] = $s['field_celebrity_chooser'][LANGUAGE_NONE];
  $error = 0;

  // If they're submitting for a date that's already passed, no bananas!
  if (time() > $nst && !$sn) {
    form_set_error('form', "Sorry, we can't send a call from the past.");
    $error++;
  }

  if (!$form_state['my_number'] || !dosomething_general_valid_cell($form_state['my_number'])) {
    form_set_error('submitted][field_celeb_your_phone', 'Your phone number must be a valid cell phone number (xxx)xxx-xxxx.');
    $error++;
  }

  if (!$form_state['friend_number'] || !dosomething_general_valid_cell($form_state['friend_number'])) {
    form_set_error('submitted][field_celeb_friend_phone', 'Your friend\'s phone number must be a valid cell phone number (xxx)xxx-xxxx.');
    $error++;
  }

  if (!$form_state['chosen_celeb'] || $form_state['chosen_celeb'] == '_none') {
    form_set_error('submitted][field_celebrity_chooser', "Please choose a celebrity.");
    $error++;
  }

  /** Robocalls Flood Control
    * If a phone number has been used MAX_CALLS_PER_DAY times,
    * the submission will fail.  This will prevent people from
    * flooding a phone number with too many phone calls in a day.
    */
  $last_night = strtotime('midnight');
  $tonight = strtotime('11:59pm');

  $limit = $form_state['input']['call_limit'];


  $form_state['already_called'] = 0;
  $q = new EntityFieldQuery;
  $result = $q
  ->entityCondition('entity_type', 'webform_submission_entity')
  ->propertyCondition('nid', $form_state['values']['details']['nid'])
  ->propertyCondition('submitted', array($last_night, $tonight), 'BETWEEN')
  ->propertyOrderBy('submitted', 'DESC')
  ->fieldCondition('field_celeb_friend_phone', 'value', $form_state['friend_number'], '=')
  ->fieldCondition('field_celebrity_chooser', 'tid', $form_state['chosen_celeb'], '=')
  ->execute();
  if (count($result['webform_submission_entity']) >= $limit) {
    #form_set_error('form', "Sorry, this phone number can only be called " . MAX_CALLS_PER_DAY . " times a day.  Wait until tomorrow and try again!");
    #$error++;
    $form_state['already_called'] = $limit;
  }

  if ($error && user_is_logged_in()) {
    drupal_goto($_SERVER['HTTP_REFERER']);
  }
}

function robocalls_call_submit(&$form, &$form_state) {
   $sub = &$form['#submission']->submitted/*['celeb_call_information']*/;

   $friend_phone = $sub['field_celeb_friend_phone'][LANGUAGE_NONE][0]['value'];
   $user_name = $sub['field_celeb_your_name'][LANGUAGE_NONE][0]['value'];
   $my_phone = $sub['field_celeb_your_phone'][LANGUAGE_NONE][0]['value'];

   $send_now =  $sub['field_celeb_send_now'][LANGUAGE_NONE][0]['value'];

   $mconnect_id = $form['submitted']['webform_entity_form']['#entity']->input['mobile_commons_id'];

   if ($send_now && !$form_state['already_called'] && user_is_logged_in()) {
     robocalls_mcommons_call($friend_phone, $user_name, $mconnect_id);
   }

   if ($form_state['already_called'])
   {
    $sid = $form_state['values']['details']['sid'];
    entity_delete('webform_submission_entity', $sid);
   }

   /**
     * If a user is logged in and doesn't have a cell phone connected with their
     * account yet, attach it to their account and save.
     */
   if (user_is_logged_in()) {
    global $user;
    $profile = profile2_load_by_user($user, 'main');
    if (!$profile->field_user_mobile[LANGUAGE_NONE][0]['value'] || $profile->field_user_mobile[LANGUAGE_NONE][0]['value'] !== $my_phone) {
       $profile->field_user_mobile[LANGUAGE_NONE][0]['value'] = $my_phone;
       $profile->save();
    }
   }

   /**
     * If this form was submitted from the side bar, we can't gather the correct
     * term information through Javascript...so generate a JSON code (name & cause) to pass back.
     * We'll revisit this code in the JavaScript, unencode it, and use it to "fill out"
     * the pop-up form with the correct information.
     */
   $parent_name = $term_name = '';
   #if ($form_state['side_bar']) {
      $pi = $sub['field_celebrity_chooser'][LANGUAGE_NONE][0]['tid'];
      $p = taxonomy_get_parents($pi);
      $p = current($p);
      $parent_name = $p->field_short_name[LANGUAGE_NONE][0]['value'];

      $t = taxonomy_term_load($pi);
      $term_name = $t->name;
   #}

   #if (!user_is_logged_in() || $form_state['side_bar']) {
      $code = base64_encode(json_encode(array(
         'name' => $term_name,
         'cause' => $parent_name,
         'passed_limit' => intval($form_state['already_called']),
         'sn' => $send_now,
         'phone' => $friend_phone,
         'myname' => $user_name,
         'redirect' => $_SERVER['HTTP_REFERER'],
         'mconnect_id' => $mconnect_id
      )));
   # }
   # else {
   #   $code = 'true';
   # }
   /*else {
      // Otherwise, we'll have all the information we need because we're on the same page.
      $code = 'true';
   }*/

	/**
	  * If a user is NOT logged in (and are in the process of registering / logging in), their
	  * post will (obviously) not have their name attached to it.  So when they DO log in / register,
	  * let's make sure that we assign this submission to this user.
	  */
   if (!user_is_logged_in()) {
      $form_state['goto'] = 'webform-post-submit-associate/' . $form_state['values']['details']['nid'] . '/' . $form_state['values']['details']['sid'] . '?destination=call-post-associate/' . $code;
   }
   else {
      // Otherwise, they ARE logged in so whatever.
      $form_state['redirect'] = $_SERVER['HTTP_REFERER'] . '?done=' . $code;
      $_GET['redirect'] = ($form_state['redirect']);
   }
}

function robocalls_page_alter(&$page) {
   global $term_info, $flags;

   if (isset($term_info)) {
      $url = array(
       '#tag' => 'meta',
       '#attributes' => array(
          'property' => 'og:url', 
          'content' => url(substr(request_uri(), 1), array('absolute' => true)),
        ),
      );

      $tdesc = $ttitle = '';
      switch ($term_info['flag']) {
        case 'Animals':
          $tdesc = t('4 million shelter animals were euthanized last year because they couldn\'t find homes, find out how to do something about it here.');
          $ttitle = t('Let your friends know about animals in need with a phone call from !name', array('!name' => $term_info['name']));
        break;
        case 'Birthday':
          $tdesc = t('Is your friend a huge fan of !name? Well, you\'re in luck, click here to have them call your friend and wish them a Happy Birthday now!', array('!name' => $term_info['name']));
          $ttitle = t('Wish your firends a happy birthday with a phone call from !name', array('!name' => $term_info['name']));
        break;
        case 'Voting':
          $tdesc = t('1.9 million people couldn\'t find their voting location during the last Presidential election, make sure your friends know where theirs is this November 6th.');
          $ttitle = t('Help your friends find their V-Spot with a phone call from !name', array('!name' => $term_info['name']));
        break;
      }

      $title = array(
       '#tag' => 'meta',
       '#attributes' => array(
          'property' => 'og:title', 
          'content' => $ttitle
        ),
      );

      $desc = array(
       '#tag' => 'meta',
       '#attributes' => array(
          'property' => 'og:description', 
          'content' => $tdesc
        ),
      );
      $image = array(
       '#tag' => 'meta',
       '#attributes' => array(
          'property' => 'og:image', 
          'content' => 'http://files.dosomething.org/files/' . str_replace(drupal_realpath('public://'), '', drupal_realpath($term_info['image']))
        ),
      );
      drupal_add_html_head($url, 'robocalls_url');
      drupal_add_html_head($title, 'robocalls_title');
      drupal_add_html_head($desc, 'robocalls_desc');
      drupal_add_html_head($image, 'robocalls_img');

      $flag = $term_info['flag'];
      /*if (in_array($term_info['tid'], $flags['bdays'])) {
         $flag = 'Birthday Call';
      }
      else if ($flags['latest']['tid'] == $term_info['tid']) {
         $flag = 'New Celeb';
      }
      else if ($flags['popular'] == $term_info['tid']) {
         $flag = 'Most Popular';
      }*/

      $page['content']['system_main'][(user_is_logged_in() ? 'content' : 'main')]['#markup'] = str_replace('Image flag!', ($flag ? '<div class="main-robocall-flag' . ($flag == 'Birthday' ? ' birthday' : '') . '">' . $flag . '</div>' : ''), $page['content']['system_main'][(user_is_logged_in() ? 'content' : 'main')]['#markup']);
      #unset($page['page_bottom']['fb_social']);

   }
}


/**
  * Alters celebrity blocks to include ribbons for:
  * - Birthday calls (defined by checkbox in celebrity creation.  Arbitrary number of these.)
  * - Most Popular (defined by celebrity with most submissions.  Only one.)
  * - New Celeb (defined by most recently created celebrity -- given by date of sound file creation.  Only one.
  */
function robocalls_views_pre_render(&$view) {
   global $flags, $term_info;

   if ($view->name == 'cause_its_your_birthday') {
      $pop = db_query("SELECT `field_celebrity_chooser_tid` AS `tid`, COUNT(*) AS `c` FROM {field_data_field_celebrity_chooser} GROUP BY `field_celebrity_chooser_tid` ORDER BY `c` DESC LIMIT 1")->fetchAssoc();
      $popular = $pop['tid'];

      $latest = array('stamp' => 0, 'key' => 0);
      $bdays = array();
      foreach ($view->result AS $key => $info) {
         $no = 0;
         $parent = key(taxonomy_get_parents($info->tid));

         $bday = (isset($info->_field_data['tid']['entity']->field_birthday_call[LANGUAGE_NONE][0]['value']) && $info->_field_data['tid']['entity']->field_birthday_call[LANGUAGE_NONE][0]['value'] == 1);

         $p = taxonomy_term_load($parent);
         if (!empty($p->name)) {
            if (!$no) $view->result["$key"]->taxonomy_term_data_description .= '<div class="robocall-flag ' . strtolower($p->name) . '">' . $p->name . '</div>';
         }
      }

      $flags = array();
/*      $flags['latest'] = $latest;
      $flags['popular'] = $popular;
      $flags['bdays'] = $bdays;*/

      // New Celeb Flag -- Set from information above
      #if (!$latest['no']) $view->result["{$latest['key']}"]->taxonomy_term_data_description .= '<div class="robocall-flag">New Celeb</div>';

      #$days_before_new_celeb_flag_expires = 1;
      #if ((time() - $latest['stamp']) < ($days_before_new_celeb_flag_expires*60*60*24))
    }
}