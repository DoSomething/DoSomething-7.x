<?php
/**
 * @file
 * Code for the dosomething_feedback feature.
 */

include_once('dosomething_feedback.features.inc');

/**
 * Default the name field to use the user name.
 */
function dosomething_feedback_form_feedback_form_alter(&$form, $form_state) {
  global $user;
  if ($user->uid) {
    $form['field_name'][LANGUAGE_NONE][0]['value']['#default_value'] = $user->name;
  }
}

/**
 * Implements hook_unfuddle_feedback_fields_alter().
 */
function dosomething_feedback_unfuddle_feedback_fields_alter(&$fields, $entry) {
  if (isset($entry->field_priority[LANGUAGE_NONE][0]['value'])) {
    switch($entry->field_priority[LANGUAGE_NONE][0]['value']) {
      case 'Critical':
        $fields['priority'] = 5;
        break;
      case 'High':
        $fields['priority'] = 4;
        break;
      case 'Medium':
        $fields['priority'] = 3;
        break;
      case 'Low':
        $fields['priority'] = 2;
        break;
      case 'Enhancement':
        $fields['priority'] = 1;
        break;
    }
  }
  if (isset($entry->field_component[LANGUAGE_NONE][0]['value'])) {
    switch($entry->field_component[LANGUAGE_NONE][0]['value']) {
      case 'Theme':
        $fields['assignee-id'] = 48348;
        break;
      case 'Functionality':
        $fields['assignee-id'] = 48346;
        break;
    }
  }
  else {
    $fields['assignee-id'] = 48329;
  }
  $fields['description-format'] = 'markdown';
  $fields['milestone-id'] = 419;
}

/**
 * Implements hook_unfuddle_feedback_subject_alter().
 */
function dosomething_feedback_unfuddle_feedback_subject_alter(&$subject, $entry) {
  if (isset($entry->field_summary[LANGUAGE_NONE][0]['value'])) {
    $subject = check_plain($entry->field_summary[LANGUAGE_NONE][0]['value']);
  }
  else {
    $subject = $entry->location;
    $subject .= ' (' . check_plain($entry->field_name[LANGUAGE_NONE][0]['value']) . ')';
  } 
}

/**
 * Implements hook_unfuddle_feedback_description_alter().
 */
function dosomething_feedback_unfuddle_feedback_description_alter(&$description, $entry) {
  if (isset($entry->field_image[LANGUAGE_NONE][0]['fid'])) {
    $file = file_load($entry->field_image[LANGUAGE_NONE][0]['fid']);
    $description .= '![](' . file_create_url($file->uri)  . ' "")';
  }
}


/**
 * Implements hook_feedback_insert().
 */
function dosomething_feedback_feedback_insert($entry) {
  include_once(drupal_get_path('module', 'feedback') . '/feedback.admin.inc');
  $description = drupal_html_to_text(drupal_render(feedback_view($entry)));
  $params['body'] = $description;
  $emails = array('benji@zivtech.com', 'kfong@dosomething.org');
  foreach ($emails as $to) {
    drupal_mail('dosomething_feedback', 'mail', $to, language_default(), $params);
  }
}

/**
 * Implements hook_mail().
 */
function dosomething_feedback_mail($key, &$message, $params) {
  $message['subject'] = 'New Feedback from DoSomething';
  $message['body'][] = $params['body'];
}
