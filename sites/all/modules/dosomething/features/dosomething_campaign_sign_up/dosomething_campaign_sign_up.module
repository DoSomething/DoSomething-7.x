<?php
/**
 * @file
 * Code for the Dosomething - Campaign Sign Up feature.
 */

include_once('dosomething_campaign_sign_up.features.inc');

/**
 * Implements hook_form_alter().
 */
function dosomething_campaign_sign_up_form_alter(&$form, &$form_state, $form_id) {
  // Make sure we're dealing with the right form.
  if (strpos($form_id, 'webform_client_form_') === 0 && isset($form['#node']) && $form['#node']->type == 'campaign_sign_up') {
    $node = $form['#node'];
    // Make sure no one did something stupid like deleting our field.
    if (isset($node->field_signup_magic_fields)) {
      // Get the allowed values.
      $enabled_fields = array();
      if ($items = field_get_items('node', $node, 'field_signup_magic_fields')) {
        foreach ($items as $item) {
          foreach ($item as $field) {
            $enabled_fields[] = $field;
          }
        }
      }
      // Get the field info so that we can get the list of values to work with.
      $field_info = field_info_field('field_signup_magic_fields');
      foreach ($field_info['settings']['allowed_values'] as $field_name => $label) {
        if (isset($form[$field_name]) && !in_array($field_name, $enabled_fields)) {
          $form[$field_name]['#access'] = FALSE;
        }
      }
    }
  }
}

/**
 * Implementation of hook_module_implements_alter().
 */
function dosomething_campaign_sign_up_module_implements_alter(&$implementations, $hook) {
  // We can only disable our elements if we come after webform_entity, make sure we do.
  if ($hook == 'form_alter' && isset($implementations['dosomething_campaign_sign_up'])) {
    $group = $implementations['dosomething_campaign_sign_up'];
    unset($implementations['dosomething_campaign_sign_up']);
    $implementations['dosomething_campaign_sign_up'] = $group;
  }
}
