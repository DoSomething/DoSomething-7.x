<?php

include_once('teams.features.inc');

/**
 * Implements hook_form_alter().
 */
function teams_form_alter(&$form, &$form_state, $form_id) {
  if (strpos($form_id, 'webform_client_form_') !== 0 || empty($form_state['webform_entity']) || $form_state['webform_entity']['bundle'] != 'campaign_sign_up') {
    return;
  }

  $entity_form = &$form['submitted'];
  $node = $form['#node'];

  $form['#validate'][] = 'teams_form_validate';
  $form['#submit'][] = 'teams_form_submit';
}

function teams_form_validate(&$form, &$form_state) {
  if (isset($form['#submission']->submitted)) {
    $sub = $form['#submission']->submitted;
    $team_name = $sub['field_team_name'][LANGUAGE_NONE][0]['value'];
    $leader_info = $sub['field_leader_info'][LANGUAGE_NONE][0]['value'];

    if (!empty($team_name) && !empty($leader_info)) {
      form_set_error('field_team_name', t('You may not attempt to join and create a team at the same time.'));
    }
    else if (empty($team_name) && empty($leader_info)) {
      form_set_error('field_team_name', t('You must either join a team or create a team.'));
    }
    else if (!empty($team_name) && teams_team_exists($sub['field_team_name'][LANGUAGE_NONE][0]['value'], $form['#node']->nid)) {
      form_set_error('field_team_name', t('A team with that name has already been created.'));
    }
    else if (!empty($leader_info) && ($form_state['teams_leader'] = dosomething_general_load_user_by_mail_or_cell($leader_info)) === FALSE) {
      form_set_error('field_leader_info', t('A team leader with that email/cell does not exist.'));
    }
    else {
      if (!empty($team_name)) {
        $form_state['values']['submitted']['group_group'][LANGUAGE_NONE][0]['value'] = 1;
      }
    }
  }
}

function teams_form_submit(&$form, &$form_state) {
  $sub = $form_state['webform_entity']['submission']->submitted;
  $sid = $form_state['values']['details']['sid'];
  $nid = $form_state['values']['details']['nid'];
  $team_name = $sub['field_team_name'][LANGUAGE_NONE][0]['value'];
  $friends = $sub['field_team_invite'][LANGUAGE_NONE];

  if (!empty($team_name)) {
    $gid = og_get_group('webform_submission_entity', $sid, true)->gid;
    // invite friends
    foreach ($friends as $index => $friend) {
      if (is_int($index)) {
        teams_add_member($friend['value'], $gid);
      }
    }
  }
  else {
    $groups = og_get_entity_groups('user', $form_state['teams_leader']);
    $groups = og_load_multiple($groups);
    foreach ($groups as $group) {
      $entity = $group->getEntity();
      if (isset($entity->bundle) && $entity->bundle == 'campaign_sign_up') {
        if ($entity->nid == $nid) {
          og_group($group->gid, array(
            'state' => OG_STATE_ACTIVE,
          ));
        }
      }
    }
  }
}

function teams_team_exists($team_name, $webform_nid) {
  $query = db_select('webform_submissions', 'wf');
  $query->addJoin('INNER', 'og', 'og', 'etid=sid');
  $query->addJoin('INNER', 'field_data_field_team_name', 'name', 'name.entity_id=wf.sid');
  $query->condition('wf.nid', $webform_nid, '=');
  $query->condition('name.field_team_name_value', $team_name, '=');
  $query->addField('wf', 'sid');

  $result = $query->execute()->rowCount();
  return (bool)$result;
}

/**
 * Implements hook_module_implements_alter().
 */
function teams_module_implements_alter(&$implementations, $hook) {
  // We can only disable our elements if we come after webform_entity, make sure we do.
  if ($hook == 'form_alter' && isset($implementations['teams'])) {
    $group = $implementations['teams'];
    unset($implementations['teams']);
    $implementations['teams'] = $group;
  }
}

/**
 * Implements hook_menu().
 */
function teams_menu() {
  $items = array();

  // My team page for campaigns
  $items['my-team/%'] = array(
    'page callback' => 'teams_my_team',
    'page arguments' => array(1),
    'access callback' => 'teams_in_group',
    'access arguments' => array(1),
  );

  $items['teams/join/%/%'] = array(
    'page callback' => 'teams_join_by_url',
    'page arguments' => array(2,3),
    'access callback' => 'user_is_logged_in',
  );

  return $items;
}

/**
 * Implements hook_block_info().
 */
function teams_block_info() {
  $blocks = array();

  $blocks['team_management'] = array(
    'info' => t('DoSomething Team Management'),
    'cache' => DRUPAL_NO_CACHE,
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function teams_block_view($delta = '') {
  global $user;
  $block = array();

  if ($delta != 'team_management') return;

  if (arg(0) == 'team' && is_numeric(arg(2))) {
    $gid = og_get_group('webform_submission_entity', arg(2))->gid;
    $is_admin = og_user_access($gid, 'administer group');

    $query = db_select('og_membership', 'ogm');
    $query->addJoin('inner', 'users', 'u', 'etid=uid');
    $query->condition('entity_type', 'user', '=');
    $query->condition('gid', $gid, '=');
    $query->fields('u', array('uid'));

    $results = $query->execute()->fetchAllAssoc('uid', PDO::FETCH_ASSOC);
    $uids = array_keys($results);

    $list_elements = array();
    foreach ($uids as $uid) {
      $name = dosomething_general_get_full_name($uid);
      if ($name == ' ') $name = '{name unavailable}';

      $name = '<div class="member-name">'.$name.'</div>';

      if ($is_admin && $uid != $user->uid) {
        $name .= drupal_render(drupal_get_form('teams_remove_member_form', $gid, $uid));
      }

      $list_elements[] = array(
        'data' => $name,
        'id' => 'team-member-'.$uid,
        'class' => array('team-member'),
      );
    }

    $block['content']['team_members'] = array(
      '#type' => 'markup',
      '#markup' => '<h3>Team Members</h3>',
    );
    $block['content']['toggle-admin'] = array(
      '#type' => 'markup',
      '#markup' => l('Remove members', '', array(
        'attributes' => array('id' => 'teams-remove-members'),
          'fragment' => ' ',
          'external' => TRUE,
        )
      ),
    );
    $block['content']['users'] = array(
      '#theme' => 'item_list',
      '#attributes' => array(
        'class' => 'members-list',
      ),
      '#items' => $list_elements,
    );
    $block['content']['notification'] = array(
      '#type' => 'container',
      '#attributes' => array(
        'id' => 'teams-notification-area',
      ),
    );
    $block['content']['add-form-description'] = array(
      '#type' => 'markup',
      '#markup' => '<p>Enter your friends\' email address to invite them to join the team. Make sure they know the email address of the team leader--they\'ll need that to join.</p>',
    );
    $block['content']['add-form'] = drupal_get_form('teams_add_member_form', $gid);

    $block['content']['#attached'] = array(
      'js' => array(
        drupal_get_path('module', 'teams') . '/teams.js',
      ),
    );
  }
  return $block;
}

function teams_add_member_form($form, &$form_state, $gid) {
  $form['friend'] = array(
    '#type' => 'textfield',
    '#title' => 'Friend\'s email',
    '#size' => 16,
  );

  $form['gid'] = array(
    '#type' => 'hidden',
    '#default_value' => $gid,
    '#value' => $gid,
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Invite',
    '#ajax' => array(
      'progress' => array(
        'type' => 'throbber',
        'message' => '',
      ),
      'event' => 'click',
      'callback' => 'teams_ajax_add_member',
      'wrapper' => 'teams-notification-area',
      'method' => 'html',
    ),
  );

  return $form;
}

function teams_remove_member_form($form, &$form_state, $gid, $uid) {
  $form['uid'] = array(
    '#type' => 'hidden',
    '#default_value' => $uid,
    '#value' => $uid,
  );

  $form['gid'] = array(
    '#type' => 'hidden',
    '#default_value' => $gid,
    '#value' => $gid,
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Remove',
    '#ajax' => array(
      'progress' => array(
        'type' => 'throbber',
        'message' => '',
      ),
      'event' => 'click',
      'callback' => 'teams_ajax_remove_member',
      'wrapper' => 'team-member-'.$uid,
    ),
  );

  return $form;
}

function teams_ajax_add_member($form, $form_state) {
  if (isset($form_state['values']['friend'])) {
    $friend = $form_state['values']['friend'];
    $gid = $form_state['values']['gid'];
    return teams_add_member($friend, $gid);
  }
  return 'Please include your friend\'s cell or email.';
}

function teams_add_member($friend, $gid) {
  global $user;
  $type = 'email';
  if (!valid_email_address($friend)) {
    if (!$number = dosomething_general_valid_cell($friend)) {
      return 'Please enter a cell number or email address.';
    }
    else {
      $type = 'phone';
      $friend = $number;
    }
  }

  if ($account = dosomething_general_load_user_by_mail_or_cell($friend)) {
    og_group($gid, array(
      'entity' => $account,
      'state' => OG_STATE_ACTIVE,
    ));
    // TODO: add the username to the team list. via an ajax command
    return $friend . ' has been added to your team. Feel free to add more!';
  }
  else {
    $profile = profile2_load_by_user($user, 'main');
    $profile_wrapper = entity_metadata_wrapper('profile2', $profile);
    $first = $profile_wrapper->field_user_first_name->value();
    $last = $profile_wrapper->field_user_last_name->value();

    if ($type == 'email') {
      global $language;
      $group_hash = teams_get_group_hash($gid);
      $params = array(
        'account' => $user,
        'link' => url("teams/join/$gid/$group_hash", array(
          'absolute' => true,
        )),
      );
      drupal_mail('teams', 'invite', $friend, $language, $params);
    }
    else {
      teams_store_number($number, $gid);
      $message = "You have been invited to join $first $last's DoSomething team. Reply TEAMJOIN to join!";
      //sms_send($number, $message);
    }
    return $friend . ' has been invited to join your team. Feel free to add more!';
  }
}

function teams_ajax_remove_member($form, $form_state) {
  $uid = $form_state['values']['uid'];
  $gid = $form_state['values']['gid'];

  if ($account = user_load($uid)) {
    og_ungroup($gid, 'user', $account);
    return '';
  }
}

function teams_store_number($number, $gid) {
  $data = array(
    'gid' => $gid,
    'number' => $number,
  );
  drupal_write_record('teams_invited', $data);
}

function teams_join_by_url($gid, $hash) {
  if ($hash === teams_get_group_hash($gid)) {
    og_group($gid, array(
      'state' => OG_STATE_ACTIVE,
    ));

    $sub = og_load_entity_from_group($gid);
    $form = node_load($sub->nid);
    $campaign = og_load_entity_from_group($form->group_audience[LANGUAGE_NONE][0]['gid']);
    $url = drupal_lookup_path('alias', 'node/' . $campaign->nid);

    drupal_goto('my-team/' . $url);
  }
}

function teams_get_group_hash($gid) {
  $sub = og_load_entity_from_group($gid);
  return substr(md5($sub->sid . $sub->nid . 'bananas!'), 0, 8);
}

/**
 * Menu callback for my-team/%.
 */
function teams_my_team($url_base) {
  $team = teams_get_my_teams_for_url($url_base);
  drupal_goto('team/'.$url_base.'/'.array_shift($team));
}

/**
 * Access callback for checking if a user is part of a group for
 * a given base URL campaign.
 */
function teams_in_group($url_base) {
  return teams_get_my_teams_for_url($url_base) != array();
}

function teams_get_my_teams_for_url($url) {
  static $sid;
  global $user;
  if (!isset($sid)) {
    $campaign_nid = teams_get_nid_from_path($url);
    $campaign_gid = og_get_group('node', $campaign_nid)->gid;

    $query = db_select('og_membership', 'o1');
    $query->addJoin('INNER', 'node', 'n', 'o1.etid=n.nid');
    $query->addJoin('RIGHT', 'webform_submissions', 'wf', 'wf.nid=n.nid');
    $query->addJoin('INNER', 'og', 'o2', 'o2.etid=wf.sid');
    $query->addJoin('INNER', 'og_membership', 'o3', 'o3.gid=o2.gid');
    $query->condition('o3.entity_type', 'user', '=');
    $query->condition('o3.etid', $user->uid, '=');
    $query->condition('o1.gid', $campaign_gid, '=');
    $query->condition('n.type', 'campaign_sign_up', '=');
    $query->fields('wf', array('sid'));
    $result = $query->execute()->fetchAllAssoc('sid', PDO::FETCH_ASSOC);

    $sid = array_keys($result);
  }
  return $sid;
}

function teams_get_nid_from_path($url) {
  $campaign_path = drupal_lookup_path('source', $url);
  if (strpos($campaign_path, 'node') === 0) {
    $campaign_nid = explode('/', $campaign_path);
    $campaign_nid = $campaign_nid[1];
  }
  return $campaign_nid;
}

/**
 * Implements hook_mail().
 */
function teams_mail($key, &$message, $params) {
  switch ($key) {
    case 'invite':
      $params['full_name'] = dosomething_login_get_user_full_name($params['account']);
      $message['subject'] = t('@name has invited you to join their DoSomething team', array('@name' => $params['full_name']));
      $message['body'][] = drupal_html_to_text(theme('teams_invite', $params));
      $message['headers']['Content-Type'] = 'text/html; charset=utf-8';
      break;
  }
}

/**
 * Implements hook_theme().
 */
function teams_theme($existing, $type, $theme, $path) {
  return array(
    'teams_invite' => array(
      'path' => $path . '/templates',
      'variables' => array(),
      'template' => 'teams-invite',
    ),
  );
}


