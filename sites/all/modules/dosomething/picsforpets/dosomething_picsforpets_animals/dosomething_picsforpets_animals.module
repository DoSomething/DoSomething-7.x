<?php

/**
 * @file
 * Custom code relating to PicsForPets pet creation and display.
 */

/**
 * Implements hook_menu().
 * TODO: use no_js here.
 */
function dosomething_picsforpets_animals_menu() {
  $items['pics-for-pets/carousel/js/%'] = array(
    'type' => MENU_CALLBACK,
    'access callback' => TRUE,
    'page callback' => 'dosomething_picsforpets_animals_submissions',
    'page arguments' => array(3),
  );
  return $items;
}

/**
 * Implements webform_submission_render_alter().
 */
function dosomething_picsforpets_animals_webform_submission_render_alter(&$renderable) {
  // Add carousel javascript to displays of pet profiles.
  $node = $renderable['#node'];
  if ($node->type == 'fb_app_data_gathering_form' && $node->title == 'Pet Picture') { // TODO: check for specific node id once we know one; the title can change.
    drupal_add_js(drupal_get_path('module', 'dosomething_picsforpets_animals') . '/js/picsforpets-carousel.js');
    // TODO: set both settings as array together.
    drupal_add_js(array('picsforpetsAnimals' => array('sid' => $renderable['#submission']->sid)), 'setting');
    // Total number of available pet submissions.
    // TODO: limit to correct node results.
    $total = db_query("SELECT COUNT(sid) FROM webform_submissions")->fetchField();
    drupal_add_js(array('picsforpetsAnimals' => array('total' => $total)), 'setting');
  }
}

/**
 * Menu callback.
 * Return 10 items for the 'wings' on the pet carousel.
 */
function dosomething_picsforpets_animals_submissions($sid, $offset = 0) {
  // TODO: order by sharing desc and limit to correct node results.
  $sids = db_query_range("SELECT sid FROM webform_submissions WHERE sid <> :sid", $offset, 8, array(':sid' => $sid))->fetchCol();
  // The first time we run this, also add the primary submissions's info.
  if (!$offset) {
    array_unshift($sids, $sid);
    $i = 0;
  }
  else {
    $i = $offset + 1;
  }
  foreach ($sids as $sid) {
    $wrapper = entity_metadata_wrapper('webform_submission_entity', $sid);
    $submission = new stdClass();
    $submission->sid = $sid;
    $path = $wrapper->field_fb_app_image->value();
    $submission->image_inner = theme('image_style', array('style_name' => 'carousel_inner', 'path' => $path['uri']));
    $submission->image_outer = theme('image_style', array('style_name' => 'carousel_outer', 'path' => $path['uri']));
    // TODO: Add comment here better than this one (meta).
    if ($i % 2) {
      $submissions[-1 * ($i + 1 ) / 2] = $submission;
    }
    else {
      $submissions[$i / 2] = $submission;
    }
    $i++;
  }
  drupal_json_output($submissions);
}

/**
 * Implements hook_ctools_render_alter().
 *
 * This hook gives us access to the panel itself, not just one pane.
 */
function dosomething_picsforpets_animals_ctools_render_alter(&$info, &$page, &$context) {
  if (!$page || (isset($context['task']['task type']) && $context['task']['task type'] != 'page')) {
    return;
  }

  // If this is a custom page, the name is the machine name, and is stored as
  // the name of the subtask. If it is a system page like node/%node, the name
  // is stored as the name of the handler. These names are global, not per-page.
  // Unless it is customized upon export, it will be in the form of
  // NAME_panel_context_DELTA, for example, node_view_panel_context_3.
  $name = isset($context['subtask']['name']) ? $context['subtask']['name'] : $context['handler']->name;

  switch ($name) {
    case 'webform_submission_view_pet_profile':
      drupal_add_js(drupal_get_path('module', 'dosomething_picsforpets_animals') . '/js/picsforpets-carousel.js');
      drupal_add_js(array('picsforpetsAnimals' => array('sid' => $context['args'][0]->sid)), 'setting');
      // Total number of available pet submissions.
      // TODO: limit to correct node results.
      $total = db_query("SELECT COUNT(sid) FROM webform_submissions")->fetchField();
      drupal_add_js(array('picsforpetsAnimals' => array('total' => $total)), 'setting');
    break;
  }
}

/**
 * Implements hook_form_alter().
 */
function dosomething_picsforpets_animals_form_alter(&$form, &$form_state, $form_id) {
  if (strpos($form_id, 'webform_client_form_') === 0) {
    if ($form['#node']->type == 'fb_app_data_gathering_form') {
      drupal_add_js(drupal_get_path('module', 'dosomething_picsforpets_animals') . '/js/picsforpets-animal-type-other.js');
    }
  }
}
