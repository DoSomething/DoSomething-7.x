<?php
/**
 * @file
 * Code for the dosomething_picsforpets_general feature.
 */

include_once 'dosomething_picsforpets_general.features.inc';

// The node id for the pet submission form.
define('PICSFORPETS_PET_SUBMISSION_NID', 3);

/**
 * Implements hook_menu().
 */
function dosomething_picsforpets_general_menu() {
  $items['pics-for-pets/share/js/%'] = array(
    'type' => MENU_CALLBACK,
    'access callback' => TRUE,
    'page callback' => 'dosomething_picsforpets_general_share',
    'page arguments' => array(3),
  );
  $items['pics-for-pets/become-a-furtographer'] = array(
    'title' => t('Become a Furtographer!'),
    'access callback' => TRUE,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('dosomething_picsforpets_general_furtographer_form'),
  );
  $items['pics-for-pets/thanks-for-sharing'] = array(
    'title' => t('Thanks for sharing!'),
    'access callback' => TRUE,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('dosomething_picsforpets_general_thanks_form'),
  );
  $items['pics-for-pets/questions'] = array(
    'title' => t('Frequently Asked Questions'),
    'access callback' => TRUE,
    'page callback' => 'dosomething_picsforpets_general_questions',
  );
  return $items;
}

/**
 * Making a collapsible faq for the pics-for-pets/questions page.
 */
function dosomething_picsforpets_general_questions() {
  $page = array();
  $page['#attached'] = array(
    'js' => array(
      'misc/form.js',
      'misc/collapse.js',
    ),
  );
  $page['email'] = array(
    '#markup' => t('<p class="questions-email">Email us at picsforpets@dosomething.org</p>'),
  );
  $page['question1'] = array(
    '#theme' => 'fieldset',
    '#title' => t('What is pics for pets?'),
    '#attributes' => array(
      'class' => array('collapsible', 'collapsed'),
    ),
    '#children' => t('Pics for pets is a program started by dosomething.'),
  );
   $page['question2'] = array(
    '#theme' => 'fieldset',
    '#title' => t('How do I become a fur-tographer?'),
    '#attributes' => array(
      'class' => array('collapsible', 'collapsed'),
    ),
    '#children' => t('Pics for pets is a program started by dosomething.'),
  );
   $page['question3'] = array(
    '#theme' => 'fieldset',
    '#title' => t('How do I find my local shelter?'),
    '#attributes' => array(
      'class' => array('collapsible', 'collapsed'),
    ),
    '#children' => t('Pics for pets is a program started by dosomething.'),
  );
    $page['question4'] = array(
    '#theme' => 'fieldset',
    '#title' => t('What if I want to visit a different shelter?'),
    '#attributes' => array(
      'class' => array('collapsible', 'collapsed'),
    ),
    '#children' => t('Pics for pets is a program started by dosomething.'),
  );
    $page['question5'] = array(
    '#theme' => 'fieldset',
    '#title' => t('Am I allowed to handle the animals?'),
    '#attributes' => array(
      'class' => array('collapsible', 'collapsed'),
    ),
    '#children' => t('Pics for pets is a program started by dosomething.'),
  );
    $page['question6'] = array(
    '#theme' => 'fieldset',
    '#title' => t('Can I take a picture of more than one animal?'),
    '#attributes' => array(
      'class' => array('collapsible', 'collapsed'),
    ),
    '#children' => t('Pics for pets is a program started by dosomething.'),
  );
    $page['question7'] = array(
    '#theme' => 'fieldset',
    '#title' => t('How do I take good photos of animals?'),
    '#attributes' => array(
      'class' => array('collapsible', 'collapsed'),
    ),
    '#children' => t('Pics for pets is a program started by dosomething.'),
  );
    $page['question8'] = array(
    '#theme' => 'fieldset',
    '#title' => t('How do I win the animals prizes?'),
    '#attributes' => array(
      'class' => array('collapsible', 'collapsed'),
    ),
    '#children' => t('Pics for pets is a program started by dosomething.'),
  );
    $page['question9'] = array(
    '#theme' => 'fieldset',
    '#title' => t('How do I win a $5,000 scholarship?'),
    '#attributes' => array(
      'class' => array('collapsible', 'collapsed'),
    ),
    '#children' => t('Pics for pets is a program started by dosomething.'),
  );
    $page['question10'] = array(
    '#theme' => 'fieldset',
    '#title' => t('Hey, you didn\'t answer my question!'),
    '#attributes' => array(
      'class' => array('collapsible', 'collapsed'),
    ),
    '#children' => t('Pics for pets is a program started by dosomething.'),
  );
return $page;
}

/**
 * Form that pops up when you click 'become a furtographer'.
 */
function dosomething_picsforpets_general_furtographer_form($form, &$form_state) {
  $form['#attributes'] = array(
    'title' => 'Ready to be a fur-tographer?',
  );
  $form['ready'] = array(
    '#markup' => '<div class="sign-up-text">Sign up and we\'ll give you all the tools to submit a picture to the gallery.</div>',
  );
  $form['email'] = array(
    '#type' => 'textfield',
    '#required' => TRUE,
    '#title' => t('Email:'),
    '#maxlength' => 255,

  );
  $form['cell'] = array(
    '#type' => 'textfield',
    '#title' => t('Cell:'),
    '#maxlength' => 255,
  );
  $form['kit'] = array(
    '#type' => 'checkbox',
    '#title' => t('Send me an action kit with sweet guides and supplies!'),
  );
  $form['address'] = array(
    '#prefix' => '<div id="furtographer-address">',
    '#suffix' => '</div>',
  );
  $form['address']['fields'] = array(
    '#title' => t('address'),
    '#type' => 'fieldset',
    'name' => array(
      '#type' => 'textfield',
      '#title' => t('Full Name:'),
    ),
    'street1' => array(
      '#type' => 'textfield',
      '#title' => t('Street Address:'),
    ),
    'street2' => array(
      '#type' => 'textfield',
      '#title' => t('Street Address 2:'),
    ),
    'city' => array(
      '#type' => 'textfield',
      '#title' => t('City:'),
    ),
    'state' => array(
      '#type' => 'textfield',
      '#title' => t('State'),
    ),
    'zip' => array(
      '#type' => 'textfield',
      '#title' => t('Zip'),
    ),
  );

  $form['help'] = array(
    '#markup' => '<div class="by-signing-up">' . t('By signing up you agree to the ') . l('terms and conditions', '/') . '</div><ul class="question-icon-popup"><li class="question-icon">?<ul class="question-text-popup"><li class="question-text">' . t('Enter your phone number to get weekly updates from DoSomething.org, including campaign news and chances to win prizes and scholarships. (Message and data rates may apply. Text STOP to opt-out. Email help@dosomething.org or text HELP for help.)') . '</li></ul></li></ul>',
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Sign Up',
  );
  $form['#action'] = '/pics-for-pets/lets-get-started';
  $form['#attached'] = array(
    'js' => array(
      'type' => 'file',
      'data' => drupal_get_path('module', 'dosomething_picsforpets_general') . '/js/furtog-form.js',
    ),
  );
  return $form;
}

function dosomething_picsforpets_general_furtographer_form_submit($form, $form_state) {
  // TODO: send to mailchimp and campaign sign up webform.
  dpm($form_state['values']);
}

/**
 * Form that pops up after you have shared 3 pets.
 */
function dosomething_picsforpets_general_thanks_form($form, &$form_state) {
  $form['#attributes'] = array(
    'title' => t('Thanks for sharing!'),
  );
  $form['instructions'] = array(
    '#markup' => t("Enter your info and we'll send you updates on animals in the gallery"),
  );
  $form['email'] = array(
    '#type' => 'textfield',
    '#required' => TRUE,
    '#title' => t('Email:'),
    '#maxlength' => 255,
  );
  $form['cell'] = array(
    '#type' => 'textfield',
    '#title' => t('Cell:'),
    '#maxlength' => 255,
  );
  $form['help'] = array(
    '#markup' => t('Click submit to sign up and recieve weekly updates <a class="helptext-questionmark-popup">Enter your phone number to get weekly updates from DoSomething.org, including campaign news and chances to win prizes and scholarships. (Message and data rates may apply. Text STOP to opt-out. Email help@dosomething.org or text HELP for help.)</a>'),
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Submit',
  );
  return $form;
}

/**
 * Form that pops up after you have shared 5 pets.
 */
function dosomething_picsforpets_invite_form($form, &$form_state) {
  $form['heading'] = array(
    '#markup' => t("You've helped 5 animals!"),
  );
  $form['text'] = array(
    '#markup' => t('Invite your friends to help more animals find homes!'),
  );
  include_once('plugins/content_types/invite_friends.inc');
  $form['invite'] = dosomething_picsforpets_general_content_type_render_invite()->content;
  return $form;
}

/**
 * Default validation handler for the
 * dosomething_picsforpets_general_thanks_form.
 */
function dosomething_picsforpets_general_thanks_form_validate($form, &$form_state) {
  dpm('validating');
}

/**
 * Default submit handler for the
 * dosomething_picsforpets_general_thanks_form.
 */
function dosomething_picsforpets_general_thanks_form_submit($form, &$form_state) {
  dpm('submitting');
}
/**
 * Implements hook_custom_theme().
 */
function dosomething_picsforpets_general_custom_theme() {
  // Use the picsforpets theme when on the pics-for-pets paths and entities of the site.
  if (arg(0) == 'pics-for-pets') {
    return 'picsforpets';
  }
  if ($submission = menu_get_object('webform_entity_pages_submission')) {
    if ($submission->nid == PICSFORPETS_PET_SUBMISSION_NID) {
      return 'picsforpets';
    }
  }
  if ($node = menu_get_object()) {
    if ($node->nid == PICSFORPETS_PET_SUBMISSION_NID) {
      return 'picsforpets';
    }
  }
}

/*
* Implements hook_ctools_plugin_directory().
*/
function dosomething_picsforpets_general_ctools_plugin_directory($owner, $plugin_type) {
  if ($owner == 'ctools') {
    return 'plugins/' . $plugin_type;
  }
}

/**
 * Share (like) a webform submission on facebook.
 */
function dosomething_picsforpets_general_share($sid) {
  $_fb_app = fb_load('picsforpets');
  $fb = fb_api_init($_fb_app);
  $access_token = fb_get_token($fb);
  if (is_numeric($sid)) {
    $url = drupal_get_path_alias('webform-submission/' . $sid);
    $response = drupal_http_request('https://graph.facebook.com/' . 'http://apps.facebook.com/picsforpets/' . $url . '/likes' , array('method' => 'POST', 'data' => 'access_token=' . $access_token));
    dpm($response);
  }
  return '';
}
