<?php

function dosomething_contact_picker_menu() {
  $items['invite-by-email-scraper/%'] = array(
    'page callback' => 'contact_scraper::scraper_invite',
    'page arguments' => array(1),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );

  $items['contacts-scraper/%'] = array(
    'page callback' => 'contact_scraper::scraper_landing',
    'page arguments' => array(1),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );

  $items['contacts-scraper/%/done'] = array(
    'page callback' => 'contact_scraper::scraper_landing',
    'page arguments' => array(1, TRUE),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );

  $items['contact-picker/google'] = array(
  	'page callback' => 'dosomething_contact_picker_handle_google',
  	'access callback' => TRUE,
  );

  return $items;
}

function dosomething_contact_picker_handle_google() {
$node = json_decode(base64_decode(($_GET['nid']))); 
if ($_POST['do'] == 'blah') {
  require_once DRUPAL_ROOT . '/google-api-php-client/src/apiClient.php';
  require_once DRUPAL_ROOT . '/google-api-php-client/src/contrib/apiPlusService.php';

  $client = new apiClient();
  $client->setApplicationName('Google Contacts Test');
  $client->setScopes('http://www.google.com/m8/feeds');

  $client->setClientId('1000659299351.apps.googleusercontent.com');
  $client->setClientSecret('sp-8HDxoUCFZH1bH9XOUuglO');
  $client->setRedirectUri('http://' . $_SERVER['HTTP_HOST'] . '/contact-picker/google');

  $k = $_POST['key'];
  $key = json_encode(array(
    'access_token' => $k['access_token'],
    'token_type' => $k['token_type'],
    'expires_in' => $k['expires_in'],
    'created' => time()
  ));
  $client->setAccessToken($key);

  if ($client->getAccessToken()) {
    $req = new apiHttpRequest('https://www.google.com/m8/feeds/contacts/default/full?max-results=1000');
    if (!$val = $client->getIo()->authenticatedRequest($req)) {
      echo "Please refresh the page and log back in to Google.";
      exit;
    }

    $xml = ($val->getResponseBody());
    $res .= '<ul id="blah">';
    $vals = array();
    preg_match_all('#<entry>(.*?)</entry>#si', $xml, $entries);
    foreach ($entries[1] AS $key => $entry) {
      preg_match('#\<title type\=("|\'|)text(\\1)\>(.*?)\<\/title\>#i', $entry, $name);
      preg_match('#<gd\:email([^(<]*)(address\=("|\'|)([^("|\'|)]*))#i', $entry, $email);

      $n = $name[3];
      $e = $email[4];

      $vals[strtolower($e)] = array(
        'e' => $e,
        'n' => $n
      );
    }

    ksort($vals);
    foreach ($vals AS $e => $s) {
      if (!empty($s['e'])) {
        $res .= '
        <li>
          <input type="checkbox" class="email-checkbox" checked="checked" name="emails[]" value="' . $s['e'] . '" id="' . dosomething_general_clean_string($s['e']) . '" />
          <strong>' . $s['e'] . '</strong>
          <span>' . $s['n'] . '</span>
        </li>';
      }
    }

    $res .= '</ul>';

    echo $res;
  }
  exit;
}
}

class contact_scraper {
	public static function add_scraper_button(&$form, $weight = 0, $attributes = array()) {
	  $node = menu_get_object();
	  $form['invite_by_email'] = array(
	    '#markup' => l(t('Share with email'), 'contact-scraper/' . $node->nid, array(
	      'attributes' => array(
	        'class' => array('invite-by-email-link'),
	        'onclick' => 'return invite_find_emails(' . $node->nid . ')',
	      ) + $attributes,
	    )),
	    '#prefix' => '<p id="invite-by-email">',
	    '#suffix' => '</p>',
	    '#weight' => $weight,
	  );

	  $form['#attached']['js'][] = array(
	      'data' => drupal_get_path('module', 'dosomething_contact_picker') . '/js/scraper_init.js',
	      'options' => array(
	        'group' => JS_LIBRARY,
	        'preprocess' => FALSE,
	        'every_page' => TRUE
	      )
	  );

	  $form['#attached']['css'][] = array(
	      'data' => drupal_get_path('module', 'dosomething_contact_picker') . '/css/scraper_init.css',
	  );
	}

	public static function get_services(&$form) {
		$path = drupal_get_path('module', 'dosomething_contact_picker');
		$services = shell_exec("grep -r 'name\:' " . $path . "/services/*");
		preg_match_all('#([^/]+\.js)\:\s+name\:\s*(\'|\")(.*)\\2#i', $services, $matches);

		$r = $s = '';
		foreach ($matches[3] AS $key => $service) {
			$s = str_replace('.js', '', $matches[1][$key]);
			$scripts .= '<script type="text/javascript" src="/' . $path . '/services/' . $s . '/' . $matches[1][$key] . '"></script>';

			$r .= '<div class="service">';
			$r .= '<a href="#" onclick="return service(\'' . $s . '\', \'' . $path . '\')"><img class="service-image" src="/' . drupal_get_path('module', 'dosomething_contact_picker') . '/services/' . $s . '/' . $s . '.png' . '" alt="" />';
			$r .= t('Get !service contacts', array('!service' => $service));
			$r .= '</a>';
			$r .= '</div>';
		}

		return array(
			'scripts' => $scripts,
			'services' => $r
		);
	}

	public static function scraper_landing($nid, $done = FALSE) {
		if (empty($nid) || !intval($nid)) {
			exit;
		}

		$email = module_invoke_all('contact_scraper_emails');
		$node = node_load($nid);

		if (!$done && intval($nid)) {
		  $params = array(
			'title' => $node->title,
			'nid' => $node->nid,
		  );

		  if (isset($email["{$node->type}"]['client_email'])) {
		  	$e = $email["{$node->type}"]['client_email'];
			$e['body'] = str_replace(array("\n", '"'), array('\r\n', '\"'), $e['body']);

		  	$params['client_email'] = t('I prefer to !send', array('!send' => '<a href="#" onclick=\'return scraper_email(e_title, e_body)\'>' . t('use my own email client') . '</a>.'));
		  }

		  $params['email_title'] = $e['title'];
		  $params['email_body'] = $e['body'];

		  echo theme('contact_scraper_landing', $params);
		}
		else if ($done) {
		  echo theme('contact_scraper_done', array(
			'title' => $node->title,
			'nid' => $node->nid
		  ));
		}
		exit;
	}

	public static function scraper_invite($nid) {
	  if ($_POST['do'] == 'email') {
		global $user, $language;
		$node = node_load($nid);

		$emails = module_invoke_all('contact_scraper_emails');
		if (isset($emails["{$node->type}"]['invited'])) {
		  $e = $emails["{$node->type}"]['invited'];

		  foreach (explode(',', $_POST['real_emails']) AS $email) {
			if (valid_email_address(trim($email))) {
  			  if (isset($_SESSION['guest_user_info']) && !user_is_logged_in()) {
				  $e['params']['first_name'] = $_SESSION['guest_user_info']['first_name'];
				  $e['params']['last_name'] = $_SESSION['guest_user_info']['last_name'];
  			  }
			  $e['params']['email'] = $email;
			  $e['params']['email'] .= '/' . md5($email . md5('ds.org'));

			  drupal_mail($e['group'], $e['email'], trim($email), $language, ($e['params'] ? $e['params'] : array()));

			  // If a "store" function is set, store this node ID, user ID and email in the database.
			  if (isset($e['store_function'])) {
			    $e['store_function']($node->nid, $user->uid, $email);
			  }
			}
		  }
		}

		// Email the inviter
		if ($user->mail && isset($emails["{$node->type}"]['inviter'])) {
		  $i = $emails["{$node->type}"]['inviter'];
		  drupal_mail($i['group'], $i['email'], $user->mail, $language, ($i['params'] ? $i['params'] : array()));
		}

		drupal_goto('contacts-scraper/' . $node->nid . '/done');
	  }
	}
}

function dosomething_contact_picker_theme($existing, $type, $theme, $path) {
  return array(
    'contact_scraper_landing' => array(
      'path' => $path . '/templates',
      'variables' => array(
        'title' => NULL,
        'nid' => NULL,
        'email_text' => NULL
      ),
      'template' => 'contact-scraper-landing',
    ),
    'contact_scraper_done' => array(
      'path' => $path . '/templates',
      'variables' => array(
        'title' => NULL,
        'nid' => NULL
      ),
      'template' => 'contact-scraper-done',
    )
   );
 }


function dosomething_contact_scraper_land($nid, $done = FALSE) {
	if (empty($nid) || !intval($nid)) {
		exit;
	}

	$email = module_invoke_all('contact_scraper_emails');
	$node = node_load($nid);

	if (!$done && intval($nid)) {
	  $params = array(
		'title' => $node->title,
		'nid' => $node->nid,
	  );

	  if (isset($email["{$node->type}"]['client_email'])) {
	  	$e = $email["{$node->type}"]['client_email'];
		$e['body'] = str_replace(array("\n", '"'), array('\r\n', '\"'), $e['body']);

	  	$params['client_email'] = t('I prefer to !send', array('!send' => '<a href="#" onclick=\'return scraper_email("' . $e['title'] . '", "' . $e['body'] . '")\'>' . t('use my own email client') . '</a>.'));
	  }

	  echo theme('contact_scraper_landing', $params);
	}
	else if ($done) {
	  echo theme('contact_scraper_done', array(
		'title' => $node->title,
		'nid' => $node->nid
	  ));
	}
	exit;
}

function dosomething_contact_scraper_invite($nid) {
  if ($_POST['do'] == 'email') {
	global $user, $language;
	$node = node_load($nid);

	$emails = module_invoke_all('contact_scraper_emails');
	if (isset($emails["{$node->type}"]['invited'])) {
	  $e = $emails["{$node->type}"]['invited'];

	  foreach (explode(',', $_POST['real_emails']) AS $email) {
		if (valid_email_address(trim($email))) {
		  drupal_mail($e['group'], $e['email'], trim($email), $language, ($e['params'] ? $e['params'] : array()));

		  // If a "store" function is set, store this node ID, user ID and email in the database.
		  if (isset($e['store_function'])) {
		    $e['store_function']($node->nid, $user->uid, $email);
		  }
		}
	  }
	}

	if ($user->mail && isset($emails["{$node->type}"]['inviter'])) {
	  $i = $emails["{$node->type}"]['inviter'];
	  drupal_mail($i['group'], $i['email'], $user->mail, $language, ($i['params'] ? $i['params'] : array()));
	}

	drupal_goto('contacts-scraper/' . $node->nid . '/done');
  }
}