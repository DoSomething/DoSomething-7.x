<?php

define('CGG_CHOOSER_FORM', variable_get('cgg_form_id', 725016));
define('CGG_TAXONOMY_VOCABULARY', variable_get('cgg_taxonomy_vocabulary', 29));

/**
 *  Implements hook_webform_select_options_info()
 */
function dosomething_campaign_styles_webform_select_options_info() {
  return array(
    'celebs' => array(
      'title' => t('Celebs Gone Good Celebrities'),
      'options callback' => 'dosomething_campaign_styles_ccg_options_list',
    ),
  );
}

function dosomething_campaign_styles_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'webform_client_form_' . CGG_CHOOSER_FORM) {
    if (!user_is_logged_in()) {
      drupal_add_js(drupal_get_path('module', 'dosomething_campaign_styles') . '/campaign_styles/2012/cgg/js/cgg.js');
      $form['actions']['submit']['#ajax'] = array(
        'callback' => 'dosomething_campaign_styles_ccg_submit',
      );
    }
    else {
      $form['#submit'][] = 'dosomething_campaign_styles_ccg_submit';
    }
  }
}

function dosomething_campaign_styles_ccg_submit($form, &$form_state) {
  $celeb = $form_state['values']['submitted_tree']['cgg_choose_a_celebrity'];
  $redirect = 'celebsgonegood/voted/' . $celeb;

  if (!user_is_logged_in()) {
    global $user;

    $commands = array();
    $errors = form_get_errors();
    if ($errors) {
      $error_list = '';
      foreach ($errors AS $key => $error) {
         $error_list .= '<li>' . $error . '</li>';
      }

      $fake_error_template = '<div class="messages error">
        <h2 class="element-invisible">Error message</h2>
        <ul>' . $error_list . '</ul></div>
      ';
      $commands[] = ajax_command_before('#page-title', $fake_error_template);
    }
    else {
      $commands[] = ajax_command_invoke('#dosomething-login-register-popup-form', 'dsCGGSubmit', array($redirect, ($user->uid > 0)));
    }

    return array(
      '#type' => 'ajax',
      '#commands' => $commands
    );
  }
  else {
    drupal_goto($redirect);
  }
}

function dosomething_campaign_styles_ccg_options_list() {
  $celebs = taxonomy_get_tree(CGG_TAXONOMY_VOCABULARY);
  $array = array();
  foreach ($celebs AS $key => $celeb) {
    $array["{$celeb->tid}"] = $celeb->name;
  }
  
  return $array;
}

/**
 * Implements hook_init().
 */
function dosomething_campaign_styles_init() {
  if ($context = og_context()) {
    if (isset($context->etid)) {
      ctools_include('plugins');
      // Currently this is hard coded to work with nids specifically.
      $plugin_name = dosomething_campaign_styles_pluginify_path(drupal_get_path_alias('node/' . $context->etid));
      if ($plugin = ctools_get_plugins('dosomething_campaign_styles', 'campaign_style', $plugin_name)) {
        $plugins = array();
        $plugins[] = $plugin;
        while ($parent_plugin = dosomething_campaign_styles_get_style_parent($plugin)) {
          $plugin = $parent_plugin;
          $plugins[] = $parent_plugin;
        }
        while ($plugin_data = array_pop($plugins)) {
          drupal_add_css($plugin_data['path'] . '/' . 'ds_campaign.css', array('group' => CSS_THEME));
          drupal_add_js($plugin_data['path'] . '/' . 'ds_campaign.js');
          foreach ($plugin_data['css'] as $css_path) {
            drupal_add_css($plugin_data['path'] . '/' . $css_path, array('group' => CSS_THEME));
          }
          foreach ($plugin_data['js'] as $js_path) {
            drupal_add_js($plugin_data['path'] . '/' . $js_path);
          }
        }
        drupal_add_css(drupal_get_path('module', 'dosomething_campaign_styles') . '/css/dosomething_campaign_signup.css');
        drupal_add_library('dosomething_general', 'fb-friend-finder');
      }
    }
  }
}

/**
 * Implements hook_ctools_plugin_type().
 */
function dosomething_campaign_styles_ctools_plugin_type() {
  return array(
    'campaign_style' => array(
      'child plugins' => FALSE,
      'load themes' => TRUE,
      'cache' => TRUE,
    ),
  );
}

/**
 * Implements hook_ctools_plugin_directory().
 *
 * @param string $owner
 *   The system name of the module owning the plugin type for which a base
 *   directory location is being requested.
 * @param string $plugin_type
 *   The name of the plugin type for which a base directory is being requested.
 * @return string
 *   The path where CTools' plugin system should search for plugin files,
 *   relative to your module's root. Omit leading and trailing slashes.
 */
function dosomething_campaign_styles_ctools_plugin_directory($owner, $plugin_type) {
  if ($owner == 'dosomething_campaign_styles' && $plugin_type == 'campaign_style') {
    return "campaign_styles";
  }
  else if ($owner == 'ctools') {
    return 'plugins/' . $plugin_type;
  }
}

/**
 * Find the parent of a given campaign style.
 */
function dosomething_campaign_styles_get_style_parent($plugin) {
  $parent_plugin = FALSE;
  if (isset($plugin['parent'])) {
    ctools_include('plugins');
    $parent_plugin = ctools_get_plugins('dosomething_campaign_styles', 'campaign_style', $plugin['parent']);
  }
  return $parent_plugin;
}

/**
 * Convert a path to a ctools safe plugin name.
 *
 * @param $path
 *   The string from the URL alias.
 * @return
 *   The plugin (and variable) safe name.
 */
function dosomething_campaign_styles_pluginify_path($path) {
  $plugin_name = str_replace('/', '_', $path);
  $plugin_name = str_replace('-', '_', $plugin_name);
  return $plugin_name;
}

function dosomething_campaign_styles_block_info() {
  $blocks['campaign_nav'] = array(
    'info' => t('Campaign Navigation'),
    'weight' => -50,
    'status' => 1,
    'region' => 'sidebar_first',
    'cache' => DRUPAL_NO_CACHE,
    'properties' => array(
      'classes' => 'banana',
    ),
  );
  return $blocks;
}

function dosomething_campaign_styles_block_view($delta) {
  if ($context = og_context()) {
    if ($context->entity_type == 'node' && ($node = node_load($context->etid))) {
      $plugin_name = dosomething_campaign_styles_pluginify_path(drupal_get_path_alias('node/' . $context->etid));
      $plugin = ctools_get_plugins('dosomething_campaign_styles', 'campaign_style', $plugin_name);

      $campaign_links = $prefix = $suffix = $nav = array();
      if (!empty($plugin['menu'])) {
        foreach ($plugin['menu'] as $num => $link) {
          if (!isset($link['validate'])) {
            $link['href'] = drupal_lookup_path('source', $link['href']);
          }
          $campaign_links['campaign_nav_'.$num] = $link;
        }
        $nav = array(
          '#theme' => 'links',
          '#links' => $campaign_links,
          '#attributes' => array(
            'class' => 'menu',
          ),
        );
      }
      if (!empty($plugin['menu_prefix'])) {
        $prefix = array(
          '#type' => 'container',
          '#attributes' => array('class' => array('campaign-menu-prefix')),
          'content' => $plugin['menu_prefix'],
        );
      }
      if (!empty($plugin['menu_suffix'])) {
        $suffix = array(
          '#type' => 'container',
          '#attributes' => array('class' => array('campaign-menu-suffix')),
          'content' => $plugin['menu_suffix'],
        );
      }
      $block['content']['prefix'] = $prefix;
      $block['content']['nav'] = $nav;
      $block['content']['suffix'] = $suffix;
      return $block;
    }
  }
}

/**
 * Implements hook_og_context_negotiation_info().
 */
function dosomething_campaign_styles_og_context_negotiation_info() {
  $providers = array();
  $providers['campaign_panelizer'] = array(
    'name' => t('Campaign Panelizer'),
    'description' => t('Determine context by checking if there is context provided by something like panels or panelizer'),
    'callback' => 'dosomething_campaign_styles_og_context_panels',
  );
  $providers['campaign_forms'] = array(
    'name' => t('Campaign Forms'),
    'description' => t('Determine context for webform_entities whose parent form are a part of a campaign group'),
    'callback' => 'dosomething_campaign_styles_og_context_webform_submissions',
  );
  return $providers;
}

/**
 * OG context handler callback for panels.
 */
function dosomething_campaign_styles_og_context_panels() {
  $context = array();
  $item = menu_get_item();
  if (isset($item['map']) && is_array($item['map'])) {
    foreach ($item['map'] as $map) {
      if (is_object($map) && get_class($map) == 'ctools_context') {
        if ($map->plugin == 'entity:node') {
          $gid = og_get_group('node', $map->data->nid)->gid;
          $context[] = array($gid);
        }
      }
    }
  }
  return $context;
}

/**
 * OG context handler callback for webform submissions
 */
function dosomething_campaign_styles_og_context_webform_submissions() {
  $context = array();
  $item = menu_get_item();
  $content_types = array('campaign_report_back', 'campaign_sign_up');

  if (isset($item['map']) && is_array($item['map'])) {
    foreach ($item['map'] as $map) {
      if (is_object($map) && !isset($map->bundle) && isset($map->data->bundle)) {
        $map = $map->data;
      }
      if (is_object($map) && isset($map->bundle) && in_array($map->bundle, $content_types)) {
        $parent = node_load($map->nid);
        $context[] = array($parent->group_audience[LANGUAGE_NONE][0]['gid']);
      }
    }
  }
  return $context;
}

function dosomething_campaign_styles_theme() {
  $theme['ds_campaign_social'] = array(
    'variables' => array(
      'url' => NULL,
      'facebook_language' => NULL,
      'twitter_language' => NULL,
    ),
    'template' => 'templates/ds_campaign_social',
  );

  return $theme;
}
