<?php

/**
 * @file
 * Custom Pages for dosomething.
 */

define('CAUSE_VOCABULARY_MACHINE_NAME', 'vocabulary_5');

/**
 * Implements hook_menu().
 */
function dosomething_pages_menu() {
  $items['cause'] = array(
    'title callback' => 'dosomething_pages_causes_title',
    'page callback' => 'dosomething_pages_get_causes',
    'access callback' => TRUE,
  );
  return $items;
}

function dosomething_pages_causes_title() {
  $vocabulary = taxonomy_vocabulary_machine_name_load(CAUSE_VOCABULARY_MACHINE_NAME);
  $causes = taxonomy_get_tree($vocabulary->vid, $parent = 0, $max_depth = 1, $load_entities = FALSE);
  return t(count($causes) . ' Great Causes for You to Rock');
}

function dosomething_pages_get_causes() {
  global $base_url;
  drupal_add_js(drupal_get_path('module', 'dosomething_pages') . '/js/dosomething_causes_page_popups.js');
  //get taxonomy terms
  $cause_render_array = array();
  $vocabulary = taxonomy_vocabulary_machine_name_load(CAUSE_VOCABULARY_MACHINE_NAME);
  $causes = taxonomy_get_tree($vocabulary->vid, $parent = 0, $max_depth = 1, $load_entities = TRUE);
  foreach ($causes as $cause) {
    $child_causes_raw = taxonomy_get_tree($vocabulary->vid, $cause->tid, $max_depth = NULL, $load_entities = FALSE);
    $child_causes = array();
    foreach ($child_causes_raw as $child_cause) {
      $link_text = strtolower($cause->name . '/' . $child_cause->name);
      $link_text = str_replace(' ', '-', $link_text);
      $child_causes[] = l($child_cause->name, 'find-your-cause/' . $link_text);
    }
    if(!empty($cause->field_causes_image)) {
      $cause_image = $cause->field_causes_image[field_language('taxonomy_term', $cause, 'field_causes_image')][0]['uri'];
    }
    else {
      $cause_image = NULL;
    }
    if (module_exists('fb_social')) {
      $presets = fb_social_get_presets();
      $taxonomy_path = taxonomy_term_uri($cause);
      $facebook = fb_social_preset_view($presets['reccommend_cause'], $base_url . '/' . $taxonomy_path['path']);
    }
    else {
      $facebook = NULL;
    }
    $cause_data_to_render = array(
      'title'  => array(
        '#markup' => t($cause->name),
        '#prefix' => '<h2>',
        '#suffix' => '</h2>',
      ),
      'image' => array(
        '#theme' => 'image_style',
        '#style_name' => 'find_your_cause',
        '#path' => $cause_image,
      ),
      'description' => array(
        '#markup' => $cause->description,
        '#prefix' => '<p class="cause-description">',
        '#suffix' => '</p>',
      ),
     'pop up content' => array(
       'all issues' => array(
         '#markup' => 'All Issues',
          '#prefix' => '<h4>',
          '#suffix' => '</h4>',
        ),
        'all issues link' => array(
          '#markup' => l('Go', 'find-your-cause/' . str_replace(' ', '-', strtolower($cause->name))),
        ),
        'children' => array(
          '#theme' => 'item_list',
          '#items' => $child_causes,
          '#type' => 'ul',
        ),
        'facebook' => array(
          '#markup' => $facebook,
        ),
        '#prefix' => '<div class="cause-item-pop-up-content">',
        '#suffix' => '</div>',
      ),
      '#prefix' => '<div class="cause-item">',
      '#suffix' => '</div>',
    );
    $cause_render_array[] = $cause_data_to_render;
  }
  return $cause_render_array;
}

