<?php

/**
 * @file
 * Custom functionality relating to user registration and login.
 */

/**
 * Implements hook_menu().
 */
function dosomething_login_menu() {
  $items = array();
  $items['user/registration/fb'] = array(
    'title' => 'Registration',
    'description' => 'Register through your Facebook account.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('dosomething_login_register_facebook'),
    'access callback' => 'user_register_access',
    'type' => MENU_CALLBACK,
  );
  $items['user/registration'] = array(
    'title' => 'Registration',
    'description' => 'Sign up URL to which mobile commons submits sign up requests to us.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('dosomething_login_register_popup_form'),
    'access callback' => 'user_register_access',
    'type' => MENU_CALLBACK,
  );
  $items['user/registration/ajax'] = array(
    'page callback' => 'dosomething_login_ajax',
    'access callback' => 'user_register_access',
    'type' => MENU_CALLBACK,
  );
  $items['dosomething/under-13/permission/%/%/%'] = array(
    'title' => 'Parental Permission',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('dosomething_login_parent_permission_page', 3, 4, 5),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  $items['dosomething/under-13/parent-consent-email'] = array(
    'title' => 'Parental Permission',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('dosomething_login_parent_permission_email_form'),
    'access callback' => 'dosomething_parent_consent_email_access',
    'type' => MENU_CALLBACK,
  );
  $items['dosomething/ajax/registration-data'] = array(
    'title' => 'Registration Data',
    'page callback' => 'dosomething_login_registration_data_page',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  $items['access-denied'] = array(
    'title' => 'Access Denied',
    'page callback' => 'dosomething_login_access_denied_page',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Implements hook_menu_alter().
 */
function dosomething_login_menu_alter(&$items) {
  // Remove the default user registration page in favor of our custom registration.
  unset($items['user/register']);
}

/**
 * Implements hook_block_info().
 */
function dosomething_login_block_info() {
  $blocks['become_member'] = array(
    'info' => t('Become a Member'),
    'cache' => DRUPAL_NO_CACHE,
  );
  $blocks['register_block'] = array(
    'info' => t('User registration block'),
    'cache' => DRUPAL_NO_CACHE,
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function dosomething_login_block_view($delta = '') {
  $block = array();
  switch ($delta) {
    case 'become_member':
      global $user;
      if (!$user->uid) {
        if (arg(0) == 'node' && is_numeric(arg(1))) {
          $node = node_load(arg(1));
        }
        if ((arg(0) != 'user' || arg(1) != 'registration') &&
            (!isset($node) || $node->type != 'campaign_sign_up')) {
          $block['subject'] = t('Become a Member');
          $block['content'][] = drupal_get_form('dosomething_login_register_block');
          $block['content'][] = drupal_get_form('dosomething_login_register_popup_form');
        }
      }
      else if (module_exists('dosomething_user_my_somethings')) {
        // TODO: This should go in dosomething_user_my_somethings module
        // but we will have to redo a bunch of theming to get that working.
        $block['content'] = dosomething_user_my_somethings_member_block();
      }
      break;
    case 'register_block':
      global $user;
      if (!$user->uid) {
        drupal_add_js(drupal_get_path('module', 'dosomething_login') . '/js/dosomething-login-registration.js');
        drupal_add_js(drupal_get_path('module', 'dosomething_login') . '/js/dosomething-login-registration-block.js');
        drupal_add_css(drupal_get_path('module', 'dosomething_login') . '/css/dosomething-login-registration-block.css');
        $form = drupal_get_form('dosomething_login_register_popup_form');
        unset($form['final_submit']);
        $block['subject'] = t('Register for an account');
        $block['content'] = $form;
      }
      break;
  }
  return $block;
}

/**
 * Implements hook_mail().
 */
function dosomething_login_mail($key, &$message, $params) {
  switch ($key) {
    case 'dosomething-parent-email':
      $params['full_name'] = dosomething_login_get_user_full_name($params['account']);
      $params['link'] = dosomething_login_one_time_parent_permission_link($params['account']);
      $message['subject'] = t('Permissions for @name', array('@name' => $params['full_name']));
      $message['body'][] = drupal_html_to_text(theme('dosomething_login_parent_email', $params));
      $message['headers']['Content-Type'] = 'text/html; charset=utf-8';
      break;
    case 'dosomething-parent-permission-granted-email':
      $params['full_name'] = dosomething_login_get_user_full_name($params['account']);
      $message['subject'] = t('Permission Granted');
      $message['body'][] = drupal_html_to_text(theme('dosomething_login_parent_permission_granted_email', $params));
      $message['headers']['Content-Type'] = 'text/html; charset=utf-8';
      break;
    case 'dosomething-parent-permission-denied-email':
      $params['full_name'] = dosomething_login_get_user_full_name($params['account']);
      $message['subject'] = t('Permission Denied');
      $message['body'][] = drupal_html_to_text(theme('dosomething_login_parent_permission_denied_email', $params));
      $message['headers']['Content-Type'] = 'text/html; charset=utf-8';
      break;
  }
}

/**
 * Implements hook_theme().
 */
function dosomething_login_theme($existing, $type, $theme, $path) {
  return array(
    'dosomething_login_member_lightbox' => array(
      'path' => $path . '/templates',
      'variables' => array(),
      'template' => 'dosomething-login-member-lightbox',
    ),
    'dosomething_login_parent_email' => array(
      'path' => $path . '/templates',
      'variables' => array('full_name' => NULL, 'link' => NULL),
      'template' => 'dosomething-login-parent-email',
    ),
    'dosomething_login_parent_permission_granted_email' => array(
      'path' => $path . '/templates',
      'variables' => array('full_name' => NULL),
      'template' => 'dosomething-login-parent-permission-granted-email',
    ),
    'dosomething_login_parent_permission_denied_email' => array(
      'path' => $path . '/templates',
      'variables' => array('full_name' => NULL),
      'template' => 'dosomething-login-parent-permission-denied-email',
    ),
    'dosomething_login_form_required_marker' => array(
      'variables' => array(),
    ),
    'theme_dosomething_login_facebook_user_info' => array(
      'variables' => array('account' => NULL),
    ),
  );
}

/**
 * Implements hook_theme_registry_alter().
 */
function dosomething_login_theme_registry_alter(&$vars) {
  $path =  drupal_get_path('module', 'dosomething_login');
  $vars['fboauth_user_info']['theme_path'] = $path;
  $vars['fboauth_user_info']['function'] = 'theme_dosomething_login_facebook_user_info'; 
}

/**
 * Implements hook_cron().
 */
function dosomething_login_cron() {
  // TODO: Only run every few hours?
  dosomething_login_update_accounts_under_13();
  dosomething_login_clear_old_accounts();
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function dosomething_login_form_user_profile_form_alter(&$form, &$form_state) {
  global $user;
  if (!dosomething_login_user_has_parental_consent($user->uid)) {
    // Note: Give a user parental consent if they are over 13
    // so that they don't get stuck not being able to edit their
    // account by changing their birthdate.
    dosomething_login_set_parental_consent_message();
    drupal_goto('user');
  }
  // Add custom validation to this form.
  $form['#validate'][] = 'dosomething_login_profile_form_validate';
}

/**
 * Implements hook_form_alter().
 */
function dosomething_login_form_alter(&$form, &$form_state, $form_id) {
  if (isset($form['#node']) && strpos($form_id, 'webform_client_form_') === 0) {
    $node_types = array(
      'campaign_report_back',
      'campaign_sign_up',
      'grant_application',
      'scholarship_application',
      'action_guide',
      'project_report',
    );
    // Users without parental consent should be able to see this
    // but not be able to do anything with it.
    if (in_array($form['#node']->type, $node_types)) {
      global $user;
      if (!dosomething_login_user_has_parental_consent($user->uid)) {
        dosomething_login_set_parental_consent_message();
        drupal_goto();
      }
    }
  }
  else if (in_array($form_id, array('user_login', 'user_login_block'))) {
    // Our login validation function must run first.
    $form['#validate'] = is_array($form['#validate']) ? $form['#validate'] : array();
    array_unshift($form['#validate'],'dosomething_login_user_login_validate');
    $form['name']['#title'] = t('Email, Username or Cell Number');
    $form['name']['#description'] = t('Enter your email, username or cell phone number.');
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function dosomething_login_form_user_pass_alter(&$form, &$form_state) {
  unset($form['#validate']);
  $form['#validate'] = array('dosomething_login_sms_password_recovery_validate');
  $form['#submit'] = array('dosomething_login_sms_password_recovery_submit');
}

/**
 * Validation function for resetting passwords that adds mobile phone based
 * signup reset capabilities.
 */
function dosomething_login_sms_password_recovery_validate(&$form, &$form_state) {
  // Assume we do not want to send a SMS text.
  $form_state['send_sms_reset'] = FALSE;

  // Code pilfered from user_pass_validate in user.pages.inc
  $name = trim($form_state['values']['name']);
  // Try to load by email.
  $users = user_load_multiple(array(), array('mail' => $name, 'status' => '1'));
  $account = reset($users);
  if (!$account) {
    // No success, try to load by name.
    $users = user_load_multiple(array(), array('name' => $name, 'status' => '1'));
    $account = reset($users);
  }

  // If we have an account return.
  if ($account) {
    return TRUE;
  }
  else {
    //Okay, maybe they gave us an mobile number. We can handle that.
    $numeric_name = preg_replace('/\D/', '', $name);
    $mobile = $numeric_name . '@mobile';
    $users = user_load_multiple(array(), array('mail' => $mobile, 'status' => '1'));
    $account = reset($users);
  }
  if (isset($account->uid)) {
    // Send a text message with the reset password.
    $form_state['send_sms_reset'] = TRUE;
    form_set_value(array('#parents' => array('account')), $account, $form_state);
  }
  //TODO: check again to see if the number was supplied as xxx-xxx-xxxx rather than 5551114444.
  else {
    form_set_error('name', t('Sorry, %name is not recognized as a user name, e-mail address, or mobile number.', array('%name' => $name)));
  }
}

/**
 * Submition handler for resetting passwords that adds mobile phone based
 * signup reset capabilities.
 */
function dosomething_login_sms_password_recovery_submit($form, &$form_state) {
  // Check the incoming form state. If send_sms_reset is false then do what
  // we do normally.
  if (!isset($form_state['send_sms_reset']) || !$form_state['send_sms_reset']) {
    user_pass_submit($form, $form_state);
    return;
  }
  else {
    $account = isset($form_state['values']['account']->uid) ? $form_state['values']['account'] : NULL;
    if(!is_null($account)) {
      require_once DRUPAL_ROOT . '/' . variable_get('password_inc', 'includes/password.inc');
      $reset_link = user_pass_reset_url($account);
      $pass = user_password(6);
      $hashed_pass = user_hash_password($pass);
      $user = user_load($account->uid);
      $user->pass = $hashed_pass;
      user_save($user);
      $number = preg_replace('/\D/', '', trim($form_state['values']['name']));
      //TODO FOR LAUNCH!!!! remove comment on the following line and delete the test line after it.
      //$message = "Your DoSomething password is now " . $pass . " or log right in with: " . $reset_link;
      $message = "TEST Your DS password is now " . $pass . " or log in with: " . $reset_link;
      $response = sms_mobile_commons_send($number, $message, $options = array());
      watchdog('SMS', 'A user with the mobile number of %number asked for a password reset. The text message user validation response was "%validation" and the message sending status was "%message"', 
        array('%number' => $number, '%validation' => $response['validation'], '%message' => $response['message']),
        $severity = WATCHDOG_NOTICE,
        $link = NULL
      );
      drupal_set_message(t('Thanks for playing. A text message with reset instructions has been sent to your mobile phone.'));
    }
  }
}

/**
 * Implements hook_element_info().
 */
function dosomething_login_element_info() {
  $types = array();
  $types['dosomething_password_confirm'] = array(
    '#input' => TRUE,
    '#process' => array('dosomething_login_dosomething_password_confirm'),
    '#theme_wrappers' => array('form_element'),
    '#element_validate' => array('password_confirm_validate'),
  );
  return $types;
}

/**
 * Process a form element of type dosomething_password_confirm.
 */
function dosomething_login_dosomething_password_confirm($element) {
  // The normal password confirm sets a title and doesn't let you add
  // attributes or edit the title.

  // This removes the title of the confirm password and adds placeholders.
  $element = form_process_password_confirm($element);
  unset($element['pass2']['#title']);
  $element['pass1']['#attributes']['placeholder'] = t('Password');
  return $element;
}

/**
 * Custom validation for user login form
 *
 */
function dosomething_login_user_login_validate($form, &$form_state) {
  // Note: Taken from logintoboggan module
  // Allow users to login with email address and cell phone number
  if (isset($form_state['values']['name']) && $form_state['values']['name']) {
    if ($name = dosomething_login_find_user_by_email($form_state['values']['name'])) {
      form_set_value($form['name'], $name, $form_state);
    }
    // TODO: Only remove spaces, parentheses and dashes in regex
    else if (($number = ltrim(preg_replace('/[^0-9]/', '', $form_state['values']['name']), 1)) && strlen($number) >= 10) {
      if ($name = dosomething_login_find_user_by_cell($number)) { 
        form_set_value($form['name'], $name, $form_state);
      }
    }
  }
}

/**
 * Find a user by email address (this isn't much different from core user_load_by_mail,
 * which calls user_load_multiple(array(), array('mail' => $mail));
 */
function dosomething_login_find_user_by_email($email) {
  return db_query("SELECT name FROM {users} WHERE LOWER(mail) = LOWER(:name)", array(
      ':name' => $email,
    ))->fetchField();
}

/**
 * Custom validation for user_profile_form
 */
function dosomething_login_profile_form_validate($form, &$form_state) {
  // Verify that this is a unique cell phone number.
  $profile = isset($form_state['profiles']['main']) ? $form_state['profiles']['main'] : NULL;
  if (isset($form_state['values']['profile_main']['field_user_mobile'][LANGUAGE_NONE][0]['value'])) {
    $entered_number = $form_state['values']['profile_main']['field_user_mobile'][LANGUAGE_NONE][0]['value'];
    $number = ltrim(preg_replace('/[^0-9]/', '', $entered_number), 1);
    if (strlen($number) >= 10) {

      // @see dosomething_login_find_user_by_cell
      // Not all of the values in the db are digits only, so we have to
      // replace the the non-digits in the values that we're searching.
      // We may have to use this check elsewhere.  If so, we can break
      // it out into a separate function.
      $replace_characters = array('+', '.', '-', ' ', ')', '(');
      $replace = "m.field_user_mobile_value";
      foreach ($replace_characters as $char) {
        $replace = "REPLACE(" . $replace . ", '$char', '')";
      }

      $query = db_select('field_data_field_user_mobile', 'm')
        ->fields('m', array('entity_id'))
        ->condition('m.entity_type', 'profile2')
        ->where("$replace = :number", array(':number' => $number));
      if (is_object($profile)) {
        $query->condition('m.entity_id', $profile->pid, '!=');
      }
      if ($pid = $query->execute()->fetchField()) {
        $current_number = dosomething_login_get_cell_phone_number($form['#user'], $profile);
        // If the number is already in use by this user, then don't
        // enforce uniqueness.  Currently the values are not all unique.
        if ($current_number != $number) {
          form_set_error('profile_main][field_user_mobile][' . LANGUAGE_NONE . '][0', t('The provided cell phone number is already in use by another account.'));
        }
      }
      // Save the version of the phone with only digits.
      $form_state['values']['profile_main']['field_user_mobile'][LANGUAGE_NONE][0]['value'] = $number;
    }
    else if ($entered_number) {
      form_set_error('profile_main][field_user_mobile][' . LANGUAGE_NONE . '][0', t('%phone is not a valid cell phone number.', array('%phone' => $entered_number)));
    }
  }
}

/**
 * Search for users users by their cell phone number.
 *
 * @param $number
 *  (string) The cell phone number for which you are searching.
 * @return
 *  The username or FALSE if not found.
 */
function dosomething_login_find_user_by_cell($number) {
  if ($name = db_select('users')->fields('users', array('name'))->condition('mail', db_like($number . '@mobile'), 'LIKE')->range(0, 1)->execute()->fetchField()) {
    return $name;
  }
  else if ($name = _dosomething_login_find_user_by_cell_helper($number)) {
    // Note: Cell phone numbers are not unique amongst the existing users.
    // otherwise, we can directly search for the cell phone number when
    // logging in. Existing users will have usernames and email addresses
    // so this won't prevent them from logging in.
    return $name;
  }
  return false;
}

function _dosomething_login_find_user_by_cell_helper($number) {
  // Not all of the values in the db are digits only, so we have to
  // replace the the non-digits in the values that we're searching.
  // We may have to use this check elsewhere.  If so, we can break
  // it out into a separate function.
  $number = ltrim(preg_replace('/[^0-9]/', '', $number), 1);
  $replace_characters = array('+', '.', '-', ' ', ')', '(');
  $replace = "m.field_user_mobile_value";
  foreach ($replace_characters as $char) {
    $replace = "REPLACE(" . $replace . ", '$char', '')";
  }

  $query = db_select('field_data_field_user_mobile', 'm');
  $query->innerJoin('profile', 'p', 'm.entity_id = p.pid');
  $query->innerJoin('users', 'u', 'u.uid = p.uid');
  $result = $query->fields('u', array('name'))
    ->condition('m.entity_type', 'profile2')
    ->where("$replace = :number", array(':number' => $number))
    ->execute();
  return $result->fetchField();
}

/**
 * The form for the 'Become a Member' block.
 */
function dosomething_login_register_popup_form($form, &$form_state) {
  // we want to cache this form, because we'll be using ajax_get_form, which requires that the form be secure
  $fb_link = fboauth_action_link_properties('prereg');
  $fb_url = url($fb_link['href'], array('query' => $fb_link['query']));
  $form_state['cache'] = true;
  $form['#validate'][] = 'dosomething_login_register_block_validate';
  $form['#submit'][] = 'dosomething_login_register_block_submit';
  $form['#attached'] = array(
    'js' => array(
      drupal_get_path('module', 'dosomething_login') . '/js/dosomething-login-registration.js',
      array(
        'data' => array(
          'dosomethingLogin' => array(
              'dsApiKey' => variable_get('dosomething_login_api_key', '8hSyfEZIeBrlcgrdM6QbS63F6NjUvgqQ'),
          ),
        ),
        'type' => 'setting',
      ),
    ),
  );

  $query = drupal_get_destination();
  $query['destination'] = $query['destination'] == 'user/registration' ? 'front' : $query['destination'];
  $form['#action'] = url($_GET['q'], array('query' => drupal_get_destination()));
  $form['#action'] = url('user/registration', array('query' => $query));

  $form['title_text'] = array(
    '#type' => 'item',
    '#title' => t("You’re Almost There"),
  );
  $form['#action'] = url('user/registration', array('query' => $query));
  $form['connect'] = array(
    '#type' => 'container',
    '#attributes' => array(
      'class' => array(
        'connect-with-facebook',
      ),
    ),
    '#children' => l('Connect with Facebook', $fb_url),
  );
  $form['or'] = array(
    '#type' => 'container',
    '#attributes' => array(
      'class' => array(
        'separator',
      ),
    ),
    '#children' => t('or'),
  );
  $form['name'] = array(
    'first_name' => array(
      '#type' => 'textfield',
      '#attributes' => array(
        'placeholder' => t('First Name'),
        'class' => array('dosomething-original-value'),
      ),
      '#size' => 9,
      '#required' => TRUE,
      '#suffix' => theme('dosomething_login_form_required_marker', array()),
    ),
    'last_name' => array(
      '#type' => 'textfield',
      '#attributes' => array(
        'placeholder' => t('Last Name'),
        'class' => array('dosomething-original-value'),
      ),
      '#size' => 9,
      '#required' => TRUE,
      '#suffix' => theme('dosomething_login_form_required_marker', array()),
    ),
  );
  $form['email'] = array(
    '#type' => 'textfield',
    '#attributes' => array(
      'placeholder' => t('Email'),
    ),
    '#size' => 20,
    '#suffix' => theme('dosomething_login_form_required_marker', array()),
  );
  $form['cell'] = array(
    '#type' => 'textfield',
    '#attributes' => array(
      'placeholder' => t('Cell'),
    ),
    '#size' => 20,
    '#suffix' => theme('dosomething_login_form_required_marker', array()),
  );

  // TODO: Shoould now be a textfield.
  // TODO: Needs validation.
  $form['pass'] = array(
    '#type' => 'password',
    '#required' => TRUE,
    '#attributes' => array(
      'placeholder' => t('Password'),
    ),
    '#size' => 15,
  );
  $form['birthday'] = array(
    'month' => array(
      '#field_prefix' => t('Birthday'),
      '#type' => 'textfield',
      '#attributes' => array(
        'placeholder' => t('mm'),
      ),
      '#size' => 2,
      '#maxlength' => 2,
    ),
    'day' => array(
      '#type' => 'textfield',
      '#attributes' => array(
        'placeholder' => t('dd'),
      ),
      '#size' => 2,
      '#maxlength' => 2,
    ),
    'year' => array(
      '#type' => 'textfield',
      '#attributes' => array(
        'placeholder' => t('yyyy'),
      ),
      '#size' => 4,
      '#maxlength' => 4,
      '#suffix' => theme('dosomething_login_form_required_marker', array()),
    ),
  );

  $form['parent_email_message'] = array(
    '#type' => 'item',
    '#title' => t('What a Rock Star!'),
    '#description' => t("Since you're under the age of 13, you'll need to get a parent or guardian's permission."),
    '#prefix' => '<div class="under-13-field">',
  );
  $form['parent_email'] = array(
    '#type' => 'textfield',
    '#attributes' => array(
      'placeholder' => t("Parent or Guardian's Email"),
    ),
    '#suffix' => theme('dosomething_login_form_required_marker', array()) . '</div>',
    '#size' => 20,
  );


  $form['signup'] = array(
    '#type' => 'item',
    '#description' => t("Clicking “Finish” won't sell your soul, but it means you agree to<br />our <a href='/about/privacy'>terms of service</a> and want to receive our weekly update."),
    '#prefix' => '<div class="disclaimer">',
    '#suffix' => '</div>',
  );
  $form['final_submit'] = array(
    '#prefix' => '<div class="ds-login-popup-footer">',
    '#suffix' => '</div>',
    '#type' => 'submit',
    '#value' => t('Finish'),
  );
  $form['user'] = array(
    '#theme' => 'link',
    '#path' => 'user',
    '#prefix' => '<span class="already-member">already a member? ',
    '#suffix' => '</span>',
    '#text' => t("log in"),
    '#options' => array(
      'attributes' => array('class' => array('or-sign-in')),
      'html' => FALSE,
    ),
  );
  return $form;
}

/**
 * The form for the 'Become a Member' block.
 */
function dosomething_login_register_block($form, &$form_state) {
  $form['#attached'] = array(
    'js' => array(
      drupal_get_path('module', 'dosomething_login') . '/js/jquery-validation-1.9.0/jquery.validate.min.js',
      drupal_get_path('module', 'dosomething_login') . '/js/dosomething-login-registration-popup-lightbox.js',
    ),
    'library' => array(array('system', 'ui.dialog')),
  );

  $query = drupal_get_destination();
  $query['destination'] = $query['destination'] == 'user/registration' ? 'front' : $query['destination'];
  $form['why'] = array(
    '#theme' => 'link',
    '#path' => 'why-become-a-member',
    '#text' => t("Why become a member?"),
    '#options' => array(
      'attributes' => array('class' => array('why')),
      'html' => FALSE,
    ),
  );
  $form['#action'] = url('user/registration', array('query' => $query));

  $form['name'] = array(
    'first_name' => array(
      '#type' => 'textfield',
      '#attributes' => array(
        'placeholder' => t('First Name'),
      ),
      '#size' => 9,
    ),
    'last_name' => array(
      '#type' => 'textfield',
      '#attributes' => array(
        'placeholder' => t('Last Name'),
      ),
      '#size' => 9,
    ),
  );
  $form['cell_or_email'] = array(
    '#type' => 'textfield',
    '#attributes' => array(
      'placeholder' => t('Cell or email'),
    ),
    '#size' => 20,
  );
  $form['first_submit'] = array(
    '#type' => 'submit',
    '#value' => t('Go'),
    '#attributes' => array('class' => array('submit')),
  );
  $form['user'] = array(
    '#theme' => 'link',
    '#path' => 'user',
    '#text' => t("or sign in"),
    '#options' => array(
      'attributes' => array('class' => array('or-sign-in')),
      'html' => FALSE,
    ),
  );
  return $form;
}

/**
 * Validate the user registration form.
 */
function dosomething_login_register_block_validate($form, &$form_state) {
  $values = $form_state['values'];
  if (strlen($form_state['values']['pass']) < 6) {
    form_set_error('pass', t('Your password must be at least 6 characters long.'));
  }
  $form_state['values']['birthdate'] = mktime(0, 0, 0, $values['month'], $values['day'], $values['year']);
  if (!is_numeric($values['month']) || $values['month'] > 12) {
    form_set_error('month', t('Please provide a valid numeric month for your birthday.'));
    $invalid_birthday = TRUE;
  }
  if (!is_numeric($values['day']) || $values['month'] > 31) {
    form_set_error('day', t('Please provide a valid day for your birthday.'));
    $invalid_birthday = TRUE;
  }
  if (!is_numeric($values['year']) || strlen($values['year']) != 4) {
    form_set_error('year', t('Please provide the 4-digit year you were born.'));
    $invalid_birthday = TRUE;
  }
  if (!isset($invalid_birthday)) {
    if (!dosomething_login_person_is_over_age($form_state['values']['birthdate'], 13)) {
      if (!isset($form_state['values']['parent_email']) || !valid_email_address($form_state['values']['parent_email'])) {
        form_set_error('parent_email', t('Please provide a valid parental email address.'));
      }
    }
  }

  if (!$values['first_name']) {
    form_set_error('first_name', t('Please provide your first name.'));
  }
  if (!$values['last_name']) {
    form_set_error('last_name', t('Please provide your last name.'));
  }
  // Validate cell number or e-mail address
  if (valid_email_address($values['email'])) {
    if (db_select('users')->fields('users', array('uid'))->condition('mail', db_like($values['email']), 'LIKE')->range(0, 1)->execute()->fetchField()) {
      form_set_error('email', t('The e-mail address %email is already registered. <a href="@password">Have you forgotten your password?</a>', array('%email' => $values['email'], '@password' => url('user/password'))));
    }
    $form_state['values']['mail'] = $values['email'];
  }
  if (($number = ltrim(preg_replace('/[^0-9]/', '', $values['cell']), 1)) && strlen($number) >= 10) {
    if (db_select('field_data_field_user_mobile')->fields('field_data_field_user_mobile', array('entity_id'))->condition('field_user_mobile_value', db_like($number), 'LIKE')->range(0, 1)->execute()->fetchField()) {
      form_set_error('cell', t('The phone number %phone is already registered. <a href="@password">Have you forgotten your password?</a>', array('%phone' => $values['cell'], '@password' => url('user/password'))));
    }
    else if (db_select('users')->fields('users', array('uid'))->condition('mail', db_like($number . '@mobile'), 'LIKE')->range(0, 1)->execute()->fetchField()) {
      form_set_error('cell', t('The phone number %phone is already registered. <a href="@password">Have you forgotten your password?</a>', array('%phone' => $values['cell'], '@password' => url('user/password'))));
    }
    $form_state['values']['phone'] = $number;
    $form_state['values']['mail'] = $number . '@mobile';
  }
  if (!$values['email'] && !$values['cell']) {
    form_set_error('email', t('Please provide a valid email address'));
    form_set_error('cell', t('or provide a valid cell phone number.'));
  }
}

/**
 * Submit the user registration form.
 */
function dosomething_login_register_block_submit($form, &$form_state) {
  $values = $form_state['input'];
  $birthdate = $form_state['values']['birthdate'];
  $name = preg_replace('/[^A-Za-z.]+/', '', $values['first_name']) . ' ' . preg_replace('/[^A-Za-z.]+/', '', $values['last_name']);
  $form_state['values']['name'] = dosomething_login_unique_name($name);
  $form_state['values']['init'] = $name;
  if (empty($form_state['values']['pass'])) {
    $form_state['values']['pass'] = user_password();
  }
  // Remove unneeded values.
  form_state_values_clean($form_state);

  $account = drupal_anonymous_user();
  $edit = array_intersect_key((array) $account, $form_state['values']);
  $edit['pass'] = $form_state['values']['pass'];
  entity_form_submit_build_entity('user', $account, $form, $form_state);

  // Determine the user's role by their age.
  if (dosomething_login_person_is_over_age($birthdate, 26)) {
    $role_name = 'old person';
  }
  else if (!dosomething_login_person_is_over_age($birthdate, 13)) {
    $role_name = 'pending member';
  }
  else {
    $role_name = 'member';
  }
  $account->status = 1;
  $role = user_role_load_by_name($role_name);
  $account->roles[$role->rid] = $role->name;
  $account = user_save($account, $edit);
  // Terminate if an error occurred during user_save().
  if (!$account) {
    drupal_set_message(t("Error saving user account."), 'error');
    $form_state['redirect'] = '';
    return;
  }
  // Save profile data.
  $profile = new stdClass();
  $profile->type = 'main';
  $profile->uid = $account->uid;
  drupal_write_record('profile', $profile);
  $profile->field_user_first_name[LANGUAGE_NONE][0]['value'] = $values['first_name'];
  $profile->field_user_last_name[LANGUAGE_NONE][0]['value'] = $values['last_name'];
  $birthday = new DateObject($birthdate);
  $time = $birthday->format(DATE_FORMAT_DATETIME);
  $profile->field_user_birthday[LANGUAGE_NONE][0]['value'] = $time;
  $profile->field_user_is_over13[LANGUAGE_NONE][0]['value'] = (int) dosomething_login_person_is_over_age($birthdate, 13);
  if ($values['signup']) {
    $profile->field_user_newsletter_optin[LANGUAGE_NONE][0]['value'] = 1;
  }
  if (isset($form_state['values']['phone'])) {
    $profile->field_user_mobile[LANGUAGE_NONE][0]['value'] = $form_state['values']['phone'];
  }
  field_attach_insert('profile2', $profile);
  $form_state['uid'] = $account->uid;
  if (isset($account->mail) && $account->status) {
    _user_mail_notify('register_no_approval_required', $account);
  }
  else {
    // TOOD: verify cell number via SMS.
  }

  if (!dosomething_login_person_is_over_age($birthdate, 13)) {
    if (isset($values['parent_email'])) {
      global $language;
      $params = array('account' => $account);
      drupal_mail('dosomething_login', 'dosomething-parent-email', $values['parent_email'], $language, $params);
      drupal_set_message(t('An email has been sent to %email for parental permission.', array('%email' => $values['parent_email'])));
    }
  }
  // After they are saved, save their fbuid with their uid if they registered
  // through Facebook.
  if (isset($_SESSION['fbuser'])) {
    fboauth_save($account->uid, $_SESSION['fbuser']->id);
    unset($_SESSION['fbuser']);
  }
  // Log user in.
  if ($account->status) {
    user_login_submit(array(), $form_state);
  }

  // Clear any logged registration data.
  $query = db_delete('ds_registration_data');
  if (isset($form_state['values']['phone'])) {
    $query->condition('cell', $form_state['values']['phone']);
  }
  else {
    $query->condition('email', $account->mail);
  }
  $num_deleted = $query->execute();
}

/**
 * Generate a unique username.
 */
function dosomething_login_unique_name($name, $i = '') {
  if (db_select('users')->fields('users', array('uid'))->condition('name', db_like($name . $i), 'LIKE')->range(0, 1)->execute()->fetchField()) {
    if ($i === '') {
      $i = 0;
    }
    else {
      $i++;
    }
    return dosomething_login_unique_name($name, $i);
  }
  else {
    return $name . $i;
  }
}

/**
 * Returns HTML for a marker for required form elements.
 *  Copied from theme_form_required_marker to allow different class.
 *
 * @param $variables
 *   An associative array containing:
 *   - element: An associative array containing the properties of the element.
 *
 * @ingroup themeable
 */
function theme_dosomething_login_form_required_marker($variables) {
  $t = get_t();
  $attributes = array(
    'class' => array('ds-registration-form-required', 'form-required'),
    'title' => $t('This field is required.'),
  );
  return '<span' . drupal_attributes($attributes) . '>*</span>';
}

/**
 * Determine if a drupal user is over the given age.
 *  If no birthday is set, the default answer is no.
 *
 * @param $uid
 *  (int) numeric id of drupal user.
 * @return @boolean
 */
function dosomething_login_drupal_user_is_over_age($uid, $age = 13, $end_timestamp = NULL) {
  $account = user_load($uid);
  $profile = profile2_load_by_user($account, 'main');
  if (is_object($profile)) {
    $birthday = field_get_items('profile2', $profile, 'field_user_birthday');
    if (isset($birthday[0]['value'])) {
      // this is only a a time (no time) so timezone is not important.
      $timestamp = strtotime($birthday[0]['value']);
      return dosomething_login_person_is_over_age($timestamp, $age, $end_timestamp);
    }
  }
  return FALSE;
}

/**
 * Check if a user is over the given age.
 *
 * @param $birthday
 *  (int) timestamp of birthday.
 * @param $age
 *  (int) the age to check.
 * @param $timestamp
 *  (int) the time at which to check the age. Defaults to current time.
 * @return @boolean
 */
function dosomething_login_person_is_over_age($birthday, $age = 13, $timestamp = NULL) {
  $timestamp = is_null($timestamp) ? REQUEST_TIME : $timestamp;
  return $birthday < strtotime(sprintf("-%d year", $age), $timestamp);
}

/**
 * Mark a user as being over 13.
 *  They don't need parental permission at this point.
 */
function dosomething_login_mark_user_account_over_13($uid) {
  $account = user_load($uid);
  $profile = profile2_load_by_user($account, 'main');
  if (is_object($profile)) {
    $birthday = field_get_items('profile2', $profile, 'field_user_birthday'); 
    $profile->field_user_is_over13[LANGUAGE_NONE][0]['value'] = 1;
    profile2_save($profile);
  }
}

/**
 * Get a user's full name from their main profile.
 */
function dosomething_login_get_user_full_name($account) {
  $full_name = '';
  $names = array();
  $profile = profile2_load_by_user($account, 'main');
  if (is_object($profile)) {
    foreach (array('field_user_first_name', 'field_user_last_name') as $field) {
      $stored_names = field_get_items('profile2', $profile, $field);
      if (isset($stored_names[0]['safe_value'])) {
        $names[] = $stored_names[0]['safe_value'];
      }
    }
    $full_name = implode(' ', $names);
  }
  return $full_name;
}

/**
 * Retrieve a user's cell phone number from their profile.
 */
function dosomething_login_get_cell_phone_number($account, $profile = NULL) {
  $number = FALSE;
  if (is_null($profile)) {
    $profile = profile2_load_by_user($account, 'main');
  }
  if (is_object($profile)) {
    $numbers = field_get_items('profile2', $profile, 'field_user_mobile');
    $number = isset($numbers[0]['value']) ? ltrim(preg_replace('/[^0-9]/', '', $numbers[0]['value']), 1) : FALSE;
  }
  return $number;
}

/**
 * Determine if user has parentel consent to use this site.
 *  If they are over 13, then they don't need it.
 */
function dosomething_login_user_has_parental_consent($uid) {
  $account = user_load($uid);
  if (dosomething_login_drupal_user_is_over_age($uid, 13)) {
    return TRUE;
  }
  // Don't lock out admins
  if (in_array('administrator', $account->roles)) {
    return TRUE;
  }
  if (!in_array('pending member', $account->roles)) {
    return TRUE;
  }
  return FALSE;
}

/**
 * Set a message indicating that s user cannot perform an action
 *  until the have been given consent by a parent.
 */
function dosomething_login_set_parental_consent_message() {
  // TODO: Some link to ask for parental consent
  drupal_set_message(t('Before you can perform this action, you must have parental consent. You can send a request to your parent or legal guardian <a href="@link"> here</a>.', array('@link' => '/dosomething/under-13/parent-consent-email')), 'warning');
}

/**
 * Determine access to parental consent email request form.
 */
function dosomething_parent_consent_email_access() {
  global $user;
  return !dosomething_login_user_has_parental_consent($user->uid);
}

/**
 * Form for a person under 13 to request their parent's permission
 *  to use the site.
 */
function dosomething_login_parent_permission_email_form($form, &$form_state, $uid = NULL) {
  if (is_null($uid)) {
    global $user;
    $uid = $user->uid;
  }
  $form['parent_email'] = array(
    '#title' => t('Parent or Guardian Email Address'),
    '#type' => 'textfield',
    '#size' => 20,
  );
  $form['uid'] = array(
    '#type' => 'value',
    '#value' => $uid,
  );
  $form['submit_email'] = array(
    '#type' => 'submit',
    '#value' => t('Send Email'),
  );
  return $form;
}

/**
 * Validation callback for parent permission email form.
 */
function dosomething_login_parent_permission_email_form_validate($form, &$form_state) {
  $email = $form_state['values']['parent_email'];
  if (!valid_email_address($email)) {
    form_set_error('parent_email', t('you must provide a valid email address'));
  }
}

/**
 * Submission callback for parent permission email form.
 */
function dosomething_login_parent_permission_email_form_submit($form, &$form_state) {
  global $language;
  $email = $form_state['values']['parent_email'];
  $account = user_load($form_state['values']['uid']);
  $params = array('account' => $account);

  drupal_mail('dosomething_login', 'dosomething-parent-email', $email, $language, $params);
  // TODO: This message may not be necessary.
  drupal_set_message(t('An email has been sent to %email.', array('%email' => $email)));
}

/**
 * Generates a unique URL for a parent to give permission to their
 *  under 13 year old child.
 *
 * @param object $account
 *   An object containing the user account.
 *
 * @return
 *   A unique URL that provides a one-time link for the user.
 */
function dosomething_login_one_time_parent_permission_link($account) {
  $timestamp = REQUEST_TIME;
  return url("dosomething/under-13/permission/$account->uid/$timestamp/" . user_pass_rehash($account->pass, $timestamp, $account->created), array('absolute' => TRUE));
}

/**
 * Page callback for parental consent link.
 *  This is used for users under 13 who need consent to be members.
 */
function dosomething_login_parent_permission_page($form, &$form_state, $uid, $timestamp, $hash, $action = NULL) {
  global $language;
  // This expires after 6 months.
  $timeout = strtotime('-6 months');
  $current = REQUEST_TIME;
  // Some redundant checks for extra security ?
  $users = user_load_multiple(array($uid), array('status' => '1'));
  if ($timestamp <= $current && $account = reset($users)) {
    // No time out for first time login.
    if ($timestamp < $timeout) {
      drupal_set_message(t('You have tried a parental consent link that has expired.'));
      drupal_goto();
    }
    elseif ($account->uid && $timestamp <= $current && $hash == user_pass_rehash($account->pass, $timestamp, $account->created)) {
      if (dosomething_login_user_has_parental_consent($uid)) {
        drupal_set_message(t('%user_name is either over 13 or has already received parental consent.', array('%user_name' => $account->name)));
        drupal_goto();
      }
      if ($action == 'submit') {
        if (isset($form_state['input']['op'])) {
          // Determine whether the parent is granting or denying membership.
          switch ($form_state['input']['op']) {
            case t('Yes'):
              watchdog('dosomething', 'User %name was given parental permission to be a member.', array('%name' => $account->name));
              drupal_set_message(t('You have just allowed %user_name to be a member of this site. An email has been sent.', array('%user_name' => $account->name)));
              drupal_mail('dosomething_login', 'dosomething-parent-permission-granted-email', $account->mail, $language, array('account' => $account));
              dosomething_login_grant_user_parental_permission($account);
              break;

            case t('No'):
              watchdog('dosomething', 'User %name was NOT given parental permission to be a member.', array('%name' => $account->name));
              drupal_set_message(t('%user_name has been denied parental consent to be a member of this site. An email has been sent.', array('%user_name' => $account->name)));
              drupal_mail('dosomething_login', 'dosomething-parent-permission-denied-email', $account->mail, $language, array('account' => $account));
              dosomething_login_deny_user_parental_permission($account);
              break;

            default:
              drupal_set_message(t('You provided an invalid response.'), 'warning');
              drupal_goto("dosomething/under-13/permission/$uid/$timestamp/$hash");
              break;
          }
        }
        else {
          drupal_set_message(t('You provided an invalid response.'), 'warning');
        }
        drupal_goto();
      }
      // TODO: else if user already has permission by virtue of being 13 or older.
      else {
        $form['message'] = array('#markup' => t('<p>Will you allow %user_name to be a member of this site?</p>', array('%user_name' => $account->name)));
        $form['actions'] = array('#type' => 'actions');
        $form['actions']['submit'] = array('#type' => 'submit', '#value' => t('Yes'));
        $form['actions']['cancel'] = array('#type' => 'submit', '#value' => t('No'));
        $form['#action'] = url("dosomething/under-13/permission/$uid/$timestamp/$hash/submit");
        return $form;
      }
    } 
  }
  else {
    drupal_set_message(t('You have tried to use a parental permission link that has either been used or is not valid.'));
    drupal_goto('');
  }
}

/**
 * Give a user under 13 parental permission.
 */
function dosomething_login_grant_user_parental_permission($account) {
  $member = user_role_load_by_name('member');
  $pending_member = user_role_load_by_name('pending member');
  // Only set the roles if they are a pending member.
  if (isset($account->roles[$pending_member->rid])) {
    $account->roles[$member->rid] = $member->name;
    unset($account->roles[$pending_member->rid]);
    $account = user_save($account);
  }
}

/**
 * Give a user under 13 parental permission.
 */
function dosomething_login_deny_user_parental_permission($account) {
  // TODO: It is undecided whether sanything should be done
  // for denied users, so we are doing nothing for the time
  // being.
}

/**
 * Update users who have become 13 or older.
 */
function dosomething_login_update_accounts_under_13($limit = 10) {
  $profiles = dosomething_login_get_accounts_under_13($limit);
  if (isset($profiles['profile2']) && count($profiles['profile2'])) {
    foreach ($profiles['profile2'] as $profile_data) {
      $profile = profile2_load($profile_data->pid);
      $birthday = field_get_items('profile2', $profile, 'field_user_birthday');
      if (isset($birthday[0]['value'])) {
        if (dosomething_login_person_is_over_age(strtotime($birthday[0]['value']), 13)) {
          $profile->field_user_is_over13[LANGUAGE_NONE][0]['value'] = 1;
          profile2_save($profile);
          $account = user_load($profile->uid);
          dosomething_login_grant_user_parental_permission($account);
        }
      }
    }
  }
}

/**
 * Get a list of accounts who are under 13
 */
function dosomething_login_get_accounts_under_13($limit = 10) {
  //Grab users in order of their birthdays
  // depending on whether they're marked under 13.
  $query = new EntityFieldQuery;

  try {
    $result = $query
      ->entityCondition('entity_type', 'profile2')
      ->propertyCondition('type', 'main')
      ->fieldCondition('field_user_is_over13', 'value', 0, '=')
      ->fieldOrderBy('field_user_birthday', 'value', 'ASC')
      ->range(0, $limit)
      ->execute();
  } catch (Exception $e) {
    return 0;
  }
  return $result;
}

/**
 * Delete old accounts of users who are under 13 and
 *  haven't received permission from there parents.
 */
function dosomething_login_clear_old_accounts($limit = 10) {
  $accounts = dosomething_login_get_old_accounts($limit);
  if (count($accounts)) {
    foreach ($accounts as $uid) {
      if ($uid != 1) {
        user_delete($uid);
      }
    }
  }
}

/**
 * Get the count of unassigned notifications.
 */
function dosomething_login_get_old_accounts($limit = 10) {
  $records = array();
  $role = user_role_load_by_name('pending member');
  try {
    $query = db_select('users', 'u');
    $query->innerJoin('users_roles', 'r', 'r.uid = u.uid');
    $result = $query->fields('u', array('uid'))
      ->condition('r.rid', $role->rid, '=')
      ->condition('u.status', 1, '=')
      ->condition('u.created', strtotime('-6 months'), '<')
      ->orderBy('u.created', 'ASC')
      ->range(0, $limit)
      ->execute();

  } catch (Exception $e) {
    return $records;
  }
  while($record = $result->fetchAssoc()) {
    $records[] = $record;
  }
  return $records;
}

/**
 * Implements hook_fboauth_actions().
 */
function dosomething_login_fboauth_actions() {
  $actions['prereg'] = array(
    'title' => t('Pre Register'),
    'callback' => 'dosomething_login_action_prereg',
    'permissions' => array(
      'email',
      'user_birthday',
    ),
  );
  $actions['ds_deauth'] = array(
    'title' => t('Deauthorize'),
    'callback' => 'dosomething_login_facebook_deauth',
    'theme callback' => 'dosomething_login_facebook_deauth_link',
  );
  return $actions;
}

/**
 * Facebook OAuth callback for deauthorizing the site from Facebook.
 */
function dosomething_login_facebook_deauth($app_id, $access_token) {
  global $user;

  // Deauthorize our application from Facebook.
  $result = fboauth_method_invoke('auth.revokeAuthorization', $access_token);

  // If successful, also remove the uid-fbid pairing.
  if (!is_array($result) && $result) {
    // Remove friends from user profile.
    dosomething_login_facebook_friend_process($user->uid);
    // Remove users from fboauth.
    fboauth_save($user->uid, NULL);
    drupal_set_message(t('Your DoSomething account has been disconnected from Facebook.'));
  }
  else {
    drupal_set_message(t('There was an error disconnecting from Facebook. The server returned %message.', array('%message' => $result->error_msg)), 'error');
    watchdog('There was an error disconnecting the user %username from Facebook. The server returned %message.', array('%message' => $result->error_msg, '%username' => $user->name));
  }
}

/**
 * Facebook OAuth action callback; Take user to registration page if don't
 * already have an account.
 */
function dosomething_login_action_prereg($app_id, $access_token) {
  global $user;

  $fbuser = fboauth_graph_query('me', $access_token);
  $uid = fboauth_uid_load($fbuser->id);

  // If the user has logged in before, load their account and login.
  if (!$user->uid && $uid && ($account = user_load($uid))) {
    if ($fb_friends = fboauth_graph_query('me/friends', $access_token)) {
      dosomething_login_facebook_friend_process($uid, $fb_friends->data);
    }
    fboauth_login_user($account);
  }
  // If the Facebook e-mail address matches an existing account, bind them
  // together and log in as that account.
  elseif (!empty($fbuser->email) && ($account = array_shift(user_load_multiple(array(), array('mail' => $fbuser->email))))) {
    fboauth_save($account->uid, $fbuser->id);

    // Logins will be denied if the user's account is blocked.
    if (fboauth_login_user($account)) {
      if ($fb_friends = fboauth_graph_query('me/friends', $access_token)) {
        dosomething_login_facebook_friend_process($account->uid, $fb_friends->data);
      }
      drupal_set_message(t("You've connected your account with Facebook."));
    }
  }
  else {
    // If the user is already logged in, associate the two accounts.
    if ($user->uid) {
      fboauth_save($user->uid, $fbuser->id);
      if ($fb_friends = fboauth_graph_query('me/friends', $access_token)) {
        dosomething_login_facebook_friend_process($user->uid, $fb_friends->data);
      }
      drupal_set_message(t("You've connected your account with Facebook."));
    }
    // Redirect to our user_reg page.
    else {
      // The fboauth module requires a redirect.
      $_SESSION['fbuser'] = $fbuser;
      return 'user/registration/fb';
    }
  }
}

/**
 * Registration page through Facebook. Prepopulates info and connects user
 * to Facebook account.
 */
function dosomething_login_register_facebook($form, &$form_state) {
  $form = drupal_retrieve_form('dosomething_login_register_popup_form', $form_state);
  $form['#action'] = '/user/registration/fb/?destination=front';
  if (isset($_SESSION['fbuser'])) {
    $fbuser = $_SESSION['fbuser'];
    $form['cell_or_email']['#value'] = $fbuser->email;
    $form['name']['first_name']['#value'] = $fbuser->first_name;
    $form['name']['last_name']['#value'] = $fbuser->last_name;
    $birthday = $fbuser->birthday;
    $date = explode('/', $birthday);
    $form['birthday']['month']['#value'] = $date[0];
    $form['birthday']['day']['#value'] = $date[1];
    $form['birthday']['year']['#value'] = $date[2];
  }
  else {
    drupal_set_message("There was a problem receiving your information from Facebook, please register below to create an account.");
  }
  return $form;
}

/**
 * Save Facebook friends if they have profiles in the system.
 * Deletes entries for user if facebook_friends array is empty.
 */
function dosomething_login_facebook_friend_process($uid, $facebook_friends = array()) {
  // Remove old entries.
  db_delete('facebook_friends')
    ->condition('uid', $uid)
    ->execute();

  if ($facebook_friends) {
    // Get currently users currently registered through Facebook.
    $local_results = db_select('fboauth_users')
      ->fields('fboauth_users', array('fbid', 'uid'))
      ->execute();
    while ($local_result = $local_results->fetchObject()) {
      $fb_user[$local_result->fbid] = $local_result->uid;
    }
    $query = db_insert('facebook_friends')->fields(array('uid', 'fbid'));
    foreach($facebook_friends as $friend) {
      // If user's friend has registered, save.
      if (isset($fb_user[$friend->id])) {
        $query->values(array('uid' => $uid, 'fbid' => $friend->id));
      }
    }
    $query->execute();
  }
  // Otherwise remove from friends as well.
  else {
    $fbid = fboauth_fbid_load($uid);
    if ($fbid) {
      // Remove old entries.
      db_delete('facebook_friends')
        ->condition('fbid', $fbid)
        ->execute();
    }
  }
}

/**
 * Log registration data when a user begins the registration process.
 */
function dosomething_login_registration_data_page() {
  if (isset($_POST['ds_api_key']) && $_POST['ds_api_key'] == variable_get('dosomething_login_api_key', '8hSyfEZIeBrlcgrdM6QbS63F6NjUvgqQ')) {
    $data = new stdClass;
    $required_fields = array('first_name', 'last_name');
    $query = db_delete('ds_registration_data');

    if (!isset($_POST['cell_or_email'])) {
      exit;
    }
    foreach ($required_fields as $field) {
      if (!isset($_POST[$field]) || !$_POST[$field]) {
        exit;
      }
      $data->{$field} = $_POST[$field];
    }

    // Ensure there is no current user with this cell or email.
    if (valid_email_address($_POST['cell_or_email'])) {
      if (user_load_by_mail($_POST['cell_or_email'])) {
        exit;
      }
      $data->email = $_POST['cell_or_email'];
      $query->condition('email', $data->email);
    }
    else if (($number = ltrim(preg_replace('/[^0-9]/', '', $_POST['cell_or_email']), 1)) && strlen($number) >= 9) {
      if (db_select('field_data_field_user_mobile')->fields('field_data_field_user_mobile', array('entity_id'))->condition('field_user_mobile_value', db_like($number), 'LIKE')->range(0, 1)->execute()->fetchField()) {
        exit;
      }
      $data->cell = $number;
      $query->condition('cell', $number);
    }
    // Clear data if this is a duplicate.
    $num_deleted = $query->execute();

    $success = drupal_write_record('ds_registration_data', $data);
  }
  exit;
}

/**
 * Provided themed information about the user's current Facebook connection.
 */
function theme_dosomething_login_facebook_user_info($variables) {
  $account = $variables['account'];

  $output = '';
  $output .= '<p>' . t('Your account is current connected with Facebook. Currently this site has access to the following information from Facebook.') . '</p>';
  $list = array('items' => array('basic' => 'Your basic information (Name, Gender, Picture, etc.)') + fboauth_user_connect_permissions() + array('birthday' => t('Your birthday')));
  $output .= theme('item_list', $list);
  $output .= '<p>' . t('You may disconnect your account from Facebook at any time by using the Deauthorize option below. If deauthorized, you will no longer be able to use Facebook to log into this account and must use a normal password. <strong>If you have not yet set a password, you will not be able to log onto this site</strong>.') . '</p>';
  $output .= fboauth_action_display('ds_deauth');
  return $output;
}

/**
 * Page callback for access denied menu callback.
 */
function dosomething_login_access_denied_page() {
  global $user;
  if ($user->uid == 0) {
    $form = drupal_get_form('user_login');
    return $form;
  }
  else {
    return t('You are not authorized to access this page.');
  }
}

function dosomething_login_ajax() {
  list($form, $form_state, $form_id, $form_build_id) = ajax_get_form();
  drupal_process_form($form['#form_id'], $form, $form_state);
  if ($errors = form_get_errors()) {
    $return = array(
      'success' => false,
      'missing' => $errors,
    );
  }
  else {
    $return = array(
      'success' => true,
    );
  }
  drupal_get_messages('error');
  drupal_json_output($return);
}
