<?php

/**
 * @file
 * Custom functionality relating to user registration and login.
 */

/**
 * Implements hook_menu().
 */
function dosomething_login_menu() {
  $items = array();
  $items['mobile-signup'] = array(
    'title' => 'Mobile Signup',
    'description' => 'Sign up URL to which mobile commons submits sign up requests to us.',
    'page callback' => 'dosomething_login_mobile_signup',
    'access callback' => 'dosomething_login_mobile_signup_access',
  );
  $items['user/fb/registration'] = array(
    'title' => 'Registration',
    'description' => 'Register through your Facebook account.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('dosomething_login_register_facebook'),
    'access callback' => 'user_register_access',
    'type' => MENU_CALLBACK,
  );
  $items['user/registration'] = array(
    'title' => 'Registration',
    'description' => 'Sign up URL to which mobile commons submits sign up requests to us.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('dosomething_login_register_popup_form'),
    'access callback' => 'user_register_access',
    'type' => MENU_CALLBACK,
  );
  $items['dosomething/under-13/permission/%/%/%'] = array(
    'title' => 'Parental Permission',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('dosomething_login_parent_permission_page', 3, 4, 5),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  $items['dosomething/under-13/parent-consent-email'] = array(
    'title' => 'Parental Permission',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('dosomething_login_parent_permission_email_form'),
    'access callback' => 'dosomething_parent_consent_email_access',
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Implements hook_menu_alter().
 */
function dosomething_login_menu_alter(&$items) {
  // Remove the default user registration page in favor of our custom registration.
  unset($items['user/register']);
}

/**
 * Implements hook_block_info().
 */
function dosomething_login_block_info() {
  $blocks['become_member'] = array(
    'info' => t('Become a Member'),
    'cache' => DRUPAL_NO_CACHE,
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function dosomething_login_block_view($delta = '') {
  $block = array();
  switch ($delta) {
    case 'become_member':
      global $user;
      if (!$user->uid) {
        if ((arg(0) != 'user' || arg(1) != 'registration')) {
          $block['subject'] = t('Become a Member');
          $block['content'][] = drupal_get_form('dosomething_login_register_block');
          $block['content'][] = drupal_get_form('dosomething_login_register_popup_form');
        }
      }
      else if (module_exists('dosomething_user_my_somethings')) {
        // TODO: This should go in dosomething_user_my_somethings module
        // but we will have to redo a bunch of theming to get that working.
        $block['content'] = dosomething_user_my_somethings_member_block();
      }
      break;
  }
  return $block;
}

/**
 * Implements hook_mail().
 */
function dosomething_login_mail($key, &$message, $params) {
  switch ($key) {
    case 'dosomething-parent-email':
      $params['full_name'] = dosomething_login_get_user_full_name($params['account']);
      $params['link'] = dosomething_login_one_time_parent_permission_link($params['account']);
      $message['subject'] = t('Permissions for @name', array('@name' => $params['full_name']));
      $message['body'][] = drupal_html_to_text(theme('dosomething_login_parent_email', $params));
      $message['headers']['Content-Type'] = 'text/html; charset=utf-8';
      break;
    case 'dosomething-parent-permission-granted-email':
      $params['full_name'] = dosomething_login_get_user_full_name($params['account']);
      $message['subject'] = t('Permission Granted');
      $message['body'][] = drupal_html_to_text(theme('dosomething_login_parent_permission_granted_email', $params));
      $message['headers']['Content-Type'] = 'text/html; charset=utf-8';
      break;
    case 'dosomething-parent-permission-denied-email':
      $params['full_name'] = dosomething_login_get_user_full_name($params['account']);
      $message['subject'] = t('Permission Denied');
      $message['body'][] = drupal_html_to_text(theme('dosomething_login_parent_permission_denied_email', $params));
      $message['headers']['Content-Type'] = 'text/html; charset=utf-8';
      break;
  }
}

/**
 * Implements hook_theme().
 */
function dosomething_login_theme($existing, $type, $theme, $path) {
  return array(
    'dosomething_login_member_lightbox' => array(
      'path' => $path . '/templates',
      'variables' => array(),
      'template' => 'dosomething-login-member-lightbox',
    ),
    'dosomething_login_parent_email' => array(
      'path' => $path . '/templates',
      'variables' => array('full_name' => NULL, 'link' => NULL),
      'template' => 'dosomething-login-parent-email',
    ),
    'dosomething_login_parent_permission_granted_email' => array(
      'path' => $path . '/templates',
      'variables' => array('full_name' => NULL),
      'template' => 'dosomething-login-parent-permission-granted-email',
    ),
    'dosomething_login_parent_permission_denied_email' => array(
      'path' => $path . '/templates',
      'variables' => array('full_name' => NULL),
      'template' => 'dosomething-login-parent-permission-denied-email',
    ),
  );
}

/**
 * Implements hook_cron().
 */
function dosomething_login_cron() {
  // TODO: Only run every few hours?
  dosomething_login_update_accounts_under_13();
  dosomething_login_clear_old_accounts();
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function dosomething_login_form_user_profile_form_alter(&$form, &$form_state) {
  global $user;
  if (!dosomething_login_user_has_parental_consent($user->uid)) {
    // Note: Give a user parental consent if they are over 13
    // so that they don't get stuck not being able to edit their
    // account by changing their birthdate.
    dosomething_login_set_parental_consent_message();
    drupal_goto('user');
  }
}

/**
 * Implements hook_form_alter().
 */
function dosomething_login_form_alter(&$form, &$form_state, $form_id) {
  // TODO: Do same thing for webforms.
  if (isset($form['#node']) && strpos($form_id, 'webform_client_form_') === 0) {
    $node_types = array(
      'campaign_report_back',
      'campaign_sign_up',
      'grant_application',
      'scholarship_application',
      'action_guide',
      'project_report',
    );
    // Users without parental consent should be able to see this
    // but not be able to do anything with it.
    if (in_array($form['#node']->type, $node_types)) {
      global $user;
      if (!dosomething_login_user_has_parental_consent($user->uid)) {
        dosomething_login_set_parental_consent_message();
        drupal_goto();
      }
    }
  }
}

/**
 * Implements hook_element_info().
 */
function dosomething_login_element_info() {
  $types = array();
  $types['dosomething_password_confirm'] = array(
    '#input' => TRUE,
    '#process' => array('dosomething_roles_dosomething_password_confirm', 'user_form_process_password_confirm'),
    '#theme_wrappers' => array('form_element'),
    '#element_validate' => array('password_confirm_validate'),
  );
  return $types;
}

/**
 * Process a form element of type dosomething_password_confirm.
 */
function dosomething_roles_dosomething_password_confirm($element) {
  // The normal password confirm sets a title and doesn't let you add
  // attributes or edit the title.

  // This removes the title of the confirm password and adds placeholders.
  $element = form_process_password_confirm($element);
  unset($element['pass2']['#title']);
  $element['pass1']['#attributes']['placeholder'] = t('Create a Password');
  $element['pass2']['#attributes']['placeholder'] = t('Confirm that password please');
  return $element;
}

/**
 * The form for the 'Become a Member' block.
 */
function dosomething_login_register_popup_form($form, &$form_state) {
  $form['#validate'][] = 'dosomething_login_register_block_validate';
  $form['#submit'][] = 'dosomething_login_register_block_submit';
  $form['#attached'] = array(
    'js' => array(
      // TODO: Only add on user/registration page.
      drupal_get_path('module', 'dosomething_login') . '/js/dosomething-login-registration-lightbox.js',
    ),
  );

  $query = drupal_get_destination();
  $query['destination'] = $query['destination'] == 'user/registration' ? 'front' : $query['destination'];
  $form['#action'] = url($_GET['q'], array('query' => drupal_get_destination()));
  $form['#action'] = url('user/registration', array('query' => $query));

  $form['title_text'] = array(
    '#type' => 'item',
    '#title' => t("You're almost there."),
    '#description' => t("Fill out the rest of the informationbelow and you'll be a member in no time."),
  );
  $form['name'] = array(
    'first_name' => array(
      '#type' => 'textfield',
      '#attributes' => array(
        'placeholder' => t('First Name'),
        'class' => array('dosomething-original-value'),
      ),
      '#size' => 9,
    ),
    'last_name' => array(
      '#type' => 'textfield',
      '#attributes' => array(
        'placeholder' => t('Last Name'),
        'class' => array('dosomething-original-value'),
      ),
      '#size' => 9,
    ),
  );
  $form['cell_or_email'] = array(
    '#type' => 'textfield',
    '#attributes' => array(
      'placeholder' => t('Cell Number or E-mail'),
      'class' => array('dosomething-original-value'),
    ),
    '#size' => 20,
  );
  $form['birthday'] = array(
    'over_13' => array(
      '#type' => 'container',
      '#attributes' => array(
        'class' => array(
          'age-question',
        ),
      ),
      '#children' => t('Birthday'),
    ),
    'month' => array(
      '#type' => 'textfield',
      '#attributes' => array(
        'placeholder' => t('mm'),
        'class' => array('dosomething-original-value'),
      ),
      '#size' => 2,
      '#maxlength' => 2,
    ),
    'day' => array(
      '#type' => 'textfield',
      '#attributes' => array(
        'placeholder' => t('dd'),
        'class' => array('dosomething-original-value'),
      ),
      '#size' => 2,
      '#maxlength' => 2,
    ),
    'year' => array(
      '#type' => 'textfield',
      '#attributes' => array(
        'placeholder' => t('yyyy'),
        'class' => array('dosomething-original-value'),
      ),
      '#size' => 4,
      '#maxlength' => 4,
    ),
  );

  $form['parent_email_message'] = array(
    '#type' => 'item',
    '#title' => t('What a Rock Star!'),
    '#description' => t("Since you're under the age of 13, you'll need to get a parent or guradian's permission."),
    '#prefix' => '<div class="under-13-field">',
  );
  $form['parent_email'] = array(
    '#type' => 'textfield',
    '#attributes' => array(
      'placeholder' => t("Parent or Guardian's Email"),
    ),
    '#suffix' => '</div>',
    '#size' => 20,
  );

  $form['pass'] = array(
    '#type' => 'dosomething_password_confirm',
    '#required' => TRUE,
    '#attributes' => array(
      'placeholder' => t('Create a Password'),
    ),
    '#size' => 15,
  );
  if (module_exists('captcha')) {
    $form['captcha'] = array(
      '#title' => t('Captcha'),
      '#type' => 'captcha',
    );
  }

  $form['signup_title'] = array(
    '#type' => 'item',
    '#title' => t('Sign Up for Updates'),
    '#description' => t("In order to be a member, you have to be 25 and under. However, this doesn't mean you can't stay up to date on our latests somethings."),
    '#prefix' => '<div class="over-25-field">',
    '#suffix' => '</div>',
  );
  $form['signup_message'] = array(
    '#type' => 'item',
    '#description' => t("Yes! I'd love to receive the hilarious and informative weekly updates."),
    '#prefix' => '<div class="over-25-field">',
    '#suffix' => '</div>',
  );
  $form['signup'] = array(
    '#type' => 'checkbox',
    '#description' => t("Yes! I'd love to receive the hilarious and informative weekly updates."),
    '#default_value' => TRUE,
  );
  $form['final_submit'] = array(
    '#type' => 'submit',
    '#value' => t('Submit'),
  );
  return $form;
}

/**
 * The form for the 'Become a Member' block.
 */
function dosomething_login_register_block($form, &$form_state) {
  $form['#attached'] = array(
    'js' => array(
      drupal_get_path('module', 'dosomething_login') . '/js/jquery-validation-1.9.0/jquery.validate.min.js',
      drupal_get_path('module', 'dosomething_login') . '/js/dosomething-login-member-lightbox.js',
    ),
    'library' => array(array('system', 'ui.dialog')),
  );
  // Get login link for fboauth.
  $fb_link = fboauth_action_link_properties('prereg');
  $fb_url = url($fb_link['href'], array('query' => $fb_link['query']));

  $query = drupal_get_destination();
  $query['destination'] = $query['destination'] == 'user/registration' ? 'front' : $query['destination'];
  $form['#action'] = url('user/registration', array('query' => $query));
  $form['connect'] = array(
    '#type' => 'container',
    '#attributes' => array(
      'class' => array(
        'connect-thru-facebook',
      ),
    ),
    '#children' => l('Connect thru Facebook', $fb_url),
  );
  $form['or'] = array(
    '#type' => 'container',
    '#attributes' => array(
      'class' => array(
        'separator',
        'split',
      ),
    ),
    '#children' => t('or'),
  );
  $form['name'] = array(
    'first_name' => array(
      '#type' => 'textfield',
      '#attributes' => array(
        'placeholder' => t('First Name'),
      ),
      '#size' => 9,
    ),
    'last_name' => array(
      '#type' => 'textfield',
      '#attributes' => array(
        'placeholder' => t('Last Name'),
      ),
      '#size' => 9,
    ),
  );
  $form['cell_or_email'] = array(
    '#type' => 'textfield',
    '#attributes' => array(
      'placeholder' => t('Cell Number or E-mail'),
    ),
    '#size' => 20,
  );
  $form['birthday'] = array(
    'over_13' => array(
      '#type' => 'container',
      '#attributes' => array(
        'class' => array(
          'age-question',
        ),
      ),
      '#children' => t('Birthday'),
    ),
    'month' => array(
      '#type' => 'textfield',
      '#attributes' => array(
        'placeholder' => t('mm'),
      ),
      '#size' => 2,
      '#maxlength' => 2,
    ),
    'day' => array(
      '#type' => 'textfield',
      '#attributes' => array(
        'placeholder' => t('dd'),
      ),
      '#size' => 2,
      '#maxlength' => 2,
    ),
    'year' => array(
      '#type' => 'textfield',
      '#attributes' => array(
        'placeholder' => t('yyyy'),
      ),
      '#size' => 4,
      '#maxlength' => 4,
    ),
  );
  $form['first_submit'] = array(
    '#type' => 'submit',
    '#value' => t('Signup'),
    '#attributes' => array('class' => array('submit')),
  );
  $form['why'] = array(
    '#prefix' => '<hr class="top"/><h3 class="why-member">',
    '#markup' => t('Why be a member?') . '</h3>' . t('Benefits. Benefits. Benefits. '),
  );
  $form['learn'] = array(
    '#theme' => 'link',
    '#path' => 'why-become-a-member',
    '#text' => t("Learn more >>"),
    '#options' => array(
      'attributes' => array('class' => array('why')),
      'html' => FALSE,
    ),
    '#suffix' => '<hr class="bottom"/>',
  );
  $form['lightbox'] = array(
    '#theme' => 'dosomething_login_member_lightbox',
    '#type' => 'container',
    '#attributes' => array(
      'id' => 'member-dialog',
    ),
  );
  $form['already']['#markup'] = '<h3 class="already-member">' . t('Already a member?') . '</h3>';
  $form['logins'] = array(
    'facebook_login' => array(
      '#markup' => l('<span class="fb-icon">log in</span>', $fb_url,
        array(
          'attributes' => array(
            'class' => 'login facebook-login ds-button',
          ),
          'html' => TRUE,
        )
      )
    ),
    'login' => array(
      '#theme' => 'link',
      '#path' => 'user/login',
      '#text' => t('log in'),
      '#options' => array(
        'attributes' => array('class' => array('login ds-login ds-button')),
        'html' => FALSE,
      ),
    ),
  );
  return $form;
}

/**
 * Validate the user registration form.
 */
function dosomething_login_register_block_validate($form, &$form_state) {
  $values = $form_state['input'];
  $form_state['values']['birthdate'] = mktime(0, 0, 0, $values['month'], $values['day'], $values['year']);
  if (!is_numeric($values['month']) || $values['month'] > 12) {
    form_set_error('month', t('Please provide a valid numeric month for your birthday.'));
    $invalid_birthday = TRUE;
  }
  if (!is_numeric($values['day']) || $values['month'] > 31) {
    form_set_error('day', t('Please provide a valid day for your birthday.'));
    $invalid_birthday = TRUE;
  }
  if (!is_numeric($values['year']) || strlen($values['year']) != 4) {
    form_set_error('year', t('Please provide the 4-digit year you were born.'));
    $invalid_birthday = TRUE;
  }
  if (!isset($invalid_birthday)) {
    if (!dosomething_login_person_is_over_age($form_state['values']['birthdate'], 13)) {
      if (!isset($form_state['values']['parent_email']) || !valid_email_address($form_state['values']['parent_email'])) {
        form_set_error('parent_email', t('Please provide a valid parental email address.'));
      }
    }
    else if (dosomething_login_person_is_over_age($form_state['values']['birthdate'], 25)) {
      // Don't throw required field errors for captcha and password.
      // We could add errors back if needed.
      form_clear_error();
      $messages = drupal_get_messages('error');
      if (count($messages['error'])) {
        foreach ($messages['error'] as $message) {
          if (!preg_match('/field is required.$/', $message)) {
            drupal_set_message($message, 'error');
          }
        }
      }
    }
  }

  if (!$values['first_name']) {
    form_set_error('first_name', t('Please provide your first name.'));
  }
  if (!$values['last_name']) {
    form_set_error('last_name', t('Please provide your last name.'));
  }
  // Validate cell number or e-mail address
  if (valid_email_address($values['cell_or_email'])) {
    if (db_select('users')->fields('users', array('uid'))->condition('mail', db_like($values['cell_or_email']), 'LIKE')->range(0, 1)->execute()->fetchField()) {
      form_set_error('cell_or_email', t('The e-mail address %email is already registered. <a href="@password">Have you forgotten your password?</a>', array('%email' => $values['cell_or_email'], '@password' => url('user/password'))));
    }
    $form_state['values']['mail'] = $values['cell_or_email'];
  }
  else if (($number = preg_replace('[^0-9]', '', $values['cell_or_email'])) && strlen($number) >= 10) {
    if (db_select('field_data_field_user_mobile')->fields('field_data_field_user_mobile', array('entity_id'))->condition('field_user_mobile_value', db_like($number), 'LIKE')->range(0, 1)->execute()->fetchField()) {
      form_set_error('cell_or_email', t('The phone number %phone is already registered. <a href="@password">Have you forgotten your password?</a>', array('%phone' => $values['cell_or_email'], '@password' => url('user/password'))));
    }
    else if (db_select('users')->fields('users', array('uid'))->condition('mail', db_like($number . '@mobile.com'), 'LIKE')->range(0, 1)->execute()->fetchField()) {
      form_set_error('cell_or_email', t('The phone number %phone is already registered. <a href="@password">Have you forgotten your password?</a>', array('%phone' => $values['cell_or_email'], '@password' => url('user/password'))));
    }
    $form_state['values']['phone'] = $number;
    $form_state['values']['mail'] = $number . '@mobile.com';;
  }
  else {
    form_set_error('cell_or_email', t('Please provide a valid email address or phone number'));
  }
}

/**
 * Submit the user registration form.
 */
function dosomething_login_register_block_submit($form, &$form_state) {
  $values = $form_state['input'];
  $birthdate = $form_state['values']['birthdate'];
  $name = preg_replace('/[^A-Za-z.]+/', '', $values['first_name']) . ' ' . preg_replace('/[^A-Za-z.]+/', '', $values['last_name']);
  $form_state['values']['name'] = dosomething_login_unique_name($name);
  $form_state['values']['init'] = $name;
  if (empty($form_state['values']['pass'])) {
    $form_state['values']['pass'] = user_password();
  }
  // Remove unneeded values.
  form_state_values_clean($form_state);

  $account = drupal_anonymous_user();
  $edit = array_intersect_key((array) $account, $form_state['values']);
  $edit['pass'] = $form_state['values']['pass'];
  entity_form_submit_build_entity('user', $account, $form, $form_state);

  // Determine the user's role by their age.
  if (dosomething_login_person_is_over_age($birthdate, 25)) {
    $role_name = 'old person';
    drupal_set_message(t('You have been signed up for our weekly updates'));
    $account->status = 0;
  }
  else if (!dosomething_login_person_is_over_age($birthdate, 13)) {
    $role_name = 'pending member';
    $account->status = 1;
  }
  else {
    $role_name = 'member';
    $account->status = 1;
  }
  $role = user_role_load_by_name($role_name);
  $account->roles[$role->rid] = $role->name;
  $account = user_save($account, $edit); 
  // Terminate if an error occurred during user_save().
  if (!$account) {
    drupal_set_message(t("Error saving user account."), 'error');
    $form_state['redirect'] = '';
    return;
  }
  // Save profile data.
  $profile = new stdClass();
  $profile->type = 'main';
  $profile->uid = $account->uid;
  drupal_write_record('profile', $profile);
  $profile->field_user_first_name[LANGUAGE_NONE][0]['value'] = $values['first_name'];
  $profile->field_user_last_name[LANGUAGE_NONE][0]['value'] = $values['last_name'];
  $birthday = new DateObject($birthdate);
  $time = $birthday->format(DATE_FORMAT_DATETIME);
  $profile->field_user_birthday[LANGUAGE_NONE][0]['value'] = $time;
  $profile->field_user_is_over13[LANGUAGE_NONE][0]['value'] = (int) dosomething_login_person_is_over_age($birthdate, 13);
  if ($values['signup'] || $role_name == 'old person') {
    $profile->field_user_newsletter_optin[LANGUAGE_NONE][0]['value'] = 1;
  }
  if (isset($values['phone'])) {
    $profile->field_user_mobile[LANGUAGE_NONE][0]['value'] = $values['phone'];
  }
  field_attach_insert('profile2', $profile);
  $form_state['uid'] = $account->uid;
  if (isset($account->mail) && $account->status) {
    _user_mail_notify('register_no_approval_required', $account);
  }
  else {
    // TOOD: verify cell number via SMS.
  }

  if (!dosomething_login_person_is_over_age($birthdate, 13)) {
    if (isset($values['parent_email'])) {
      global $language;
      $params = array('account' => $account);
      drupal_mail('dosomething_login', 'dosomething-parent-email', $values['parent_email'], $language, $params);
      drupal_set_message(t('An email has been sent to %email for parental permission.', array('%email' => $values['parent_email'])));
    }
  }
  // After they are saved, save their fbuid with their uid if they registered
  // through Facebook.
  if (isset($_SESSION['fbuser'])) {
    fboauth_save($account->uid, $_SESSION['fbuser']->id);
    unset($_SESSION['fbuser']);
  }
  // Log user in.
  if ($account->status) {
    user_login_submit(array(), $form_state);
  }
}

/**
 * Generate a unique username.
 */
function dosomething_login_unique_name($name, $i = '') {
  if (db_select('users')->fields('users', array('uid'))->condition('name', db_like($name . $i), 'LIKE')->range(0, 1)->execute()->fetchField()) {
    if ($i === '') {
      $i = 0;
    }
    else {
      $i++;
    }
    return dosomething_login_unique_name($name, $i);
  }
  else {
    return $name . $i;
  }
}

function dosomething_login_mobile_signup_access() {
  $valid = sms_mobile_commons_incoming_check();

  //TODO: REMOVE ME BEFORE PRODUCTION!!!
  //For testing allow ip of zivtech office and local dev machines
  $ip = ip_address();
  if ($ip == '192.168.56.1' || $ip == '173.161.182.250') {
    $valid = TRUE;
  }
  if (!$valid) {
    //We've got someone trying to create users on the mobile page. That's bad.
    watchdog('dosomething_login',
      'Someone is trying to mobile signup from ip address: ' . $ip
      . " This is suspicious.", $variables = array(), $severity = WATCHDOG_NOTICE, $link = NULL);
  }
  return $valid;
}

function dosomething_login_mobile_signup() {
  //TODO REMOVE ME. I AM FOR TESTING ONLY.
  $ip = ip_address();
  watchdog('dosomething_login', $ip . " " . $_SERVER['REQUEST_URI'], $variables = array(), $severity = WATCHDOG_NOTICE, $link = NULL);

  return 'THIS IS A TEST';
}

/**
 * Determine if a drupal user is over the given age.
 *  If no birthday is set, the default answer is no.
 *
 * @param $uid
 *  (int) numeric id of drupal user.
 * @return @boolean
 */
function dosomething_login_drupal_user_is_over_age($uid, $age = 13, $end_timestamp = NULL) {
  $account = user_load($uid);
  $profile = profile2_load_by_user($account, 'main');
  if (is_object($profile)) {
    $birthday = field_get_items('profile2', $profile, 'field_user_birthday'); 
    if (isset($birthday[0]['value'])) {
      // this is only a a time (no time) so timezone is not important.
      $timestamp = strtotime($birthday[0]['value']);
      return dosomething_login_person_is_over_age($timestamp, $age, $end_timestamp);
    }
  }
  return FALSE;
}

/**
 * Check if a user is over the given age.
 *
 * @param $birthday
 *  (int) timestamp of birthday.
 * @param $age
 *  (int) the age to check.
 * @param $timestamp
 *  (int) the time at which to check the age. Defaults to current time.
 * @return @boolean
 */
function dosomething_login_person_is_over_age($birthday, $age = 13, $timestamp = NULL) {
  $timestamp = is_null($timestamp) ? REQUEST_TIME : $timestamp;
  return $birthday < strtotime("-$age year", $timestamp) ? TRUE : FALSE;
}

/**
 * Mark a user as being over 13.
 *  They don't need parental permission at this point.
 */
function dosomething_login_mark_user_account_over_13($uid) {
  // TODO: What else needs to be done to graduate the user to being over 13?
  $account = user_load($uid);
  $profile = profile2_load_by_user($account, 'main');
  if (is_object($profile)) {
    $birthday = field_get_items('profile2', $profile, 'field_user_birthday'); 
    $profile->field_user_is_over13[LANGUAGE_NONE][0]['value'] = 1;
    profile2_save($profile);
  }
}

/**
 * Get a user's full name from their main profile.
 */
function dosomething_login_get_user_full_name($account) {
  $full_name = '';
  $names = array();
  $profile = profile2_load_by_user($account, 'main');
  if (is_object($profile)) {
    foreach (array('field_user_first_name', 'field_user_last_name') as $field) {
      $stored_names = field_get_items('profile2', $profile, $field);
      if (isset($stored_names[0]['safe_value'])) {
        $names[] = $stored_names[0]['safe_value'];
      }
    }
    $full_name = implode(' ', $names);
  }
  return $full_name;
}

/**
 * Determine if user has parentel consent to use this site.
 *  If they are over 13, then they don't need it.
 */
function dosomething_login_user_has_parental_consent($uid) {
  $account = user_load($uid);
  if (dosomething_login_drupal_user_is_over_age($uid, 13)) {
    return TRUE;
  }
  // Don't lock out admins
  if (in_array('administrator', $account->roles)) {
    return TRUE;
  }
  if (!in_array('pending member', $account->roles)) {
    return TRUE;
  }
  return FALSE;
}

/**
 * Set a message indicating that s user cannot perform an action
 *  until the have been given consent by a parent.
 */
function dosomething_login_set_parental_consent_message() {
  // TODO: Some link to ask for parental consent
  drupal_set_message(t('Before you can perform this action, you must have parental consent. You can send a request to your parent or legal guardian <a href="@link"> here</a>.', array('@link' => 'dosomething/under-13/parent-consent-email')), 'warning');
}

/**
 * Determine access to parental consent email request form.
 */
function dosomething_parent_consent_email_access() {
  global $user;
  return !dosomething_login_user_has_parental_consent($user->uid);
}

/**
 * Form for a person under 13 to request their parent's permission
 *  to use the site.
 */
function dosomething_login_parent_permission_email_form($form, &$form_state, $uid = NULL) {
  if (is_null($uid)) {
    global $user;
    $uid = $user->uid;
  }
  $form['parent_email'] = array(
    '#title' => t('Parent or Guardian Email Address'),
    '#type' => 'textfield',
    '#size' => 20,
  );
  $form['uid'] = array(
    '#type' => 'value',
    '#value' => $uid,
  );
  $form['submit_email'] = array(
    '#type' => 'submit',
    '#value' => t('Send Email'),
  );
  return $form;
}

/**
 * Validation callback for parent permission email form.
 */
function dosomething_login_parent_permission_email_form_validate($form, &$form_state) {
  $email = $form_state['values']['parent_email'];
  if (!valid_email_address($email)) {
    form_set_error('parent_email', t('you must provide a valid email address'));
  }
}

/**
 * Submission callback for parent permission email form.
 */
function dosomething_login_parent_permission_email_form_submit($form, &$form_state) {
  global $language;
  $email = $form_state['values']['parent_email'];
  $account = user_load($form_state['values']['uid']);
  $params = array('account' => $account);

  drupal_mail('dosomething_login', 'dosomething-parent-email', $email, $language, $params);
  // TODO: This message may not be necessary.
  drupal_set_message(t('An email has been sent to %email.', array('%email' => $email)));
}

/**
 * Generates a unique URL for a parent to give permission to their
 *  under 13 year old child.
 *
 * @param object $account
 *   An object containing the user account.
 *
 * @return
 *   A unique URL that provides a one-time link for the user.
 */
function dosomething_login_one_time_parent_permission_link($account) {
  $timestamp = REQUEST_TIME;
  return url("dosomething/under-13/permission/$account->uid/$timestamp/" . user_pass_rehash($account->pass, $timestamp, $account->created), array('absolute' => TRUE));
}

/**
 * Page callback for parental consent link.
 *  This is used for users under 13 who need consent to be members.
 */
function dosomething_login_parent_permission_page($form, &$form_state, $uid, $timestamp, $hash, $action = NULL) {
  global $language;
  // This expires after 6 months.
  $timeout = strtotime('-6 months');
  $current = REQUEST_TIME;
  // Some redundant checks for extra security ?
  $users = user_load_multiple(array($uid), array('status' => '1'));
  if ($timestamp <= $current && $account = reset($users)) {
    // No time out for first time login.
    if ($timestamp < $timeout) {
      drupal_set_message(t('You have tried a parental consent link that has expired.'));
      drupal_goto();
    }
    elseif ($account->uid && $timestamp <= $current && $hash == user_pass_rehash($account->pass, $timestamp, $account->created)) {
      if (dosomething_login_user_has_parental_consent($uid)) {
        drupal_set_message(t('%user_name is either over 13 or has already received parental consent.', array('%user_name' => $account->name)));
        drupal_goto();
      }
      if ($action == 'submit') {
        if (isset($form_state['input']['op'])) {
          // Determine whether the parent is granting or denying membership.
          switch ($form_state['input']['op']) {
            case t('Yes'):
              watchdog('dosomething', 'User %name was given parental permission to be a member.', array('%name' => $account->name));
              drupal_set_message(t('You have just allowed %user_name to be a member of this site. An email has been sent.', array('%user_name' => $account->name)));
              drupal_mail('dosomething_login', 'dosomething-parent-permission-granted-email', $account->mail, $language, array('account' => $account));
              dosomething_login_grant_user_parental_permission($account);
              break;

            case t('No'):
              watchdog('dosomething', 'User %name was NOT given parental permission to be a member.', array('%name' => $account->name));
              drupal_set_message(t('%user_name has been denied parental consent to be a member of this site. An email has been sent.', array('%user_name' => $account->name)));
              drupal_mail('dosomething_login', 'dosomething-parent-permission-denied-email', $account->mail, $language, array('account' => $account));
              dosomething_login_deny_user_parental_permission($account);
              break;

            default:
              drupal_set_message(t('You provided an invalid response.'), 'warning');
              drupal_goto("dosomething/under-13/permission/$uid/$timestamp/$hash");
              break;
          }
        }
        else {
          drupal_set_message(t('You provided an invalid response.'), 'warning');
        }
        drupal_goto();
      }
      // TODO: else if user already has permission by virtue of being 13 or older.
      else {
        $form['message'] = array('#markup' => t('<p>Will you allow %user_name to be a member of this site?</p>', array('%user_name' => $account->name)));
        $form['actions'] = array('#type' => 'actions');
        $form['actions']['submit'] = array('#type' => 'submit', '#value' => t('Yes'));
        $form['actions']['cancel'] = array('#type' => 'submit', '#value' => t('No'));
        $form['#action'] = url("dosomething/under-13/permission/$uid/$timestamp/$hash/submit");
        return $form;
      }
    } 
  }
  else {
    drupal_set_message(t('You have tried to use a parental permission link that has either been used or is not valid.'));
    drupal_goto('');
  }
}

/**
 * Give a user under 13 parental permission.
 */
function dosomething_login_grant_user_parental_permission($account) {
  $member = user_role_load_by_name('member');
  $pending_member = user_role_load_by_name('pending member');
  // Only set the roles if they are a pending member.
  if (isset($account->roles[$pending_member->rid])) {
    $account->roles[$member->rid] = $member->name;
    unset($account->roles[$pending_member->rid]);
    $account = user_save($account);
  }
}

/**
 * Give a user under 13 parental permission.
 */
function dosomething_login_deny_user_parental_permission($account) {
  // TODO: It is undecided whether sanything should be done
  // for denied users, so we are doing nothing for the time
  // being.
}

/**
 * Update users who have become 13 or older.
 */
function dosomething_login_update_accounts_under_13($limit = 10) {
  $profiles = dosomething_login_get_accounts_under_13($limit);
  if (isset($profiles['profile2']) && count($profiles['profile2'])) {
    foreach ($profiles['profile2'] as $profile_data) {
      $profile = profile2_load($profile_data->pid);
      $birthday = field_get_items('profile2', $profile, 'field_user_birthday');
      if (isset($birthday[0]['value'])) {
        if (dosomething_login_person_is_over_age(strtotime($birthday[0]['value']), 13)) {
          $profile->field_user_is_over13[LANGUAGE_NONE][0]['value'] = 1;
          profile2_save($profile);
          $account = user_load($profile->uid);
          dosomething_login_grant_user_parental_permission($account);
        }
      }
    }
  }
}

/**
 * Get a list of accounts who are under 13
 */
function dosomething_login_get_accounts_under_13($limit = 10) {
  //Grab users in order of their birthdays
  // depending on whether they're marked under 13.
  $query = new EntityFieldQuery;

  try {
    $result = $query
      ->entityCondition('entity_type', 'profile2')
      ->propertyCondition('type', 'main')
      ->fieldCondition('field_user_is_over13', 'value', 0, '=')
      ->fieldOrderBy('field_user_birthday', 'value', 'ASC')
      ->range(0, $limit)
      ->execute();
  } catch (Exception $e) {
    return 0;
  }
  return $result;
}

/**
 * Delete old accounts of users who are under 13 and
 *  haven't received permission from there parents.
 */
function dosomething_login_clear_old_accounts($limit = 10) {
  $accounts = dosomething_login_get_old_accounts($limit);
  if (count($accounts)) {
    foreach ($accounts as $uid) {
      if ($uid != 1) {
        user_delete($uid);
      }
    }
  }
}

/**
 * Get the count of unassigned notifications.
 */
function dosomething_login_get_old_accounts($limit = 10) {
  $records = array();
  $role = user_role_load_by_name('pending member');
  try {
    $query = db_select('users', 'u');
    $query->innerJoin('users_roles', 'r', 'r.uid = u.uid');
    $result = $query->fields('u', array('uid'))
      ->condition('r.rid', $role->rid, '=')
      ->condition('u.status', 1, '=')
      ->condition('u.created', strtotime('-6 months'), '<')
      ->orderBy('u.created', 'ASC')
      ->range(0, $limit)
      ->execute();

  } catch (Exception $e) {
    return $records;
  }
  while($record = $result->fetchAssoc()) {
    $records[] = $record;
  }
  return $records;
}

/**
 * Implements hook_fboauth_actions().
 */
function dosomething_login_fboauth_actions() {
  $actions['prereg'] = array(
    'title' => t('Pre Register'),
    'callback' => 'dosomething_login_action_prereg',
    'permissions' => array(
      'email',
      'user_birthday',
    ),
  );
  return $actions;
}

/**
 * Facebook OAuth action callback; Take user to registration page if don't
 * already have an account.
 */
function dosomething_login_action_prereg($app_id, $access_token) {
  global $user;

  $fbuser = fboauth_graph_query('me', $access_token);
  $uid = fboauth_uid_load($fbuser->id);

  // If the user has logged in before, load their account and login.
  if (!$user->uid && $uid && ($account = user_load($uid))) {
    if ($fb_friends = fboauth_graph_query('me/friends', $access_token)) {
      dosomething_login_facebook_friend_process($fb_friends->data, $uid);
    }
    fboauth_login_user($account);
  }
  // If the Facebook e-mail address matches an existing account, bind them
  // together and log in as that account.
  elseif (!empty($fbuser->email) && ($account = array_shift(user_load_multiple(array(), array('mail' => $fbuser->email))))) {
    fboauth_save($account->uid, $fbuser->id);

    // Logins will be denied if the user's account is blocked.
    if (fboauth_login_user($account)) {
      if ($fb_friends = fboauth_graph_query('me/friends', $access_token)) {
        dosomething_login_facebook_friend_process($fb_friends->data, $account->uid);
      }
      drupal_set_message(t("You've connected your account with Facebook."));
    }
  }
  else {
    // If the user is already logged in, associate the two accounts.
    if ($user->uid) {
      fboauth_save($user->uid, $fbuser->id);
      if ($fb_friends = fboauth_graph_query('me/friends', $access_token)) {
        dosomething_login_facebook_friend_process($fb_friends->data, $user->uid);
      }
      drupal_set_message(t("You've connected your account with Facebook."));
    }
    // Redirect to our user_reg page.
    else {
      // The fboauth module requires a redirect.
      $_SESSION['fbuser'] = $fbuser;
      return 'user/fb/registration';
    }
  }
}

/**
 * Registration page through Facebook. Prepopulates info and connects user
 * to Facebook account.
 */
function dosomething_login_register_facebook($form, &$form_state) {
  $form = drupal_retrieve_form('dosomething_login_register_popup_form', $form_state);
  $form['#action'] = '/user/fb/registration?destination=front';
  if (isset($_SESSION['fbuser'])) {
    $fbuser = $_SESSION['fbuser'];
    $form['picture'] = 'https://graph.facebook.com/' . $fbuser->uid . '/picture?type=large';
    $form['cell_or_email']['#value'] = $fbuser->email;
    $form['name']['first_name']['#value'] = $fbuser->first_name;
    $form['name']['last_name']['#value'] = $fbuser->last_name;
    $birthday = $fbuser->birthday;
    $date = explode('/', $birthday);
    $form['birthday']['month']['#value'] = $date[0];
    $form['birthday']['day']['#value'] = $date[1];
    $form['birthday']['year']['#value'] = $date[2];
  }
  else {
    drupal_set_message("There was a problem receiving your information from Facebook, please register below to create an account.");
  }
  return $form;
}

/**
 * Save Facebook friends if they have profiles in the system.
 * TODO: 2) delete when user deleted.
 */
function dosomething_login_facebook_friend_process($facebook_friends = array(), $uid) {
  // Remove old entries. 
  db_delete('facebook_friends')
    ->condition('uid', $uid)
    ->execute();

  // Get currently users currently registered through Facebook.
  $local_results = db_select('fboauth_users');
    ->fields('fboauth_users', array('fbid', 'uid'));
    ->execute();
  while ($local_result = $local_results->fetchObject()) {
    $fb_user[$local_result->fbid] = $local_result->uid;
  }
  $query = db_insert('facebook_friends')->fields(array('uid', 'fbid'));
  foreach($facebook_friends as $friend) {
    // If user's friend has registered, save.
    if (isset($fb_user[$friend->id])) {
      $query->values(array('uid' => $uid, 'fbid' => $friend->id));
    }
  }
  $query->execute();
}
