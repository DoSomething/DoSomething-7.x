<?php

/**
 * @file
 * Custom functionality to change roles of users depending on their activity.
 */

/**
 * Implements hook_cron().
 */
function dosomething_roles_cron() {
  // Update users roles who have not been assigned to the new roles.
  // Note: this can be removed once all users have roles.
  $inactive_user = user_role_load_by_name('inactive user');
  $member = user_role_load_by_name('member');
  $active_member = user_role_load_by_name('active member');
  $rids = $inactive_user->rid . ', ' . $member->rid . ', ' . $active_member->rid;
  $result = db_query_range("SELECT u.uid, u.access FROM {users} u LEFT JOIN {users_roles} ur ON (ur.uid = u.uid AND ur.rid IN ($rids)) WHERE ur.uid IS NULL AND u.uid > 0 ORDER BY u.access ASC", 0, 100);
  foreach ($result as $data) {
    dosomething_roles_update_role($data->uid);
  }

  // Get users who have not logged in this past year for possible role regression.
  // TODO: Get users who have not done any action updates in 1 year, 9 months, 10 months, 11 months
  // After 1 year, we bump them down
  // We warn them at the other points.
  $last_update_inactive = variable_get('dosomething_roles_cron_inactive', 0);
  $result = db_query_range("SELECT u.uid, u.access FROM {users} u INNER JOIN {users_roles} ur ON (u.uid = ur.uid AND ur.rid IN (:active_member, :member)) WHERE access < UNIX_TIMESTAMP(DATE_SUB(CURRENT_TIMESTAMP(),interval 1 year)) AND access > :last_update_inactive ORDER BY u.access ASC", 0, 100, array(':active_member' => $active_member->rid, ':member' => $member->rid, ':last_update_inactive' => $last_update_inactive));
  foreach ($result as $data) {
     dosomething_roles_update_role($data->uid);
     variable_set('dosomething_roles_cron_inactive', $data->access);
  }
}

function dosomething_roles_update_role($uid) {
  // TODO: New update criteria
  // member - continue to be under 26 (converted to varsity afterwards) - if they haven't logged in in a year, make them inactive.
  // active member - one action update to maintain status
  // varsity - 5 action updates or (win grant and submit grant update) to maintain status
  if (!$uid) {
    return;
  }
  $inactive_user = user_role_load_by_name('inactive user');
  $member = user_role_load_by_name('member');
  $active_member = user_role_load_by_name('active member');
  $rids = $inactive_user->rid . ', ' . $member->rid . ', ' . $active_member->rid;
  $old_rids = db_query("SELECT rid FROM {users_roles} WHERE uid = :uid AND rid IN (" . $rids . ")", array(':uid' => $uid))->fetchCol();
  if (!count($old_rids)) {
    if (dosomething_roles_is_active_member($uid)) {
      $new_rid = $active_member->rid;
    }
    else if (dosomething_roles_is_member($uid)) {
      $new_rid = $member->rid;
    }
    else {
      $new_rid = $inactive_user->rid;
    }
  }
  else {
    foreach ($old_rids as $rid) {
      if ($rid == $inactive_user->rid) {
        // The user is currently inactive. Check if anything has changed.
        if (dosomething_roles_is_active_member($uid)) {
          $new_rid = $active_member->rid;
        }
        else if (dosomething_roles_is_member($uid)) {
          $new_rid = $member->rid;
        }
      } 
      else if ($rid == $member->rid) {
        // The user is currently a member. Check if anything has changed.
        if (dosomething_roles_is_active_member($uid)) {
          $new_rid = $active_member->rid;
        }
        else if (!dosomething_roles_is_member($uid)) {
          $new_rid = $inactive_user->rid;
        }
      }
      else if ($rid == $active_member->rid) {
        // The user is currently an active member. Check if anything has changed.
        if (!dosomething_roles_is_active_member($uid)) {
          if (dosomething_roles_is_member($uid)) {
            $new_rid = $member->rid;
          }
          else {
            $new_rid = $inactive_user->rid;
          }
        } 
      }
    }
  }
  if (isset($new_rid)) {
    if (count($old_rids)) {
      db_query("DELETE FROM {users_roles} WHERE rid IN (" . $rids . ") AND uid = :uid", array(':uid' => $uid)); 
    }
    db_insert('users_roles')->fields(array('uid' => $uid, 'rid' => $new_rid ))->execute();
  }
}
/**
 * Determine if a given uid qualifies for the active member role.
 */
function dosomething_roles_is_active_member($uid) {
  if (db_query("SELECT u.uid FROM {users} u INNER JOIN {node} n ON n.uid = u.uid where u.uid = :uid AND u.login > UNIX_TIMESTAMP(DATE_SUB(CURRENT_TIMESTAMP(),interval 1 year)) AND u.mail NOT IN ('', '0')", array(':uid' => $uid))->fetchField()) {
    return TRUE;
  }
  if (db_query("SELECT u.uid FROM {users} u INNER JOIN {webform_submissions} w ON w.uid = u.uid where u.uid = :uid AND u.login > UNIX_TIMESTAMP(DATE_SUB(CURRENT_TIMESTAMP(),interval 1 year)) AND u.mail NOT IN ('', '0')", array(':uid' => $uid))->fetchField()) {
    return TRUE;
  }
  return FALSE;
}

/**
 * Determine if a given uid qualifies for the member role.
 */
function dosomething_roles_is_member($uid) {
  // TODO: should submitting a webform count for member?
  if (db_query("SELECT u.uid from {users} u WHERE u.login > UNIX_TIMESTAMP(DATE_SUB(CURRENT_TIMESTAMP(),interval 1 year)) AND u.mail NOT IN ('', '0') AND u.uid = :uid", array(':uid' => $uid))) {
    return TRUE;
  }
  if (db_query("SELECT u.uid from {users} u INNER JOIN {node} n ON n.uid = u.uid WHERE u.mail NOT IN ('', '0') AND u.uid = :uid", array(':uid' => $uid))) {
    return TRUE;
  }
  if (db_query("SELECT u.uid from {users} u INNER JOIN {webform_submissions} w ON w.uid = u.uid WHERE u.mail NOT IN ('', '0') AND u.uid = :uid", array(':uid' => $uid))) {
    return TRUE;
  }
  return FALSE;
}

/**
 * Get a list of node types that are considered 'action updates'.
 */
function dosomething_roles_get_action_update_types() {
  return array(
    'campaign_report_back',
    'campaign_sign_up',
    'grant_application',
    'scholarship_application',
    'action_guide',
    'project_report',
  );
}

/**
 * Implements hook_node_insert().
 */
function dosomething_roles_node_insert($node) {
  global $user;
  if ($user->uid == $node->uid) {
    // TODO: Only update if this is a grant update.
    dosomething_roles_update_role($node->uid);
  }
}

/**
 * Implements hook_user_login().
 */
function dosomething_roles_user_login(&$edit, $account) {
  dosomething_roles_update_role($account->uid);
}

/**
 * Implements hook_user_update().
 */
function dosomething_roles_user_update(&$edit, $account, $category) {
  global $user;
  if ($user->uid == $account->uid) {
    dosomething_roles_update_role($account->uid);
  }
}

/**
 * Implements hook_webform_submission_insert().
 */
function dosomething_roles_webform_submission_insert($node, $submission) {
  global $user;
  if ($user->uid == $submission->uid) {
    if (in_array($node->type, dosomething_roles_get_action_update_types())) {
      dosomething_roles_update_role($submission->uid);
    }
  }
}
